<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BlackSea ‚Äî Growth Visual Atlas (Buyer + Creator) v1</title>
<style>
  :root{
    --bg0:#070912;
    --bg1:#0b1022;
    --panel: rgba(255,255,255,.06);
    --panel2: rgba(255,255,255,.08);
    --stroke: rgba(255,255,255,.10);
    --stroke2: rgba(255,255,255,.16);
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.66);
    --muted2: rgba(255,255,255,.52);
    --good: rgba(120, 255, 190, .95);
    --warn: rgba(255, 220, 120, .95);
    --bad: rgba(255, 120, 140, .95);
    --accent: rgba(130, 185, 255, .95);
    --purple: rgba(190, 140, 255, .95);
    --teal: rgba(100, 240, 220, .95);
    --shadow: 0 18px 60px rgba(0,0,0,.45);
    --r14: 14px;
    --r18: 18px;
    --r22: 22px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--sans);
    background:
      radial-gradient(1100px 700px at 20% 10%, rgba(120,160,255,.18), transparent 60%),
      radial-gradient(900px 700px at 85% 15%, rgba(120,255,210,.10), transparent 55%),
      radial-gradient(900px 700px at 55% 85%, rgba(200,130,255,.10), transparent 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    color:var(--text);
    overflow-x:hidden;
  }
  a{color:inherit}
  .wrap{max-width:1220px;margin:0 auto;padding:18px 16px 120px}
  .topPlate{
    position:sticky; top:0; z-index:50;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    background: linear-gradient(180deg, rgba(10,12,20,.78), rgba(10,12,20,.58));
    border:1px solid var(--stroke);
    border-radius: 20px;
    box-shadow: var(--shadow);
    padding: 12px 12px 10px;
    margin: 12px 0 18px;
  }
  .topRow{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding: 4px 6px 10px;
  }
  .brand{
    display:flex; align-items:center; gap:10px; min-width: 260px;
  }
  .dot{
    width:10px;height:10px;border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.15));
    border: 1px solid var(--stroke2);
    box-shadow: 0 0 0 4px rgba(130,185,255,.08);
  }
  .title{
    display:flex;flex-direction:column;line-height:1.15;
  }
  .title b{font-size:15px; letter-spacing:.2px}
  .title span{font-size:12px;color:var(--muted)}
  .metaChips{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px;
    border-radius: 999px;
    border:1px solid var(--stroke);
    background: rgba(255,255,255,.05);
    font-size:12px;
    color: var(--muted);
    white-space:nowrap;
  }
  .chip b{color:var(--text); font-weight:700}
  .liveDot{
    width:8px;height:8px;border-radius:50%;
    background: rgba(255,255,255,.22);
    box-shadow: 0 0 0 0 rgba(120,255,190,.0);
  }
  .liveDot.on{
    background: var(--good);
    box-shadow: 0 0 0 6px rgba(120,255,190,.10), 0 0 22px rgba(120,255,190,.18);
  }
  .subnav{
    display:flex; flex-wrap:wrap; gap:8px;
    padding: 6px 6px 6px;
    border-top:1px solid rgba(255,255,255,.08);
    border-bottom:1px solid rgba(255,255,255,.08);
    margin: 6px 4px 10px;
  }
  .tab{
    appearance:none; border:1px solid var(--stroke);
    background: rgba(255,255,255,.045);
    color: var(--muted);
    border-radius: 999px;
    padding: 8px 10px;
    font-size:12px;
    cursor:pointer;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
  }
  .tab:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22)}
  .tab.active{color:var(--text); background: rgba(130,185,255,.10); border-color: rgba(130,185,255,.35)}
  .cmdRow{
    display:flex; flex-wrap:wrap; gap:10px;
    padding: 4px 6px 6px;
    align-items:center;
    justify-content:space-between;
  }
  .cmdGroup{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .seg{
    display:inline-flex; border:1px solid var(--stroke);
    border-radius: 999px;
    overflow:hidden;
    background: rgba(255,255,255,.04);
  }
  .seg button{
    appearance:none; border:0; background: transparent;
    padding: 9px 11px; font-size:12px; color: var(--muted);
    cursor:pointer;
  }
  .seg button.active{color:var(--text); background: rgba(255,255,255,.06)}
  .btn{
    appearance:none; border:1px solid var(--stroke);
    background: rgba(255,255,255,.05);
    color: var(--text);
    border-radius: 12px;
    padding: 9px 12px;
    font-size:12px;
    cursor:pointer;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
    display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22)}
  .btn.ghost{background: rgba(255,255,255,.03); color: var(--muted)}
  .btn.primary{background: rgba(130,185,255,.10); border-color: rgba(130,185,255,.30)}
  .btn.bad{background: rgba(255,120,140,.10); border-color: rgba(255,120,140,.28)}
  .btn.good{background: rgba(120,255,190,.10); border-color: rgba(120,255,190,.26)}
  .toggle{
    display:inline-flex; align-items:center; gap:8px;
    padding: 8px 10px;
    border-radius: 999px;
    border:1px solid var(--stroke);
    background: rgba(255,255,255,.04);
    font-size:12px;
    color: var(--muted);
  }
  .toggle input{accent-color: rgba(130,185,255,.95)}
  .sel{
    border:1px solid var(--stroke);
    background: rgba(255,255,255,.04);
    color: var(--text);
    border-radius: 12px;
    padding: 9px 10px;
    font-size:12px;
    outline:none;
  }
  .grid{
    display:grid;
    grid-template-columns: 1.35fr .95fr;
    gap: 14px;
    align-items:start;
  }
  @media (max-width: 1100px){
    .grid{grid-template-columns: 1fr}
    .brand{min-width:unset}
    .cmdRow{gap:10px}
  }
  section{scroll-margin-top: 140px}
  .panel{
    border:1px solid var(--stroke);
    background: var(--panel);
    border-radius: var(--r22);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .panelHeader{
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    padding: 14px 14px 12px;
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .panelHeader .h{
    display:flex; flex-direction:column; gap:3px;
  }
  .panelHeader .h b{font-size:14px}
  .panelHeader .h span{font-size:12px;color:var(--muted)}
  .panelBody{padding: 12px 12px 14px}
  .kpiRow{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-top: 10px;
  }
  @media (max-width: 900px){
    .kpiRow{grid-template-columns: repeat(2,1fr)}
  }
  .kpi{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.16);
    border-radius: 16px;
    padding: 10px 10px 8px;
    position:relative;
    overflow:hidden;
  }
  .kpi .t{font-size:11px;color:var(--muted)}
  .kpi .v{font-size:18px;font-weight:800;margin-top:2px;letter-spacing:.2px}
  .kpi .s{font-size:11px;color:var(--muted2);margin-top:2px}
  .spark{
    width:100%;height:26px;margin-top:6px;
    border-radius: 10px;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.07);
  }
  .mapWrap{
    position:relative;
    border-radius: 18px;
    padding: 10px;
    background: rgba(0,0,0,.14);
    border:1px dashed rgba(255,255,255,.10);
  }
  .mapGrid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    position:relative;
    z-index:2;
  }
  @media (max-width: 900px){
    .mapGrid{grid-template-columns: repeat(2, 1fr)}
  }
  .node{
    border:1px solid rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border-radius: 16px;
    padding: 10px 10px 9px;
    cursor:pointer;
    position:relative;
    min-height: 88px;
    transition: transform .10s ease, border-color .15s ease, background .15s ease;
  }
  .node:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22)}
  .node.sel{
    border-color: rgba(130,185,255,.55);
    box-shadow: 0 0 0 4px rgba(130,185,255,.10);
  }
  .nodeTop{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .nodeTop b{font-size:13px}
  .pill{
    font-size:11px; padding: 4px 8px;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    color: var(--muted);
    white-space:nowrap;
  }
  .nodeMeta{
    display:flex; flex-wrap:wrap; gap:6px;
    margin-top: 8px;
  }
  .tag{
    font-size:11px;
    padding: 4px 7px;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.14);
    color: var(--muted);
  }
  .tag.good{border-color: rgba(120,255,190,.25); color: rgba(120,255,190,.9)}
  .tag.warn{border-color: rgba(255,220,120,.26); color: rgba(255,220,120,.95)}
  .tag.bad{border-color: rgba(255,120,140,.28); color: rgba(255,120,140,.95)}
  .tag.a{border-color: rgba(130,185,255,.28); color: rgba(130,185,255,.92)}
  .tag.p{border-color: rgba(190,140,255,.28); color: rgba(190,140,255,.92)}
  .mapSVG{
    position:absolute; inset: 0;
    width:100%; height:100%;
    z-index:1;
    pointer-events:none;
  }
  .insTabs{display:flex; gap:8px; flex-wrap:wrap}
  .insTabs .tab{padding:7px 10px}
  .twoCol{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 900px){
    .twoCol{grid-template-columns: 1fr}
  }
  .box{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.14);
    border-radius: 16px;
    padding: 10px 10px 8px;
  }
  .box b{font-size:12px}
  .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
  .li{
    font-family: var(--mono);
    font-size: 11px;
    color: rgba(255,255,255,.74);
    padding: 6px 8px;
    border-radius: 12px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
  }
  .li.active{
    border-color: rgba(130,185,255,.45);
    background: rgba(130,185,255,.08);
    color: rgba(255,255,255,.92);
  }
  .sliders{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 900px){
    .sliders{grid-template-columns: 1fr}
  }
  .slider{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.14);
    border-radius: 16px;
    padding: 10px 10px 8px;
  }
  .slider .row{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .slider .row b{font-size:12px}
  .slider .row span{font-size:12px; color: var(--muted)}
  .slider input{width:100%}
  .smallNote{font-size:12px;color:var(--muted);line-height:1.4}
  .log{
    font-family: var(--mono);
    font-size: 11px;
    line-height: 1.35;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    border-radius: 16px;
    padding: 10px;
    height: 210px;
    overflow:auto;
    white-space: pre-wrap;
  }
  .heat{
    display:grid;
    grid-template-columns: 120px repeat(6, 1fr);
    gap: 6px;
  }
  .heat .hcell{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.14);
    border-radius: 12px;
    padding: 7px 8px;
    font-size: 11px;
    color: var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .heat .cell{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.14);
    border-radius: 12px;
    padding: 7px 8px;
    font-family: var(--mono);
    font-size: 11px;
    display:flex; align-items:center; justify-content:space-between;
    gap:6px;
  }
  .badge{
    font-size: 10px;
    padding: 3px 6px;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.10);
    color: rgba(255,255,255,.76);
  }
  .badge.good{border-color: rgba(120,255,190,.28); color: rgba(120,255,190,.95)}
  .badge.warn{border-color: rgba(255,220,120,.28); color: rgba(255,220,120,.95)}
  .badge.bad{border-color: rgba(255,120,140,.28); color: rgba(255,120,140,.95)}
  .branch{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.14);
    border-radius: 16px;
    padding: 10px;
  }
  .lanes{
    display:grid;
    grid-template-columns: 90px 1fr;
    gap: 10px;
    align-items:center;
    margin-top: 10px;
  }
  .laneLabel{color: var(--muted); font-size: 12px}
  .lane{
    position:relative;
    height: 34px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    overflow:hidden;
  }
  .dotStep{
    position:absolute; top: 50%;
    transform: translate(-50%, -50%);
    width: 10px; height: 10px; border-radius: 50%;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(130,185,255,.65);
    box-shadow: 0 0 0 0 rgba(130,185,255,.0);
  }
  .dotStep.err{background: rgba(255,120,140,.8); border-color: rgba(255,120,140,.35)}
  .dotStep.micro{width:8px;height:8px;background: rgba(120,255,190,.75); border-color: rgba(120,255,190,.25)}
  .vline{
    position:absolute; top:0; bottom:0; width:1px;
    background: rgba(255,255,255,.14);
    opacity:.55;
  }
  .footerNote{
    margin-top: 14px;
    font-size: 12px;
    color: var(--muted);
    line-height: 1.5;
  }
  .toast{
    position: fixed; right: 16px; bottom: 16px;
    min-width: 260px;
    max-width: 420px;
    padding: 12px 12px;
    border-radius: 16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(12,14,24,.82);
    backdrop-filter: blur(12px);
    box-shadow: var(--shadow);
    transform: translateY(12px);
    opacity:0;
    pointer-events:none;
    transition: opacity .18s ease, transform .18s ease;
    z-index: 100;
  }
  .toast.show{opacity:1; transform: translateY(0)}
  .toast b{font-size:12px}
  .toast div{font-size:12px;color:var(--muted);margin-top:3px}
  @media print{
    body{background:#fff;color:#000}
    .topPlate{position:relative; box-shadow:none; background:#fff; color:#000; border-color:#ddd}
    .panel{box-shadow:none; border-color:#ddd}
    .btn,.tab,.toggle,.sel,.chip{border-color:#ddd; color:#000}
    .node,.box,.kpi,.log,.slider,.branch,.heat .cell,.heat .hcell{border-color:#ddd}
    .mapSVG{display:none}
    .toast{display:none}
  }
</style>
</head>
<body>
<div class="wrap">

  <div class="topPlate" id="topPlate">
    <div class="topRow">
      <div class="brand">
        <div class="dot"></div>
        <div class="title">
          <b>BlackSea ‚Äî Growth Visual Atlas</b>
          <span>–∑–∞–ª—É—á–µ–Ω–Ω—è ‚Ä¢ –≤—ñ—Ä–∞–ª—å–Ω—ñ—Å—Ç—å ‚Ä¢ –¥–æ–≤—ñ—Ä–∞ ‚Ä¢ marketplace loops ‚Ä¢ v1 (Buyer + Creator)</span>
        </div>
      </div>

      <div class="metaChips">
        <div class="chip" title="–ü–æ—Ç–æ—á–Ω–∏–π –≤—É–∑–æ–ª (–∫–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—ñ –∑–º—ñ–Ω—é—î)">
          –í—É–∑–æ–ª: <b id="chipNode">Storefront</b>
        </div>
        <div class="chip" title="–§–æ–∫—É—Å —Å–∏–º—É–ª—è—Ü—ñ—ó">
          –§–æ–∫—É—Å: <b id="chipFocus">–û–±–∏–¥–≤–∞</b>
        </div>
        <div class="chip" title="–°—Ç–∞—Ç—É—Å —Å–∏–º—É–ª—è—Ü—ñ—ó">
          <span class="liveDot" id="liveDot"></span>
          Sim: <b id="chipSim">Idle</b>
        </div>
      </div>
    </div>

    <div class="subnav" role="tablist" aria-label="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è">
      <button class="tab active" data-jump="#core" id="tabCore">Core Map</button>
      <button class="tab" data-jump="#inspector" id="tabInspector">–Ü–Ω—Å–ø–µ–∫—Ç–æ—Ä</button>
      <button class="tab" data-jump="#simulator" id="tabSim">–°–∏–º—É–ª—è—Ç–æ—Ä</button>
      <button class="tab" data-jump="#atlas" id="tabAtlas">Atlas / Microflow</button>
      <button class="tab" data-jump="#heat" id="tabHeat">Heatmap</button>
      <button class="tab" data-jump="#log" id="tabLog">Log / Export</button>
    </div>

    <div class="cmdRow">
      <div class="cmdGroup">
        <div class="seg" title="–†–µ–∂–∏–º —Ñ–æ–∫—É—Å—É (Buyer / Creator / –û–±–∏–¥–≤–∞)">
          <button id="focusBuyer">–ü–æ–∫—É–ø—Ü—ñ</button>
          <button id="focusBoth" class="active">–û–±–∏–¥–≤–∞</button>
          <button id="focusCreator">–ö—Ä–µ–∞—Ç–æ—Ä–∏</button>
        </div>

        <select class="sel" id="scenario" title="–°—Ü–µ–Ω–∞—Ä—ñ–π —Å–∏–º—É–ª—è—Ü—ñ—ó" style="min-width:220px">
          <option value="launch">Launch Week (–Ω–∏–∑—å–∫–∞ –¥–æ–≤—ñ—Ä–∞)</option>
          <option value="viral">Viral Campaign (—Ä–µ—Ñ–µ—Ä–∞–ª/UGC)</option>
          <option value="supply">Supply Boost (—Ö–≤–∏–ª—è –∫—Ä–µ–∞—Ç–æ—Ä—ñ–≤)</option>
          <option value="trust">Trust Crisis (—Ñ—Ä–æ–¥/–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è)</option>
        </select>

        <label class="toggle" title="–õ–æ–≥—É–≤–∞—Ç–∏ –ø–æ–¥—ñ—ó">
          <input type="checkbox" id="togEvents" checked> Events
        </label>
        <label class="toggle" title="–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ micro-–∫—Ä–æ–∫–∏">
          <input type="checkbox" id="togMicro" checked> Micro
        </label>
        <label class="toggle" title="–í–º–∏–∫–∞—Ç–∏ —ñ–Ω–∂–µ–∫—Ü—ñ—é –∑–±–æ—ó–≤">
          <input type="checkbox" id="togFailure"> Failure
        </label>
        <label class="toggle" title="–ö–∞—Å–∫–∞–¥–Ω–∏–π 'boss fail' (–ª–∞–Ω—Ü—é–≥ –ø—Ä–æ–±–ª–µ–º)">
          <input type="checkbox" id="togBoss"> Boss
        </label>
      </div>

      <div class="cmdGroup">
        <button class="btn good" id="btnPlay">‚ñ∂ Play</button>
        <button class="btn ghost" id="btnPause">‚è∏ Pause</button>
        <button class="btn ghost" id="btnStep">‚è≠ Step</button>
        <button class="btn bad" id="btnFailNow" title="–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–±—ñ–π –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑">‚ö† Fail now</button>

        <label class="toggle" title="–ê–≤—Ç–æ-–≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —ñ–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ –Ω–∞ –∫—Ä–æ—Ü—ñ">
          <input type="checkbox" id="togAuto"> Auto-inspect
        </label>

        <input class="sel" id="seed" value="42" style="width:86px" title="Seed –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω–æ—Å—Ç—ñ"/>
        <select class="sel" id="speed" style="width:120px" title="–®–≤–∏–¥–∫—ñ—Å—Ç—å —Ç—ñ–∫—É">
          <option value="900">–ø–æ–≤—ñ–ª—å–Ω–æ</option>
          <option value="520" selected>–Ω–æ—Ä–º–∞–ª—å–Ω–æ</option>
          <option value="250">—à–≤–∏–¥–∫–æ</option>
        </select>
        <button class="btn primary" id="btnLocate" title="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–∏ –¥–æ Core Map + –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç–∏ –≤—É–∑–æ–ª">‚óé Locate</button>
      </div>
    </div>
  </div>

  <div class="grid">

    <section class="panel" id="core">
      <div class="panelHeader">
        <div class="h">
          <b>Core Growth Map</b>
          <span>–∫–ª—ñ–∫ –ø–æ –≤—É–∑–ª–∞—Ö ‚Ä¢ –∑–≤‚Äô—è–∑–∫–∏ –ø–æ–∫–∞–∑—É—é—Ç—å –ø–µ—Ç–ª—ñ —Ä–æ—Å—Ç—É: Buyer / Creator / Trust / Viral</span>
        </div>
        <div class="chips">
          <span class="tag a">Buyer Loop</span>
          <span class="tag p">Creator Loop</span>
          <span class="tag good">Trust</span>
          <span class="tag warn">Friction</span>
          <span class="tag bad">Risk</span>
        </div>
      </div>
      <div class="panelBody">
        <div class="mapWrap" id="mapWrap">
          <svg class="mapSVG" id="mapSVG"></svg>
          <div class="mapGrid" id="mapGrid"></div>
        </div>

        <div class="kpiRow" style="margin-top:12px">
          <div class="kpi">
            <div class="t">Activation</div>
            <div class="v" id="kpiActivation">0.00</div>
            <div class="s">–≤—ñ–¥ –≤—ñ–∑–∏—Ç—É –¥–æ –ø–µ—Ä—à–æ—ó –¥—ñ—ó</div>
            <canvas class="spark" id="spActivation"></canvas>
          </div>
          <div class="kpi">
            <div class="t">Conversion</div>
            <div class="v" id="kpiConv">0.00%</div>
            <div class="s">view ‚Üí purchase</div>
            <canvas class="spark" id="spConv"></canvas>
          </div>
          <div class="kpi">
            <div class="t">Repeat / Retention</div>
            <div class="v" id="kpiRet">0.00%</div>
            <div class="s">–ø–æ–≤—Ç–æ—Ä–Ω—ñ –ø–æ–∫—É–ø–∫–∏</div>
            <canvas class="spark" id="spRet"></canvas>
          </div>
          <div class="kpi">
            <div class="t">Viral K</div>
            <div class="v" id="kpiK">0.00</div>
            <div class="s">–Ω–æ–≤—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ/–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á</div>
            <canvas class="spark" id="spK"></canvas>
          </div>
        </div>

        <div class="footerNote">
          –ü–æ—Ä–∞–¥–∞: —Å—Ü–µ–Ω–∞—Ä—ñ–π <b>Launch Week</b> –ø—ñ–¥–∫—Ä–µ—Å–ª—é—î –¥–æ–≤—ñ—Ä—É —Ç–∞ friction; <b>Viral Campaign</b> ‚Äî share/affiliate; <b>Supply Boost</b> ‚Äî Creator tooling + –º–æ–¥–µ—Ä–∞—Ü—ñ—é; <b>Trust Crisis</b> ‚Äî –∞–Ω—Ç–∏—Ñ—Ä–æ–¥ —Ç–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è.
        </div>
      </div>
    </section>

    <section class="panel" id="inspector">
      <div class="panelHeader">
        <div class="h">
          <b>–Ü–Ω—Å–ø–µ–∫—Ç–æ—Ä –≤—É–∑–ª–∞</b>
          <span>—Ü—ñ–ª—å ‚Ä¢ –º–µ—Ç—Ä–∏–∫–∏ ‚Ä¢ –ø–æ–¥—ñ—ó ‚Ä¢ –≤–∞–∂–µ–ª—ñ ‚Ä¢ —Ä–∏–∑–∏–∫–∏ ‚Ä¢ A/B —ñ–¥–µ—ó ‚Ä¢ microflow</span>
        </div>
        <div class="insTabs">
          <button class="tab active" data-ins="overview">–û–≥–ª—è–¥</button>
          <button class="tab" data-ins="events">Events</button>
          <button class="tab" data-ins="levers">–í–∞–∂–µ–ª—ñ</button>
          <button class="tab" data-ins="micro">Microflow</button>
        </div>
      </div>
      <div class="panelBody" id="insBody"></div>
    </section>

    <section class="panel" id="simulator">
      <div class="panelHeader">
        <div class="h">
          <b>–°–∏–º—É–ª—è—Ç–æ—Ä —Ä–æ—Å—Ç—É</b>
          <span>—Å—Ü–µ–Ω–∞—Ä—ñ—ó ‚Ä¢ knobs ‚Ä¢ branch map ‚Ä¢ daily loop ‚Ä¢ fail drill (boss)</span>
        </div>
        <div class="chips">
          <span class="tag a">Buyer</span>
          <span class="tag p">Creator</span>
          <span class="tag good">Social proof</span>
          <span class="tag warn">Checkout</span>
          <span class="tag bad">Fraud</span>
        </div>
      </div>
      <div class="panelBody">

        <div class="sliders">
          <div class="slider">
            <div class="row"><b>Friction</b><span id="vFriction">35</span></div>
            <input type="range" min="0" max="100" value="35" id="friction"/>
            <div class="smallNote">–ë—ñ–ª—å—à–µ friction ‚Üí –Ω–∏–∂—á–∞ –∫–æ–Ω–≤–µ—Ä—Å—ñ—è/–∞–∫—Ç–∏–≤–∞—Ü—ñ—è, –±—ñ–ª—å—à–µ –≤—ñ–¥—Å—ñ–≤—É –Ω–∞ checkout —Ç–∞ onboarding.</div>
          </div>
          <div class="slider">
            <div class="row"><b>Trust</b><span id="vTrust">45</span></div>
            <input type="range" min="0" max="100" value="45" id="trust"/>
            <div class="smallNote">–î–æ–≤—ñ—Ä–∞ ‚Üë ‚Üí –∫–æ–Ω–≤–µ—Ä—Å—ñ—è ‚Üë, –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è ‚Üì, –≤—ñ–¥–≥—É–∫–∏ ‚Üë, K ‚Üë (—á–µ—Ä–µ–∑ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥—É–≤–∞—Ç–∏).</div>
          </div>
          <div class="slider">
            <div class="row"><b>Incentives</b><span id="vIncent">30</span></div>
            <input type="range" min="0" max="100" value="30" id="incent"/>
            <div class="smallNote">–ú–æ—Ç–∏–≤–∞—Ç–æ—Ä–∏ (—Ä–µ—Ñ–µ—Ä–∞–ª/–∫–µ—à–±–µ–∫/affiliate) ‚Üí share ‚Üë, K ‚Üë, –∞–ª–µ –º–æ–∂–ª–∏–≤–∏–π —Ñ—Ä–æ–¥.</div>
          </div>
          <div class="slider">
            <div class="row"><b>Distribution</b><span id="vDistrib">40</span></div>
            <input type="range" min="0" max="100" value="40" id="distrib"/>
            <div class="smallNote">–ê–ª–≥–æ—Ä–∏—Ç–º –≤—ñ—Ç—Ä–∏–Ω–∏/–ø—ñ–¥–±—ñ—Ä–∫–∏/SEO ‚Üí discovery ‚Üë, –±—ñ–ª—å—à–µ –≤—Ö–æ–¥—ñ–≤ —É Buyer loop.</div>
          </div>
          <div class="slider">
            <div class="row"><b>Quality filter</b><span id="vQuality">38</span></div>
            <input type="range" min="0" max="100" value="38" id="quality"/>
            <div class="smallNote">–ú–æ–¥–µ—Ä–∞—Ü—ñ—è/–∞–Ω—Ç–∏—Ñ—Ä–æ–¥ ‚Üí fraud ‚Üì, refunds ‚Üì, trust ‚Üë (–∞–ª–µ –º–æ–∂–µ –≥–∞–ª—å–º—É–≤–∞—Ç–∏ supply).</div>
          </div>
          <div class="slider">
            <div class="row"><b>Creator tooling</b><span id="vTooling">44</span></div>
            <input type="range" min="0" max="100" value="44" id="tooling"/>
            <div class="smallNote">–®–∞–±–ª–æ–Ω–∏, –∞–≤—Ç–æ–ø–∞–∫—É–≤–∞–Ω–Ω—è, –º–µ—Ç–∞–¥–∞–Ω—ñ ‚Üí time-to-publish ‚Üì, —è–∫—ñ—Å—Ç—å ‚Üë, refunds ‚Üì.</div>
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px">
          <div class="branch">
            <b>Branch Map (–æ—Å—Ç–∞–Ω–Ω—ñ –∫—Ä–æ–∫–∏)</b>
            <div class="smallNote" style="margin-top:4px">–°–∏–Ω—î ‚Äî core-–∫—Ä–æ–∫–∏, –∑–µ–ª–µ–Ω–∏–π ‚Äî micro, —á–µ—Ä–≤–æ–Ω–µ ‚Äî error; –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ñ –ª—ñ–Ω—ñ—ó ‚Äî –º–µ–∂—ñ —Å–µ—Å—ñ–π.</div>

            <div class="lanes">
              <div class="laneLabel">Buyer</div>
              <div class="lane" id="laneBuyer"></div>
            </div>
            <div class="lanes">
              <div class="laneLabel">Creator</div>
              <div class="lane" id="laneCreator"></div>
            </div>

            <div class="footerNote" style="margin-top:10px">
              –ü–æ—Ä–∞–¥–∞: –ø—ñ–¥–Ω—ñ–º–∏ <b>Trust</b> —Ç–∞ –∑–º–µ–Ω—à <b>Friction</b>, —ñ –ø–æ–¥–∏–≤–∏—Å—å, —è–∫ Branch Map ‚Äú–≤–∏—Ä—ñ–≤–Ω—é—î—Ç—å—Å—è‚Äù (–º–µ–Ω—à–µ –≤—ñ–¥—Å—ñ–≤—É –Ω–∞ checkout) —Ç–∞ —Ä–æ—Å—Ç–µ <b>K</b>.
            </div>
          </div>

          <div class="branch">
            <b>Daily Loop (—Å–µ—Ä—ñ—ó —Å–µ—Å—ñ–π/–¥–Ω—ñ–≤)</b>
            <div class="smallNote" style="margin-top:4px">–ú–æ–¥–µ–ª—å ‚Äú–¥–Ω—ñ–≤‚Äù –∫–æ—Ä–∏—Å–Ω–∞ –¥–ª—è –æ—Ü—ñ–Ω–∫–∏ –¥–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤–æ—ó –¥–∏–Ω–∞–º—ñ–∫–∏: –ø–æ–≤—Ç–æ—Ä–Ω—ñ –ø–æ–∫—É–ø–∫–∏, –≤—Ç–æ–º–∞, –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫—Ä–µ–∞—Ç–æ—Ä—ñ–≤.</div>

            <div class="sliders" style="grid-template-columns:1fr;gap:10px;margin-top:10px">
              <div class="slider">
                <div class="row"><b>Sessions/day</b><span id="vSess">6</span></div>
                <input type="range" min="1" max="20" value="6" id="sess"/>
              </div>
              <div class="slider">
                <div class="row"><b>Retention</b><span id="vDailyRet">62%</span></div>
                <input type="range" min="10" max="95" value="62" id="dailyRet"/>
              </div>
              <div class="slider">
                <div class="row"><b>Fatigue</b><span id="vFat">25%</span></div>
                <input type="range" min="0" max="70" value="25" id="fat"/>
              </div>
              <div class="slider">
                <div class="row"><b>Days</b><span id="vDays">7</span></div>
                <input type="range" min="1" max="30" value="7" id="days"/>
              </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
              <button class="btn" id="btnRunDay">‚òÄ Run day</button>
              <button class="btn primary" id="btnRunDays">üìÖ Run days</button>
              <button class="btn ghost" id="btnResetDay">‚Ü∫ Reset day stats</button>
            </div>

            <div class="log" id="dayReport" style="margin-top:10px;height:150px"></div>
          </div>
        </div>

      </div>
    </section>

    <section class="panel" id="atlas">
      <div class="panelHeader">
        <div class="h">
          <b>Atlas / Microflow</b>
          <span>2-–π —Ä—ñ–≤–µ–Ω—å –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—ó: –º—ñ–∫—Ä–æ–∫—Ä–æ–∫–∏ –ø—Ä–æ—Ü–µ—Å—ñ–≤ + ‚Äú—à–∞—Ä–∏‚Äù —Å–∏—Å—Ç–µ–º–∏ (trust/viral/quality)</span>
        </div>
        <div class="chips">
          <span class="tag a">Buyer journey</span>
          <span class="tag p">Creator journey</span>
          <span class="tag good">Proof</span>
          <span class="tag warn">Funnel</span>
          <span class="tag bad">Abuse</span>
        </div>
      </div>
      <div class="panelBody">
        <div class="twoCol">
          <div class="box">
            <b>Microflow –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –≤—É–∑–ª–∞</b>
            <div class="chips" id="microList" style="margin-top:10px"></div>
          </div>
          <div class="box">
            <b>–®–∞—Ä–∏ —Å–∏—Å—Ç–µ–º–∏ (—Å–≤—ñ—Ç–∏—Ç—å—Å—è –ø–æ –∫—Ä–æ–∫—É)</b>
            <div class="chips" id="layers" style="margin-top:10px"></div>
            <div class="footerNote">–®–∞—Ä–∏: UX ‚Ä¢ Trust ‚Ä¢ Checkout ‚Ä¢ Delivery ‚Ä¢ Viral ‚Ä¢ Quality ‚Ä¢ Analytics ‚Ä¢ Support ‚Ä¢ Governance.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="heat">
      <div class="panelHeader">
        <div class="h">
          <b>Heatmap –∑–∞–ª—É—á–µ–Ω–Ω—è (live)</b>
          <span>–º–∞—Ç—Ä–∏—Ü—è ‚Äú–µ—Ç–∞–ø–∏ √ó —Ä–æ–ª—ñ‚Äù ‚Ä¢ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å –∑–º—ñ–Ω—é—î—Ç—å—Å—è –ø—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó —Ç–∞ –∑–±–æ—è—Ö</span>
        </div>
        <div class="chips">
          <span class="tag a">Engagement</span>
          <span class="tag good">Trust</span>
          <span class="tag warn">Friction</span>
          <span class="tag bad">Fraud</span>
        </div>
      </div>
      <div class="panelBody">
        <div class="heat" id="heatGrid"></div>
        <div class="footerNote">
          –ü–æ—è—Å–Ω–µ–Ω–Ω—è: –∑–Ω–∞—á–µ–Ω–Ω—è 0‚Äì100 ‚Äî –≤—ñ–¥–Ω–æ—Å–Ω–∞ ‚Äú—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞‚Äù –≤–∑–∞—î–º–æ–¥—ñ—ó (—á–∞—Å—Ç–æ—Ç–∞/–≤–∞–∂–ª–∏–≤—ñ—Å—Ç—å). Boss Fail —Ç–∞ Trust Crisis –¥–æ–¥–∞—é—Ç—å ‚Äú—á–µ—Ä–≤–æ–Ω—ñ‚Äù —Ä–∏–∑–∏–∫–∏ —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –∫–ª—ñ—Ç–∏–Ω–∫–∞—Ö.
        </div>
      </div>
    </section>

    <section class="panel" id="log">
      <div class="panelHeader">
        <div class="h">
          <b>Log / Export</b>
          <span>JSON-trace (–≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω—ñ—Å—Ç—å) ‚Ä¢ copy last event ‚Ä¢ export trace</span>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="btnCopyLast">‚éò Copy last event</button>
          <button class="btn primary" id="btnExport">‚¨á Export JSON trace</button>
          <button class="btn ghost" id="btnResetAll">‚Ü∫ Reset</button>
        </div>
      </div>
      <div class="panelBody">
        <div class="log" id="eventLog"></div>
        <div class="footerNote">
          –ï–∫—Å–ø–æ—Ä—Ç –º—ñ—Å—Ç–∏—Ç—å: scenario, knobs, seed, –º–µ—Ç—Ä–∏–∫–∏ —Ç–∞ —Ç—Ä–∞—Å—É –ø–æ–¥—ñ–π. –¶–µ –º–æ–∂–Ω–∞ –ø—Ä–∏–∫—Ä—ñ–ø–ª—é–≤–∞—Ç–∏ –¥–æ growth-–æ–±–≥–æ–≤–æ—Ä–µ–Ω—å –∞–±–æ —è–∫ ‚Äú–¥–æ–∫–∞–∑‚Äù —É –ø–ª–∞–Ω—ñ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ñ–≤.
        </div>
      </div>
    </section>

  </div>
</div>

<div class="toast" id="toast">
  <b id="toastTitle">–ì–æ—Ç–æ–≤–æ</b>
  <div id="toastText">‚Ä¶</div>
</div>

<script>
const $ = (s, el=document) => el.querySelector(s);
const $$ = (s, el=document) => [...el.querySelectorAll(s)];
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function lerp(a,b,t){ return a+(b-a)*t; }
function rnd(seedObj){
  let x = seedObj.x | 0;
  x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
  seedObj.x = x;
  return ((x >>> 0) / 4294967296);
}
function randInt(seedObj, a, b){ return Math.floor(lerp(a, b+1, rnd(seedObj))); }
function choice(seedObj, arr){ return arr[Math.floor(rnd(seedObj)*arr.length)] }
function sigmoid(z){ return 1/(1+Math.exp(-z)); }

const UI = {
  chipNode: $("#chipNode"),
  chipFocus: $("#chipFocus"),
  chipSim: $("#chipSim"),
  liveDot: $("#liveDot"),

  focusBuyer: $("#focusBuyer"),
  focusBoth: $("#focusBoth"),
  focusCreator: $("#focusCreator"),

  scenario: $("#scenario"),
  togEvents: $("#togEvents"),
  togMicro: $("#togMicro"),
  togFailure: $("#togFailure"),
  togBoss: $("#togBoss"),
  togAuto: $("#togAuto"),
  seed: $("#seed"),
  speed: $("#speed"),

  btnPlay: $("#btnPlay"),
  btnPause: $("#btnPause"),
  btnStep: $("#btnStep"),
  btnFailNow: $("#btnFailNow"),
  btnLocate: $("#btnLocate"),

  mapGrid: $("#mapGrid"),
  mapSVG: $("#mapSVG"),
  mapWrap: $("#mapWrap"),

  insTabs: $$(".insTabs .tab"),
  insBody: $("#insBody"),

  friction: $("#friction"), trust: $("#trust"), incent: $("#incent"),
  distrib: $("#distrib"), quality: $("#quality"), tooling: $("#tooling"),
  vFriction: $("#vFriction"), vTrust: $("#vTrust"), vIncent: $("#vIncent"),
  vDistrib: $("#vDistrib"), vQuality: $("#vQuality"), vTooling: $("#vTooling"),

  kpiActivation: $("#kpiActivation"),
  kpiConv: $("#kpiConv"),
  kpiRet: $("#kpiRet"),
  kpiK: $("#kpiK"),
  spActivation: $("#spActivation"),
  spConv: $("#spConv"),
  spRet: $("#spRet"),
  spK: $("#spK"),

  laneBuyer: $("#laneBuyer"),
  laneCreator: $("#laneCreator"),

  sess: $("#sess"), dailyRet: $("#dailyRet"), fat: $("#fat"), days: $("#days"),
  vSess: $("#vSess"), vDailyRet: $("#vDailyRet"), vFat: $("#vFat"), vDays: $("#vDays"),
  btnRunDay: $("#btnRunDay"), btnRunDays: $("#btnRunDays"), btnResetDay: $("#btnResetDay"),
  dayReport: $("#dayReport"),

  microList: $("#microList"),
  layers: $("#layers"),

  heatGrid: $("#heatGrid"),

  eventLog: $("#eventLog"),
  btnCopyLast: $("#btnCopyLast"),
  btnExport: $("#btnExport"),
  btnResetAll: $("#btnResetAll"),

  toast: $("#toast"),
  toastTitle: $("#toastTitle"),
  toastText: $("#toastText"),
};

const STATE = {
  focus: "both",
  running: false,
  tick: 0,
  selectedNode: "Storefront",
  insTab: "overview",
  seed: 42,
  rng: {x: 42},
  scenario: "launch",
  knobs: { friction: 35, trust: 45, incent: 30, distrib: 40, quality: 38, tooling: 44 },
  toggles: { events:true, micro:true, failure:false, boss:false, auto:false },
  buyer: { stage:"Acquisition", session:0, views:0, purchases:0, repeats:0, shares:0, reviews:0, drops:0 },
  creator: { stage:"Creator Onboard", session:0, products:0, publishes:0, sales:0, churn:0, drops:0 },
  metrics: { activation: 0.0, conv: 0.0, ret: 0.0, k: 0.0, fraud: 0.0, refund: 0.0, ttv_ms: 0 },
  series: { activation: [], conv: [], ret: [], k: [] },
  trace: [],
  lastEvent: null,
  branch: { buyer: [], creator: [] },
  bossQueue: [],
  daily: { day:0, sessions:0, purchases:0, publishes:0, errors:0, recoveries:0, ksum:0, ttv:0 }
};

const NODES = [
  { id:"Acquisition", lane:"Buyer", pill:"Traffic", tags:["–¥–∂–µ—Ä–µ–ª–∞","UTM","SEO"], layers:["UX","Analytics"], micro:["source hit","landing view","intent signal"] },
  { id:"Storefront", lane:"Buyer", pill:"Browse", tags:["–≤—ñ—Ç—Ä–∏–Ω–∞","–ø—ñ–¥–±—ñ—Ä–∫–∏"], layers:["UX","Analytics","Distribution"], micro:["feed render","filter/sort","click product"] },
  { id:"Product Page", lane:"Buyer", pill:"Decision", tags:["–æ–ø–∏—Å","preview","FAQ"], layers:["UX","Trust","Analytics"], micro:["view content","social proof","CTA buy"] },
  { id:"Trust Layer", lane:"Trust", pill:"Proof", tags:["–≤—ñ–¥–≥—É–∫–∏","–ø—Ä–æ—Ñ—ñ–ª—å","–≥–∞—Ä–∞–Ω—Ç—ñ—ó"], layers:["Trust","Governance","Quality"], micro:["seller profile","reviews/ratings","policy/guarantee"] },
  { id:"Checkout", lane:"Buyer", pill:"Funnel", tags:["–∫–æ—à–∏–∫","–º–µ—Ç–æ–¥","3DS"], layers:["Checkout","UX"], micro:["summary","payment method","confirm intent"] },
  { id:"Payment", lane:"Buyer", pill:"Txn", tags:["success","fail","risk"], layers:["Checkout","Risk","Governance"], micro:["authorize","3DS/confirm","result capture"] },
  { id:"Delivery", lane:"Buyer", pill:"Value", tags:["download","email","cabinet"], layers:["Delivery","Support"], micro:["trigger access","download link","receipt + tips"] },
  { id:"Post-purchase", lane:"Buyer", pill:"Loop", tags:["review","support","refund"], layers:["Support","Trust","Analytics"], micro:["nudge review","support ticket","refund flow"] },
  { id:"Share / Affiliate", lane:"Viral", pill:"Viral", tags:["share-kit","shortlink","UTM"], layers:["Viral","Analytics"], micro:["generate kit","share click","track purchase"] },

  { id:"Creator Onboard", lane:"Creator", pill:"Supply", tags:["signup","kyc-lite","tax"], layers:["UX","Governance"], micro:["signup","verify","first product intent"] },
  { id:"Creator Studio", lane:"Creator", pill:"Build", tags:["upload","pricing"], layers:["UX","Analytics","Tooling"], micro:["new product","assets upload","pricing draft"] },
  { id:"Packaging", lane:"Creator", pill:"Quality", tags:["metadata","bundle","preview"], layers:["Tooling","Quality"], micro:["meta","preview","bundle"] },
  { id:"Publish / Launch", lane:"Creator", pill:"Go-live", tags:["listing","visibility"], layers:["Distribution","Analytics"], micro:["publish","indexing","first impressions"] },

  { id:"Moderation / Anti-fraud", lane:"Risk", pill:"Shield", tags:["fraud","piracy","reviews"], layers:["Risk","Quality","Governance"], micro:["signal detect","flag/review","action/ban"] },
  { id:"Analytics / Experiments", lane:"Platform", pill:"Lab", tags:["A/B","cohorts","dash"], layers:["Analytics","Governance"], micro:["metric calc","experiment assign","insights"] }
];

const EDGES = [
  ["Acquisition","Storefront","discover","accent"],
  ["Storefront","Product Page","open","accent"],
  ["Product Page","Trust Layer","proof","good"],
  ["Trust Layer","Checkout","cta","warn"],
  ["Checkout","Payment","pay","warn"],
  ["Payment","Delivery","success","good"],
  ["Delivery","Post-purchase","value","good"],
  ["Post-purchase","Share / Affiliate","share","accent"],
  ["Share / Affiliate","Acquisition","referral","accent"],
  ["Creator Onboard","Creator Studio","setup","purple"],
  ["Creator Studio","Packaging","prep","purple"],
  ["Packaging","Publish / Launch","launch","purple"],
  ["Publish / Launch","Storefront","supply","purple"],
  ["Analytics / Experiments","Creator Studio","learn","purple"],
  ["Moderation / Anti-fraud","Trust Layer","clean","good"],
  ["Trust Layer","Moderation / Anti-fraud","report","bad"],
  ["Post-purchase","Analytics / Experiments","telemetry","accent"],
  ["Payment","Moderation / Anti-fraud","risk","bad"],
  ["Analytics / Experiments","Storefront","rank","accent"],
];

const LAYERS = [
  {id:"UX", label:"UX"},
  {id:"Trust", label:"Trust"},
  {id:"Checkout", label:"Checkout"},
  {id:"Delivery", label:"Delivery"},
  {id:"Viral", label:"Viral"},
  {id:"Quality", label:"Quality"},
  {id:"Analytics", label:"Analytics"},
  {id:"Support", label:"Support"},
  {id:"Risk", label:"Risk"},
  {id:"Governance", label:"Governance"},
  {id:"Distribution", label:"Distribution"},
  {id:"Tooling", label:"Tooling"},
];

const HEAT_ROWS = ["Discover","Trust","Checkout","Delivery","Review","Referral"];
const HEAT_COLS = ["–ü–æ–∫—É–ø–µ—Ü—å","–ö—Ä–µ–∞—Ç–æ—Ä","–ü–∞—Ä—Ç–Ω–µ—Ä","–ü—ñ–¥—Ç—Ä–∏–º–∫–∞","–ú–æ–¥–µ—Ä–∞—Ü—ñ—è","–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞"];

function buildMap(){
  UI.mapGrid.innerHTML = "";
  for(const n of NODES){
    const el = document.createElement("div");
    el.className = "node";
    el.dataset.node = n.id;
    el.innerHTML = `
      <div class="nodeTop">
        <b>${n.id}</b>
        <span class="pill">${n.pill}</span>
      </div>
      <div class="nodeMeta">
        ${n.tags.slice(0,3).map(t=>`<span class="tag">${t}</span>`).join("")}
      </div>
    `;
    el.addEventListener("click", ()=>selectNode(n.id, true));
    UI.mapGrid.appendChild(el);
  }
  markSelectedNode();
  requestAnimationFrame(drawEdges);
}
function markSelectedNode(){
  $$(".node").forEach(el=>{
    el.classList.toggle("sel", el.dataset.node === STATE.selectedNode);
  });
}
function bezier(p0,p1,p2,p3,t){
  const u=1-t;
  return u*u*u*p0 + 3*u*u*t*p1 + 3*u*t*t*p2 + t*t*t*p3;
}
function drawEdges(){
  const wrap = UI.mapWrap.getBoundingClientRect();
  const svg = UI.mapSVG;
  svg.setAttribute("viewBox", `0 0 ${wrap.width} ${wrap.height}`);
  svg.innerHTML = "";
  const defs = document.createElementNS("http://www.w3.org/2000/svg","defs");
  defs.innerHTML = `
    <marker id="arrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
      <path d="M0,0 L8,4 L0,8 z" fill="rgba(255,255,255,.35)"></path>
    </marker>
  `;
  svg.appendChild(defs);

  const pos = {};
  $$(".node").forEach(el=>{
    const r = el.getBoundingClientRect();
    const cx = (r.left - wrap.left) + r.width/2;
    const cy = (r.top - wrap.top) + r.height/2;
    pos[el.dataset.node] = {cx,cy};
  });

  for(const [a,b,label,kind] of EDGES){
    if(!pos[a] || !pos[b]) continue;
    const A = pos[a], B = pos[b];
    const dx = B.cx - A.cx, dy = B.cy - A.cy;
    const dist = Math.hypot(dx,dy);
    const bend = clamp(dist/4, 18, 80) * (dx>0 ? 1 : -1);
    const c1x = A.cx + dx*0.33;
    const c1y = A.cy + dy*0.33 - bend*0.15;
    const c2x = A.cx + dx*0.66;
    const c2y = A.cy + dy*0.66 + bend*0.15;

    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    const d = `M ${A.cx} ${A.cy} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${B.cx} ${B.cy}`;
    path.setAttribute("d", d);
    path.setAttribute("fill", "none");
    const stroke = kind==="good" ? "rgba(120,255,190,.32)"
                 : kind==="warn" ? "rgba(255,220,120,.28)"
                 : kind==="bad"  ? "rgba(255,120,140,.26)"
                 : kind==="purple"? "rgba(190,140,255,.26)"
                 : "rgba(130,185,255,.24)";
    path.setAttribute("stroke", stroke);
    path.setAttribute("stroke-width", "2");
    path.setAttribute("marker-end", "url(#arrow)");
    path.setAttribute("opacity", ".95");
    svg.appendChild(path);

    const t = 0.52;
    const mx = bezier(A.cx, c1x, c2x, B.cx, t);
    const my = bezier(A.cy, c1y, c2y, B.cy, t);
    const text = document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("x", mx);
    text.setAttribute("y", my);
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("dominant-baseline","middle");
    text.setAttribute("fill","rgba(255,255,255,.55)");
    text.setAttribute("font-size","11");
    text.setAttribute("font-family", "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace");
    text.textContent = label;
    svg.appendChild(text);
  }
}

function nodeDetails(id){
  const base = {desc:"‚Äî",goals:[],metrics:[],events:[],levers:[],risks:[],checks:[],experiments:[]};
  const commonChecks = ["UTM/–∞—Ç—Ä–∏–±—É—Ü—ñ—è","–∞–Ω—Ç–∏—Ñ—Ä–æ–¥ —Å–∏–≥–Ω–∞–ª–∏","—ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π","–ª–æ–≥ –∞—É–¥–∏—Ç—É","rate limiting"];
  const D = {
    "Storefront": {
      desc:"–í—ñ—Ç—Ä–∏–Ω–∞ –≤–∏–∑–Ω–∞—á–∞—î discovery: –ø—ñ–¥–±—ñ—Ä–∫–∏, –ø–æ—à—É–∫, —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è, –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è. –¶–µ ‚Äú–¥–≤–∏–≥—É–Ω‚Äù –ø–µ—Ä—à–æ–≥–æ –∫–ª—ñ–∫—É.",
      goals:["–ø—ñ–¥–Ω—è—Ç–∏ product views","—Å–∫–æ—Ä–æ—á–µ–Ω–Ω—è —á–∞—Å—É –¥–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É"],
      metrics:["product CTR","time-to-product","scroll depth"],
      events:["view_storefront","apply_filter","search_query","click_product"],
      levers:["–ø—ñ–¥–±—ñ—Ä–∫–∏/collections","—Ä–∞–Ω–∂—É–≤–∞–Ω–Ω—è","—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó","—Ç–µ–≥–∏/–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"],
      risks:["–µ—Ñ–µ–∫—Ç –ø–æ—Ä–æ–∂–Ω—å–æ—ó –ø–æ–ª–∏—Ü—ñ","–ø–æ–≥–∞–Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—Å—Ç—å"],
      checks:[...commonChecks,"ranking guardrails"],
      experiments:["A/B: –±–ª–æ–∫ 'Popular this week'","A/B: –∫—Ä–µ–∞—Ç–æ—Ä-–∫–æ–ª–µ–∫—Ü—ñ—ó","A/B: –∞–≤—Ç–æ-—Ç–µ–≥–∏ vs —Ä—É—á–Ω—ñ —Ç–µ–≥–∏"]
    }
  };
  // reuse mapping from earlier (compact): if not found, fallback to heuristics
  if(D[id]) return {...base, ...D[id]};
  // quick heuristic fill
  const n = NODES.find(x=>x.id===id);
  return {
    desc: "–û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏–π –≤—É–∑–æ–ª growth-–∫–∞—Ä—Ç–∏. –î–µ—Ç–∞–ª—ñ –≤ —Ü—å–æ–º—É v1 –º–æ–∂–Ω–∞ —Ä–æ–∑—à–∏—Ä—é–≤–∞—Ç–∏ –ø—ñ–¥ —Ä–µ–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏.",
    goals: ["–∑–º–µ–Ω—à–∏—Ç–∏ –≤—ñ–¥—Å—ñ–≤","–ø—ñ–¥–≤–∏—â–∏—Ç–∏ —è–∫—ñ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—É","–≤–∫–ª—é—á–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É –ø–µ—Ç–ª—é"],
    metrics: ["–∫–æ–Ω–≤–µ—Ä—Å—ñ—è –≤—É–∑–ª–∞","latency","drop-off"],
    events: ["(–¥–∏–≤. Log/Export ‚Üí schema)"],
    levers: ["UX –ø–æ–ª—ñ–ø—à–µ–Ω–Ω—è","—Å–æ—Ü–¥–æ–∫–∞–∑/–¥–æ–≤—ñ—Ä–∞","–ø—ñ–¥–±—ñ—Ä–∫–∏/—Ä–∞–Ω–∂—É–≤–∞–Ω–Ω—è","—à–≤–∏–¥–∫—ñ—Å—Ç—å/—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å"],
    risks: ["—Ñ—Ä–æ–¥/–ø—ñ—Ä–∞—Ç—Å—Ç–≤–æ","–ø–æ–º–∏–ª–∫–∏ –æ–ø–ª–∞—Ç–∏","–Ω–µ–≥–∞—Ç–∏–≤–Ω—ñ –≤—ñ–¥–≥—É–∫–∏"],
    checks: [...commonChecks],
    experiments: ["A/B: —Å–∫–æ—Ä–æ—á–µ–Ω–Ω—è –∫—Ä–æ–∫—ñ–≤","A/B: –ø–æ–∑–∏—Ü—ñ—è trust-–±–ª–æ–∫—É","A/B: share-kit –ø—ñ—Å–ª—è —Ü—ñ–Ω–Ω–æ—Å—Ç—ñ"],
  };
}

function buildInspector(){
  const n = NODES.find(x=>x.id===STATE.selectedNode) || NODES[0];
  UI.chipNode.textContent = n.id;
  const data = nodeDetails(n.id);
  const tab = STATE.insTab;

  const html = `
    <div class="twoCol">
      <div class="box">
        <b>${n.id}</b>
        <div class="smallNote" style="margin-top:6px">${data.desc}</div>
        <div class="chips">
          ${data.goals.map(x=>`<span class="tag a">${x}</span>`).join("")}
        </div>
      </div>
      <div class="box">
        <b>–ö–ª—é—á–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏</b>
        <div class="chips">
          ${data.metrics.map(x=>`<span class="tag">${x}</span>`).join("")}
        </div>
        <div class="chips" style="margin-top:10px">
          ${data.risks.map(x=>`<span class="tag bad">${x}</span>`).join("")}
        </div>
      </div>
    </div>

    ${tab==="overview" ? `
      <div class="twoCol" style="margin-top:10px">
        <div class="box">
          <b>–ü–æ–¥—ñ—ó (events)</b>
          <div class="chips">${(data.events.length?data.events:n.micro).map(x=>`<span class="li">${x}</span>`).join("")}</div>
        </div>
        <div class="box">
          <b>A/B —ñ–¥–µ—ó (—à–≤–∏–¥–∫–∏–π –±–µ–∫–ª–æ–≥)</b>
          <div class="chips">${data.experiments.map(x=>`<span class="li">${x}</span>`).join("")}</div>
        </div>
      </div>
    ` : ""}

    ${tab==="events" ? `
      <div class="box" style="margin-top:10px">
        <b>Event taxonomy (–º—ñ–Ω—ñ–º—É–º)</b>
        <div class="chips" style="margin-top:10px">
          ${["visit_landing","view_product","click_buy","start_checkout","payment_success","payment_fail","download_complete","submit_review","share_link","affiliate_purchase","product_publish","fraud_flag"].map(x=>`<span class="li">${x}</span>`).join("")}
        </div>
      </div>
    ` : ""}

    ${tab==="levers" ? `
      <div class="twoCol" style="margin-top:10px">
        <div class="box">
          <b>–í–∞–∂–µ–ª—ñ (levers)</b>
          <div class="chips">${(data.levers.length?data.levers:["Trust placement","Friction removal","Collections/SEO","Affiliate kit"]).map(x=>`<span class="li">${x}</span>`).join("")}</div>
        </div>
        <div class="box">
          <b>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ / –ø–æ–ª—ñ—Ç–∏–∫–∏</b>
          <div class="chips">${(data.checks.length?data.checks:["audit trail","anti-fraud scoring","idempotency"]).map(x=>`<span class="li">${x}</span>`).join("")}</div>
        </div>
      </div>
    ` : ""}

    ${tab==="micro" ? `
      <div class="box" style="margin-top:10px">
        <b>Microflow (3‚Äì6 –∫—Ä–æ–∫—ñ–≤)</b>
        <div class="chips" style="margin-top:10px">
          ${n.micro.map((x,i)=>`<span class="li ${i===0?'active':''}">${x}</span>`).join("")}
        </div>
      </div>
    ` : ""}
  `;
  UI.insBody.innerHTML = html;
  renderMicroAndLayers(n);
}

function renderMicroAndLayers(n){
  UI.microList.innerHTML = n.micro.map(x=>`<span class="li">${x}</span>`).join("");
  UI.layers.innerHTML = LAYERS.map(l=>{
    const on = (n.layers||[]).includes(l.id);
    return `<span class="tag ${on?'a':''}" title="${l.id}">${l.label}</span>`;
  }).join("");
}

function hcell(text){
  const el = document.createElement("div");
  el.className = "hcell";
  el.textContent = text;
  return el;
}

function buildHeat(){
  const grid = UI.heatGrid;
  grid.innerHTML = "";
  grid.appendChild(hcell("–ï—Ç–∞–ø / –†–æ–ª—å"));
  for(const c of HEAT_COLS) grid.appendChild(hcell(c));
  for(const r of HEAT_ROWS){
    grid.appendChild(hcell(r));
    for(const c of HEAT_COLS){
      const el = document.createElement("div");
      el.className = "cell";
      el.dataset.rc = `${r}|${c}`;
      el.innerHTML = `<span>${r.slice(0,2)}-${c.slice(0,2)}</span><span class="badge good">0</span>`;
      grid.appendChild(el);
    }
  }
}

function heatColor(v, status){
  const a = clamp(v/100, 0, 1);
  let base = `rgba(130,185,255,${0.06 + 0.20*a})`;
  if(status==="warn") base = `rgba(255,220,120,${0.06 + 0.24*a})`;
  if(status==="bad")  base = `rgba(255,120,140,${0.06 + 0.26*a})`;
  return base;
}

function updateHeat(heatState){
  for(const el of $$(".cell", UI.heatGrid)){
    const key = el.dataset.rc;
    const v = heatState[key]?.v ?? 0;
    const status = heatState[key]?.status ?? "ok";
    const badge = el.querySelector(".badge");
    badge.textContent = String(Math.round(v));
    badge.classList.remove("good","warn","bad");
    badge.classList.add(status==="ok"?"good":status);
    el.style.background = heatColor(v, status);
  }
}

function presetScenario(name){
  const base = { friction:35, trust:45, incent:30, distrib:40, quality:38, tooling:44 };
  if(name==="launch"){ return {...base, trust:32, distrib:35, quality:35, incent:25}; }
  if(name==="viral"){ return {...base, incent:65, distrib:55, trust:42, quality:34}; }
  if(name==="supply"){ return {...base, tooling:70, distrib:45, quality:40, friction:30}; }
  if(name==="trust"){ return {...base, trust:18, quality:55, friction:42, incent:20}; }
  return base;
}
function refreshKnobLabels(){
  UI.vFriction.textContent = UI.friction.value;
  UI.vTrust.textContent = UI.trust.value;
  UI.vIncent.textContent = UI.incent.value;
  UI.vDistrib.textContent = UI.distrib.value;
  UI.vQuality.textContent = UI.quality.value;
  UI.vTooling.textContent = UI.tooling.value;
}
function applyKnobsFromUI(){
  STATE.knobs.friction = Number(UI.friction.value);
  STATE.knobs.trust = Number(UI.trust.value);
  STATE.knobs.incent = Number(UI.incent.value);
  STATE.knobs.distrib = Number(UI.distrib.value);
  STATE.knobs.quality = Number(UI.quality.value);
  STATE.knobs.tooling = Number(UI.tooling.value);
}
function toast(title, text){
  UI.toastTitle.textContent = title;
  UI.toastText.textContent = text;
  UI.toast.classList.add("show");
  clearTimeout(STATE._toastTimer);
  STATE._toastTimer = setTimeout(()=>UI.toast.classList.remove("show"), 1400);
}
function setScenario(name, apply=true){
  STATE.scenario = name;
  const p = presetScenario(name);
  if(apply){
    UI.friction.value = p.friction;
    UI.trust.value = p.trust;
    UI.incent.value = p.incent;
    UI.distrib.value = p.distrib;
    UI.quality.value = p.quality;
    UI.tooling.value = p.tooling;
    refreshKnobLabels();
    applyKnobsFromUI();
  }
  toast("–°—Ü–µ–Ω–∞—Ä—ñ–π", "–ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ: " + UI.scenario.options[UI.scenario.selectedIndex].text);
}
function setFocus(f){
  STATE.focus = f;
  UI.focusBuyer.classList.toggle("active", f==="buyer");
  UI.focusBoth.classList.toggle("active", f==="both");
  UI.focusCreator.classList.toggle("active", f==="creator");
  UI.chipFocus.textContent = (f==="buyer"?"–ü–æ–∫—É–ø—Ü—ñ":f==="creator"?"–ö—Ä–µ–∞—Ç–æ—Ä–∏":"–û–±–∏–¥–≤–∞");
}
function setRunning(on){
  STATE.running = on;
  UI.chipSim.textContent = on ? "Running" : "Idle";
  UI.liveDot.classList.toggle("on", on);
}
function pushSeries(arr, v){ arr.push(v); if(arr.length>42) arr.shift(); }

function updateMetrics(){
  const k = STATE.knobs;
  const activation = clamp( (k.distrib/100)*0.55 + (k.tooling/100)*0.25 + (1-k.friction/100)*0.30 - (STATE.metrics.fraud*0.12), 0, 1 );
  const conv = clamp( (k.trust/100)*0.55 + (1-k.friction/100)*0.35 + (k.quality/100)*0.18 - (STATE.metrics.fraud*0.20), 0, 1 );
  const ret = clamp( (k.trust/100)*0.42 + (k.quality/100)*0.22 + (k.incent/100)*0.18 - (k.friction/100)*0.18, 0, 1 );
  const K = clamp( 0.15 + 0.85*(k.incent/100)*0.55 + 0.35*(k.trust/100) + 0.20*(k.distrib/100) - 0.50*STATE.metrics.fraud, 0, 2.5 );
  STATE.metrics.activation = activation;
  STATE.metrics.conv = conv;
  STATE.metrics.ret = ret;
  STATE.metrics.k = K;
  pushSeries(STATE.series.activation, activation);
  pushSeries(STATE.series.conv, conv);
  pushSeries(STATE.series.ret, ret);
  pushSeries(STATE.series.k, K/2.5);
}

function drawSpark(canvas, series){
  const ctx = canvas.getContext("2d");
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = w*devicePixelRatio;
  canvas.height = h*devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle = "rgba(255,255,255,.08)";
  ctx.lineWidth = 1;
  for(let i=1;i<4;i++){
    const y = (h/4)*i;
    ctx.beginPath(); ctx.moveTo(6,y); ctx.lineTo(w-6,y); ctx.stroke();
  }
  if(series.length<2) return;
  const pad = 6;
  const xs = series.map((_,i)=> pad + (w-2*pad)*(i/(series.length-1)));
  const min = Math.min(...series), max = Math.max(...series);
  const span = (max-min) || 1;
  const ys = series.map(v=> (h-pad) - (h-2*pad)*((v-min)/span));
  ctx.strokeStyle = "rgba(130,185,255,.85)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(xs[0], ys[0]);
  for(let i=1;i<xs.length;i++) ctx.lineTo(xs[i], ys[i]);
  ctx.stroke();
  ctx.fillStyle = "rgba(255,255,255,.88)";
  ctx.beginPath(); ctx.arc(xs[xs.length-1], ys[ys.length-1], 2.6, 0, Math.PI*2); ctx.fill();
}

function renderKPIs(){
  UI.kpiActivation.textContent = STATE.metrics.activation.toFixed(2);
  UI.kpiConv.textContent = (STATE.metrics.conv*100).toFixed(1) + "%";
  UI.kpiRet.textContent = (STATE.metrics.ret*100).toFixed(1) + "%";
  UI.kpiK.textContent = STATE.metrics.k.toFixed(2);
  drawSpark(UI.spActivation, STATE.series.activation);
  drawSpark(UI.spConv, STATE.series.conv);
  drawSpark(UI.spRet, STATE.series.ret);
  drawSpark(UI.spK, STATE.series.k);
}

function renderLane(laneEl, arr){
  laneEl.innerHTML = "";
  const w = laneEl.clientWidth;
  const steps = arr.slice(-42);
  const n = steps.length || 1;
  for(let i=0;i<steps.length;i++){
    const s = steps[i];
    const x = (i/(n-1 || 1))*w;
    if(s.sessionBoundary){
      const v = document.createElement("div");
      v.className = "vline"; v.style.left = Math.round(x) + "px";
      laneEl.appendChild(v);
      continue;
    }
    const d = document.createElement("div");
    d.className = "dotStep";
    if(s.err) d.classList.add("err");
    if(s.micro) d.classList.add("micro");
    d.style.left = Math.round(x) + "px";
    d.title = s.key + (s.err ? " (error)" : s.micro ? " (micro)" : "");
    laneEl.appendChild(d);
  }
}
function renderBranch(){
  renderLane(UI.laneBuyer, STATE.branch.buyer);
  renderLane(UI.laneCreator, STATE.branch.creator);
}

function computeHeat(){
  const k = STATE.knobs;
  const s = STATE.scenario;
  const fraud = STATE.metrics.fraud;
  const refund = STATE.metrics.refund;
  const stage = {
    "Discover": clamp( 30 + 0.55*k.distrib + 0.25*(STATE.metrics.k*40), 0, 100),
    "Trust": clamp( 25 + 0.70*k.trust - 40*fraud + 10*(s==="trust"?-1:0), 0, 100),
    "Checkout": clamp( 20 + 0.65*(100-k.friction) + 0.20*k.trust - 20*fraud, 0, 100),
    "Delivery": clamp( 18 + 0.55*k.quality + 0.20*k.tooling - 20*refund, 0, 100),
    "Review": clamp( 14 + 0.45*k.trust + 0.20*k.quality, 0, 100),
    "Referral": clamp( 10 + 0.75*k.incent + 0.25*k.trust - 35*fraud, 0, 100),
  };
  const roleW = {
    "–ü–æ–∫—É–ø–µ—Ü—å": 1.0,
    "–ö—Ä–µ–∞—Ç–æ—Ä": 0.85,
    "–ü–∞—Ä—Ç–Ω–µ—Ä": 0.75 + 0.25*(k.incent/100),
    "–ü—ñ–¥—Ç—Ä–∏–º–∫–∞": 0.55 + 0.35*(refund + fraud),
    "–ú–æ–¥–µ—Ä–∞—Ü—ñ—è": 0.35 + 0.70*fraud,
    "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞": 0.65 + 0.25*(STATE.toggles.events?1:0) + 0.15*(s==="viral"?1:0),
  };
  const heat = {};
  for(const r of HEAT_ROWS){
    for(const c of HEAT_COLS){
      let v = stage[r] * roleW[c];
      v = clamp(v, 0, 100);
      let status = "ok";
      if((r==="Trust" || r==="Referral") && fraud>0.22) status = "warn";
      if((r==="Checkout") && k.friction>60) status = "warn";
      if((r==="Delivery") && refund>0.20) status = "warn";
      if((r==="Trust" || r==="Checkout") && s==="trust") status = "bad";
      if((r==="Referral") && (s==="viral") && fraud>0.25) status = "bad";
      heat[`${r}|${c}`] = {v, status};
    }
  }
  return heat;
}

function renderLog(){
  const lines = STATE.trace.slice(-60).map(e=>{
    const t = new Date(e.t).toLocaleTimeString();
    const flags = [e.actor, e.type, e.err?"ERR":"ok"].join(" ‚Ä¢ ");
    const note = e.note ? (" ‚Äî " + e.note) : "";
    return `${String(e.tick).padStart(4," ")}  ${t}  ${flags}  |  ${e.node}${note}`;
  });
  UI.eventLog.textContent = lines.join("\n");
}

function renderAll(){
  markSelectedNode();
  buildInspector();
  renderKPIs();
  renderBranch();
  updateHeat(computeHeat());
  renderLog();
}

function selectNode(id, toastIt){
  STATE.selectedNode = id;
  markSelectedNode();
  buildInspector();
  if(toastIt) toast("–í—É–∑–æ–ª", id);
}

function recordEvent(evt){
  STATE.lastEvent = evt;
  if(STATE.toggles.events){
    STATE.trace.push(evt);
    if(STATE.trace.length>1200) STATE.trace.shift();
  }
}
function pushBranch(actor, evt, micro=false, errOverride=null){
  const arr = (actor==="buyer") ? STATE.branch.buyer : STATE.branch.creator;
  const err = (errOverride!==null) ? errOverride : !!evt.err;
  arr.push({t: STATE.tick, key: evt.node, micro: !!micro, err, sessionBoundary:false});
  if(arr.length>48) arr.shift();
}
function markSessionBoundary(actor){
  const arr = (actor==="buyer") ? STATE.branch.buyer : STATE.branch.creator;
  arr.push({t: STATE.tick, key:"|", micro:false, err:false, sessionBoundary:true});
  if(arr.length>48) arr.shift();
}

function failureProb(){
  const k = STATE.knobs;
  const base = 0.08;
  const risk = 0.18*(1-k.quality/100) + 0.12*(k.incent/100) + 0.10*(k.friction/100);
  const crisis = (STATE.scenario==="trust") ? 0.10 : 0.0;
  return clamp(base + risk + crisis, 0.05, 0.55);
}
function injectFailure(actor){
  const s = STATE.scenario;
  let options = ["payment_fail","fraud_spike","piracy_signal","fake_review","delivery_issue","checkout_timeout"];
  if(s==="trust") options = ["fraud_spike","fake_review","chargeback_wave","payment_fail","piracy_signal"];
  if(s==="viral") options = ["referral_fraud","fake_review","payment_fail","checkout_timeout"];
  if(s==="supply") options = ["low_quality_wave","piracy_signal","fake_review"];
  const type = choice(STATE.rng, options);
  const node = (type.includes("payment")||type.includes("chargeback")) ? "Payment"
            : (type.includes("checkout")) ? "Checkout"
            : (type.includes("delivery")) ? "Delivery"
            : (type.includes("piracy")||type.includes("quality")) ? "Packaging"
            : (type.includes("review")) ? "Trust Layer"
            : "Moderation / Anti-fraud";
  if(type==="fraud_spike" || type==="chargeback_wave" || type==="referral_fraud"){
    STATE.metrics.fraud = clamp(STATE.metrics.fraud + 0.05, 0, 1);
  }
  if(type==="payment_fail"){
    STATE.metrics.refund = clamp(STATE.metrics.refund + 0.01, 0, 1);
  }
  return {t:Date.now(), tick:STATE.tick, actor, node, type, err:true, note:`${type} detected ‚Üí checks/rollback`};
}
function scheduleBossChain(){
  STATE.bossQueue = ["payment_fail","fake_review","fraud_spike","chargeback_wave"];
}
function forceBossFailNow(){
  if(STATE.bossQueue.length===0) scheduleBossChain();
  const type = STATE.bossQueue.shift();
  const node = (type.includes("payment")||type.includes("chargeback")) ? "Payment"
            : (type.includes("review")) ? "Trust Layer"
            : "Moderation / Anti-fraud";
  const actor = (STATE.focus==="creator") ? "creator" : "buyer";
  const evt = {t:Date.now(), tick:STATE.tick, actor, node, type, err:true, note:`boss:${type} ‚Üí checks/rollback`};
  if(type==="fraud_spike" || type==="chargeback_wave"){ STATE.metrics.fraud = clamp(STATE.metrics.fraud + 0.07, 0, 1); }
  recordEvent(evt); pushBranch(actor, evt, false, true);
  updateMetrics(); renderAll();
  toast("Boss Fail", type);
}

function buyerParams(){
  const k = STATE.knobs;
  const s = STATE.scenario;
  const friction = k.friction/100;
  const trust = k.trust/100;
  const incent = k.incent/100;
  const distrib = k.distrib/100;
  const quality = k.quality/100;
  const baseView = 0.20 + 0.60*distrib;
  const trustBoost = 0.10 + 0.65*trust;
  const frictionPenalty = 0.12 + 0.75*friction;
  const refundRisk = clamp(0.10 + 0.45*(1-trust) + 0.20*(1-quality), 0.05, 0.85);
  const shareBoost = clamp(0.08 + 0.55*incent + 0.22*trust, 0.02, 0.90);
  let crisis = 0;
  if(s==="trust") crisis = 0.18;
  if(s==="launch") crisis = 0.10;
  return {baseView, trustBoost, frictionPenalty, refundRisk, shareBoost, crisis};
}
function creatorParams(){
  const k = STATE.knobs;
  const friction = k.friction/100;
  const trust = k.trust/100;
  const tooling = k.tooling/100;
  const quality = k.quality/100;
  const distrib = k.distrib/100;
  const publishRate = clamp(0.12 + 0.70*tooling - 0.25*friction, 0.02, 0.92);
  const qualityScore = clamp(0.20 + 0.55*quality + 0.25*tooling, 0.05, 0.95);
  const firstSaleChance = clamp(0.08 + 0.40*distrib + 0.25*trust + 0.20*qualityScore, 0.02, 0.92);
  const churnRisk = clamp(0.10 + 0.35*(1-firstSaleChance) + 0.18*friction, 0.03, 0.90);
  return {publishRate, qualityScore, firstSaleChance, churnRisk};
}
function stepBuyer(force){
  const p = buyerParams();
  let node = STATE.buyer.stage;
  const k = STATE.knobs;
  const r = STATE.rng;
  if(node==="Acquisition" && rnd(r) < 0.10){ STATE.buyer.session++; markSessionBoundary("buyer"); }
  const viewProb = clamp(p.baseView - 0.20*(k.friction/100), 0.05, 0.95);
  const buyProb = clamp(sigmoid((p.trustBoost - p.frictionPenalty - p.crisis)*3.2 - 0.2), 0.03, 0.88);
  const payFailProb = clamp(0.06 + 0.35*(k.friction/100) + 0.12*p.crisis, 0.03, 0.65);
  const refundProb = p.refundRisk;
  const reviewProb = clamp(0.12 + 0.40*(k.trust/100), 0.05, 0.85);
  const repeatProb = clamp(0.08 + 0.35*(k.trust/100) - 0.12*(k.friction/100), 0.02, 0.60);
  const shareProb = p.shareBoost;
  let err=false, type="core", note="";
  if(node==="Acquisition"){
    if(rnd(r) < viewProb || force){ node="Storefront"; note="enter storefront"; }
    else { err=true; note="bounce"; STATE.buyer.drops++; }
  } else if(node==="Storefront"){
    STATE.buyer.views++; node="Product Page"; note="open product";
  } else if(node==="Product Page"){
    const goTrust = rnd(r) < clamp(0.55 + 0.25*(1-k.trust/100), 0.35, 0.85);
    node = goTrust ? "Trust Layer" : "Checkout";
    note = goTrust ? "seek proof" : "go checkout";
  } else if(node==="Trust Layer"){
    node = (rnd(r) < buyProb || force) ? "Checkout" : "Product Page";
    note = (node==="Checkout") ? "CTA buy" : "hesitate";
    if(node==="Product Page" && rnd(r)<0.35){ err=true; STATE.buyer.drops++; note="trust not enough"; }
  } else if(node==="Checkout"){
    node = (rnd(r) < buyProb || force) ? "Payment" : "Product Page";
    note = (node==="Payment") ? "start payment" : "drop from checkout";
    if(node!=="Payment"){ err=true; STATE.buyer.drops++; }
  } else if(node==="Payment"){
    if(rnd(r) < payFailProb && !force){
      err=true; type="payment_fail"; note="payment fail"; node="Checkout";
    } else {
      node="Delivery"; note="payment success"; STATE.buyer.purchases++;
      STATE.metrics.ttv_ms = Math.round(lerp(1200, 9500, clamp(0.25 + 0.5*(k.friction/100) + 0.2*p.crisis, 0, 1)));
    }
  } else if(node==="Delivery"){
    node="Post-purchase"; note="delivered";
    if(rnd(r) < refundProb*0.25){ err=true; type="delivery_issue"; note="delivery friction"; }
  } else if(node==="Post-purchase"){
    if(rnd(r) < refundProb*0.28){ err=true; type="refund"; note="refund requested"; STATE.metrics.refund = clamp(STATE.metrics.refund + 0.02, 0, 1); }
    if(rnd(r) < reviewProb){ STATE.buyer.reviews++; }
    if(rnd(r) < shareProb){ STATE.buyer.shares++; node="Share / Affiliate"; note="share"; }
    else { node="Acquisition"; note="end session"; }
    if(rnd(r) < repeatProb){ STATE.buyer.repeats++; }
  } else if(node==="Share / Affiliate"){
    node="Acquisition"; note="referral loop";
  }
  STATE.buyer.stage = node;
  STATE.selectedNode = node;
  return {t:Date.now(), tick:STATE.tick, actor:"buyer", node, type, err, note};
}
function stepCreator(force){
  const p = creatorParams();
  let node = STATE.creator.stage;
  const r = STATE.rng;
  const k = STATE.knobs;
  if(node==="Creator Onboard" && rnd(r) < 0.12){ STATE.creator.session++; markSessionBoundary("creator"); }
  let err=false, type="core", note="";
  if(node==="Creator Onboard"){
    const ok = rnd(r) < clamp(0.25 + 0.60*(k.tooling/100) - 0.20*(k.friction/100), 0.05, 0.90);
    node = (ok||force) ? "Creator Studio" : "Creator Onboard";
    note = (node==="Creator Studio") ? "start first product" : "stall";
    if(node==="Creator Onboard" && rnd(r)<0.25){ err=true; STATE.creator.drops++; note="onboard drop"; }
  } else if(node==="Creator Studio"){
    STATE.creator.products++; node="Packaging"; note="prepare package";
  } else if(node==="Packaging"){
    const ready = rnd(r) < p.publishRate || force;
    node = ready ? "Publish / Launch" : "Creator Studio";
    note = ready ? "publish" : "revise";
    if(!ready && rnd(r)<0.25){ err=true; note="quality incomplete"; }
  } else if(node==="Publish / Launch"){
    STATE.creator.publishes++;
    const sale = rnd(r) < p.firstSaleChance;
    if(sale){ STATE.creator.sales++; note="first sales"; } else { note="no sales yet"; }
    node="Analytics / Experiments";
    if(!sale && rnd(r)<p.churnRisk*0.22){ err=true; type="creator_churn_risk"; note="creator frustration"; }
  } else if(node==="Analytics / Experiments"){
    const iterate = rnd(r) < clamp(0.55 + 0.25*(k.distrib/100), 0.20, 0.92);
    node = iterate ? "Creator Studio" : "Creator Onboard";
    note = iterate ? "iterate & improve" : "pause / churn";
    if(node==="Creator Onboard" && rnd(r)<p.churnRisk*0.30){ err=true; type="creator_churn"; note="churn"; STATE.creator.churn++; }
  }
  STATE.creator.stage = node;
  STATE.selectedNode = node;
  return {t:Date.now(), tick:STATE.tick, actor:"creator", node, type, err, note};
}
function chooseActor(){
  if(STATE.focus==="buyer") return "buyer";
  if(STATE.focus==="creator") return "creator";
  const biasBuyer = clamp((STATE.knobs.distrib - STATE.knobs.tooling + 50)/100, 0.25, 0.75);
  return rnd(STATE.rng) < biasBuyer ? "buyer" : "creator";
}
function simTick(forceStep=false){
  applyKnobsFromUI();
  const actor = chooseActor();
  let evt = (actor==="buyer") ? stepBuyer(forceStep) : stepCreator(forceStep);
  // micro event
  if(STATE.toggles.micro && rnd(STATE.rng) < 0.65){
    const micro = {t:Date.now(), tick:STATE.tick, actor, node:evt.node, type:"micro", err:false, note:"micro_track"};
    recordEvent(micro); pushBranch(actor, micro, true);
  }
  // failures
  if(STATE.toggles.failure && rnd(STATE.rng) < failureProb()){
    const f = injectFailure(actor);
    recordEvent(f); pushBranch(actor, f, false, true);
    evt = f;
  } else {
    pushBranch(actor, evt, false, evt.err);
  }
  recordEvent(evt);
  updateMetrics();
  renderAll();
  STATE.tick++;
}
function resetAll(hard=false){
  const seed = parseInt(UI.seed.value || "42",10) || 42;
  STATE.seed = seed;
  STATE.rng = {x: seed};
  STATE.tick = 0;
  STATE.trace = [];
  STATE.lastEvent = null;
  STATE.buyer = { stage:"Acquisition", session:0, views:0, purchases:0, repeats:0, shares:0, reviews:0, drops:0 };
  STATE.creator = { stage:"Creator Onboard", session:0, products:0, publishes:0, sales:0, churn:0, drops:0 };
  STATE.metrics = { activation:0, conv:0, ret:0, k:0, fraud:0, refund:0, ttv_ms:0 };
  STATE.series = { activation:[], conv:[], ret:[], k:[] };
  STATE.branch = { buyer:[], creator:[] };
  STATE.bossQueue = [];
  if(hard){ setScenario(UI.scenario.value, true); }
  setRunning(false);
  UI.eventLog.textContent = "";
  renderAll();
  toast("Reset", "–°—Ç–∞–Ω —Å–∫–∏–Ω—É—Ç–æ (seed=" + seed + ")");
}

function refreshDailyLabels(){
  UI.vSess.textContent = UI.sess.value;
  UI.vDailyRet.textContent = UI.dailyRet.value + "%";
  UI.vFat.textContent = UI.fat.value + "%";
  UI.vDays.textContent = UI.days.value;
}
function resetDayStats(){
  STATE.daily = { day:0, sessions:0, purchases:0, publishes:0, errors:0, recoveries:0, ksum:0, ttv:0 };
  UI.dayReport.textContent = "";
  toast("Daily", "–î–µ–Ω–Ω—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ —Å–∫–∏–Ω—É—Ç–æ");
}
function runOneDay(){
  const sessions = Number(UI.sess.value);
  const ret = Number(UI.dailyRet.value)/100;
  const fat = Number(UI.fat.value)/100;
  let report = [];
  STATE.daily.day++;
  let localEngagement = 1.0;
  for(let s=0; s<sessions; s++){
    if(rnd(STATE.rng) > ret*localEngagement) break;
    STATE.daily.sessions++;
    const ticks = randInt(STATE.rng, 4, 9);
    const beforeErr = STATE.trace.filter(e=>e.err).length;
    for(let i=0;i<ticks;i++) simTick(false);
    const afterErr = STATE.trace.filter(e=>e.err).length;
    STATE.daily.errors += Math.max(0, afterErr-beforeErr);
    const rec = rnd(STATE.rng) < clamp((STATE.knobs.trust + STATE.knobs.quality)/220, 0.05, 0.75);
    if(rec) STATE.daily.recoveries++;
    STATE.daily.purchases += STATE.buyer.purchases;
    STATE.daily.publishes += STATE.creator.publishes;
    STATE.daily.ksum += STATE.metrics.k;
    STATE.daily.ttv += STATE.metrics.ttv_ms;
    localEngagement *= (1 - fat*0.25);
  }
  const avgK = STATE.daily.sessions ? (STATE.daily.ksum/STATE.daily.sessions) : 0;
  const avgTTV = STATE.daily.sessions ? Math.round(STATE.daily.ttv/STATE.daily.sessions) : 0;
  report.push(`Day ${STATE.daily.day}`);
  report.push(`sessions=${STATE.daily.sessions}  errors=${STATE.daily.errors}  recoveries=${STATE.daily.recoveries}`);
  report.push(`avgK=${avgK.toFixed(2)}  avgTTV=${avgTTV}ms`);
  report.push(`buyerPurchases(total)=${STATE.buyer.purchases}  creatorPublishes(total)=${STATE.creator.publishes}`);
  report.push(`fraud=${(STATE.metrics.fraud*100).toFixed(1)}%  refunds=${(STATE.metrics.refund*100).toFixed(1)}%`);
  report.push("");
  UI.dayReport.textContent = report.join("\n") + UI.dayReport.textContent;
}
function exportTrace(){
  const payload = {
    meta:{ product:"BlackSea Growth Visual Atlas", version:"v1", exportedAt:new Date().toISOString() },
    scenario: STATE.scenario, focus: STATE.focus, seed: STATE.seed,
    toggles: {...STATE.toggles}, knobs: {...STATE.knobs},
    metrics: {...STATE.metrics}, totals: { buyer:{...STATE.buyer}, creator:{...STATE.creator} },
    trace: STATE.trace.slice()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `blacksea_growth_trace_${STATE.scenario}_${STATE.focus}_seed${STATE.seed}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
  toast("Export", "JSON trace –∑–±–µ—Ä–µ–∂–µ–Ω–æ");
}
async function copyLastEvent(){
  if(!STATE.lastEvent){ toast("Copy", "–ù–µ–º–∞—î –ø–æ–¥—ñ–π"); return; }
  const txt = JSON.stringify(STATE.lastEvent, null, 2);
  try{ await navigator.clipboard.writeText(txt); toast("Copy", "–û—Å—Ç–∞–Ω–Ω—é –ø–æ–¥—ñ—é —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ"); }
  catch(e){ toast("Copy", "Clipboard –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π"); }
}

function init(){
  buildMap();
  buildHeat();
  $$(".subnav .tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $$(".subnav .tab").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.dataset.jump;
      $(target).scrollIntoView({behavior:"smooth", block:"start"});
    });
  });
  UI.insTabs.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      UI.insTabs.forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      STATE.insTab = btn.dataset.ins;
      buildInspector();
    });
  });
  UI.focusBuyer.addEventListener("click", ()=>setFocus("buyer"));
  UI.focusBoth.addEventListener("click", ()=>setFocus("both"));
  UI.focusCreator.addEventListener("click", ()=>setFocus("creator"));
  UI.scenario.addEventListener("change", ()=>setScenario(UI.scenario.value, true));
  UI.togEvents.addEventListener("change", ()=>{ STATE.toggles.events = UI.togEvents.checked; toast("Events", STATE.toggles.events?"ON":"OFF"); });
  UI.togMicro.addEventListener("change", ()=>{ STATE.toggles.micro = UI.togMicro.checked; toast("Micro", STATE.toggles.micro?"ON":"OFF"); });
  UI.togFailure.addEventListener("change", ()=>{ STATE.toggles.failure = UI.togFailure.checked; toast("Failure", STATE.toggles.failure?"ON":"OFF"); });
  UI.togBoss.addEventListener("change", ()=>{ STATE.toggles.boss = UI.togBoss.checked; toast("Boss", STATE.toggles.boss?"ON":"OFF"); });
  UI.togAuto.addEventListener("change", ()=>{ STATE.toggles.auto = UI.togAuto.checked; toast("Auto-inspect", STATE.toggles.auto?"ON":"OFF"); });

  for(const el of [UI.friction,UI.trust,UI.incent,UI.distrib,UI.quality,UI.tooling]){
    el.addEventListener("input", ()=>{
      refreshKnobLabels();
      applyKnobsFromUI();
      updateMetrics();
      renderKPIs();
      updateHeat(computeHeat());
    });
  }

  let timer = null;
  function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } setRunning(false); }
  function startTimer(){
    stopTimer(); setRunning(true);
    timer = setInterval(()=>{ if(STATE.running) simTick(false); }, Number(UI.speed.value));
  }
  UI.btnPlay.addEventListener("click", ()=>{
    STATE.toggles.events = UI.togEvents.checked;
    STATE.toggles.micro = UI.togMicro.checked;
    STATE.toggles.failure = UI.togFailure.checked;
    STATE.toggles.boss = UI.togBoss.checked;
    STATE.toggles.auto = UI.togAuto.checked;
    startTimer();
  });
  UI.btnPause.addEventListener("click", ()=>stopTimer());
  UI.btnStep.addEventListener("click", ()=>{ stopTimer(); simTick(true); });
  UI.speed.addEventListener("change", ()=>{ if(STATE.running) startTimer(); });
  UI.btnFailNow.addEventListener("click", ()=>{ if(STATE.toggles.boss || UI.togBoss.checked) forceBossFailNow(); else { const a=chooseActor(); const f=injectFailure(a); recordEvent(f); pushBranch(a,f,false,true); updateMetrics(); renderAll(); toast("Fail now", f.type);} });
  UI.btnLocate.addEventListener("click", ()=>{ $("#core").scrollIntoView({behavior:"smooth", block:"start"}); const el=$(`.node[data-node="${STATE.selectedNode}"]`); if(el){ el.animate([{transform:"translateY(0)"},{transform:"translateY(-2px)"},{transform:"translateY(0)"}], {duration:420,easing:"ease-out"}); } });

  UI.sess.addEventListener("input", refreshDailyLabels);
  UI.dailyRet.addEventListener("input", refreshDailyLabels);
  UI.fat.addEventListener("input", refreshDailyLabels);
  UI.days.addEventListener("input", refreshDailyLabels);
  UI.btnRunDay.addEventListener("click", ()=>runOneDay());
  UI.btnRunDays.addEventListener("click", ()=>{ const d=Number(UI.days.value); for(let i=0;i<d;i++) runOneDay(); });
  UI.btnResetDay.addEventListener("click", resetDayStats);

  UI.btnExport.addEventListener("click", exportTrace);
  UI.btnCopyLast.addEventListener("click", copyLastEvent);
  UI.btnResetAll.addEventListener("click", ()=>resetAll(true));

  const ro = new ResizeObserver(()=>requestAnimationFrame(drawEdges));
  ro.observe(UI.mapWrap);

  refreshKnobLabels();
  refreshDailyLabels();
  setScenario(UI.scenario.value, true);
  setFocus("both");
  resetAll(false);
  selectNode("Storefront", false);
  updateMetrics();
  renderAll();
}
init();
</script>
</body>
</html>
