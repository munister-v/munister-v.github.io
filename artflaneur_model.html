<!DOCTYPE html>

<html data-mode="both" data-sidebar-open="false" data-theme="light" lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Art Flâneur — Gaming Mechanics (v6 RU Expanded)</title>
<style>
:root{
  --bg:#f4f0e7;
  --paper:rgba(255,255,255,.78);
  --paper2:rgba(255,255,255,.58);
  --ink:#0f0f10;
  --muted:rgba(15,15,16,.64);
  --line:rgba(15,15,16,.12);
  --shadow:0 26px 110px rgba(0,0,0,.14);
  --shadow2:0 12px 30px rgba(0,0,0,.10);
  --radius:22px;
  --radius2:16px;
  --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  --mark:rgba(0,0,0,.10);
  --accent: rgba(15,15,16,.95);
  --accentSoft: rgba(15,15,16,.10);
  --ok: rgba(0,0,0,.06);
  --focus: 0 0 0 4px rgba(0,0,0,.10);
  --contentMax: 1220px;
}

[data-theme="dark"]{
  --bg:#0e0f12;
  --paper:rgba(255,255,255,.06);
  --paper2:rgba(255,255,255,.08);
  --ink:#f2f2f2;
  --muted:rgba(242,242,242,.70);
  --line:rgba(255,255,255,.12);
  --shadow:0 28px 120px rgba(0,0,0,.55);
  --shadow2:0 14px 36px rgba(0,0,0,.42);
  --mark:rgba(255,255,255,.13);
  --accent: rgba(255,255,255,.96);
  --accentSoft: rgba(255,255,255,.12);
  --ok: rgba(255,255,255,.08);
  --focus: 0 0 0 4px rgba(255,255,255,.14);
}

html,body{height:100%}
body{
  margin:0;font-family:var(--sans);color:var(--ink);
  background:
    radial-gradient(1200px 760px at 22% 8%, rgba(0,0,0,.05), transparent 62%),
    radial-gradient(980px 720px at 86% 70%, rgba(0,0,0,.045), transparent 64%),
    linear-gradient(180deg, rgba(255,255,255,.30), transparent 34%),
    var(--bg);
  overflow-x:hidden;
}
[data-theme="dark"] body{
  background:
    radial-gradient(1200px 760px at 22% 8%, rgba(255,255,255,.08), transparent 62%),
    radial-gradient(980px 720px at 86% 70%, rgba(255,255,255,.06), transparent 64%),
    linear-gradient(180deg, rgba(255,255,255,.05), transparent 40%),
    var(--bg);
}
body::before{
  content:"";position:fixed;inset:0;pointer-events:none;opacity:.12;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
  mix-blend-mode:multiply;
}
[data-theme="dark"] body::before{opacity:.09; mix-blend-mode:screen;}
*{box-sizing:border-box; min-width:0}
a{color:inherit}
mark{background:var(--mark);border-radius:6px;padding:0 4px}

.app{min-height:100%;display:grid;grid-template-columns:360px minmax(0,1fr)}

.sidebar{
  border-right:1px solid var(--line);
  padding:18px 16px;
  background:rgba(255,255,255,.22);
  backdrop-filter:blur(12px);
  position:sticky;top:0;height:100vh;overflow:auto;
}
[data-theme="dark"] .sidebar{background:rgba(0,0,0,.18)}

.main{padding: clamp(14px, 2.6vw, 34px) clamp(12px, 2.6vw, 34px) 126px;}
.mainInner{max-width:var(--contentMax);margin:0 auto}

.progress{position:fixed;left:0;right:0;top:0;height:3px;z-index:90;background:transparent}
.progress > div{height:3px;width:0%;background:var(--accent);opacity:.55}

.scrim{position:fixed;inset:0;background:rgba(0,0,0,.28);opacity:0;pointer-events:none;transition:opacity .18s ease;z-index:70}
[data-sidebar-open="true"] .scrim{opacity:1;pointer-events:auto}

/* Buttons */
.btn{
  appearance:none;border:1px solid var(--line);
  background:rgba(255,255,255,.60);
  color:var(--ink);
  border-radius:999px;
  padding:9px 12px;
  font-size:12px;
  cursor:pointer;
  user-select:none;
  box-shadow:0 10px 28px rgba(0,0,0,.10);
  transition:transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
}
[data-theme="dark"] .btn{background:rgba(255,255,255,.08);box-shadow:0 12px 30px rgba(0,0,0,.45)}
.btn:hover{background:rgba(255,255,255,.82)}
[data-theme="dark"] .btn:hover{background:rgba(255,255,255,.12)}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:rgba(255,255,255,.34);box-shadow:none}
[data-theme="dark"] .btn.ghost{background:rgba(255,255,255,.06)}
.btn.icon{padding:9px 10px;display:grid;place-items:center;width:38px}
.btn:focus{outline:none;box-shadow:var(--focus)}
.btn[disabled]{opacity:.45;cursor:not-allowed}

/* Segmented */
.segment{
  display:flex;align-items:center;gap:6px;
  padding:4px;border-radius:999px;border:1px solid var(--line);
  background:rgba(255,255,255,.36);
}
[data-theme="dark"] .segment{background:rgba(255,255,255,.06)}
.segment button{
  border:0;background:transparent;color:var(--muted);
  padding:7px 10px;border-radius:999px;cursor:pointer;font-size:12px;
}
.segment button.active{
  background:var(--accentSoft);
  color:var(--ink);
  font-weight:900;
}

/* Brand */
.brand{display:flex;gap:10px;align-items:center;margin-bottom:12px}
.logo{width:38px;height:38px;border-radius:14px;background:var(--accent);display:grid;place-items:center;box-shadow:var(--shadow2)}
.logo svg{width:18px;height:18px;fill:var(--bg);opacity:.95}
.brand h1{margin:0;font-size:14px;line-height:1.2;letter-spacing:.2px}
.brand .sub{font-size:12px;color:var(--muted);margin-top:2px}

/* Search + chips */
.search{margin:12px 0 10px 0;display:grid;gap:8px}
.search label{font-size:12px;color:var(--muted)}
.search .row{display:flex;gap:10px;align-items:center}
.search input{
  flex:1;border-radius:14px;border:1px solid var(--line);
  background:rgba(255,255,255,.54);padding:11px 12px;font-size:13px;outline:none;
}
[data-theme="dark"] .search input{background:rgba(255,255,255,.07)}
.search input:focus{box-shadow:var(--focus)}
.chip{font-size:11px;color:var(--muted);border:1px solid var(--line);background:rgba(255,255,255,.44);padding:6px 10px;border-radius:999px;white-space:nowrap}
[data-theme="dark"] .chip{background:rgba(255,255,255,.06)}

/* TOC */
.toc h2{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin:0 0 10px 0}
.toc a{display:flex;gap:10px;align-items:center;padding:10px 10px;border-radius:14px;text-decoration:none;color:var(--ink);font-size:13px;border:1px solid transparent;user-select:none;transition:background .12s ease,border-color .12s ease,transform .12s ease}
.toc a:hover{background:var(--ok);border-color:var(--line)}
.toc a:active{transform:translateY(1px)}
.toc a.active{background:var(--accentSoft);border-color:rgba(0,0,0,.12);font-weight:900}
[data-theme="dark"] .toc a.active{border-color:rgba(255,255,255,.16)}
.toc a.hidden{display:none}
.dot{width:8px;height:8px;border-radius:999px;background:rgba(0,0,0,.28)}
[data-theme="dark"] .dot{background:rgba(255,255,255,.35)}
.toc a.active .dot{background:var(--accent)}

/* Context box */
.contextBox{
  margin-top:14px;
  padding:12px 12px;
  border-radius:18px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.30);
}
[data-theme="dark"] .contextBox{background:rgba(255,255,255,.05)}
.contextTitle{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted)}
.contextH{margin:8px 0 6px 0;font-weight:950}
.contextP{margin:0;color:var(--muted);line-height:1.55;font-size:12px}
.contextActions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}

/* Hint */
.hint{margin-top:14px;padding:12px 12px;border-radius:18px;border:1px dashed var(--line);color:var(--muted);font-size:12px;line-height:1.5}

/* Top chrome */
.chrome{
  position:sticky;top:0;z-index:60;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:10px 0 14px 0;
}
.chromeLeft{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.chromeRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

/* Card & hero */
.card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.hero{
  padding: clamp(18px, 2.2vw, 26px) clamp(18px, 2.2vw, 26px);
  border-bottom:1px solid var(--line);
  background:
    radial-gradient(900px 300px at 20% 0%, rgba(0,0,0,.06), transparent 65%),
    linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.38));
}
[data-theme="dark"] .hero{
  background:
    radial-gradient(900px 300px at 20% 0%, rgba(255,255,255,.10), transparent 65%),
    linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
}
.hero h1{margin:0;font-size:clamp(22px, 3.2vw, 36px);letter-spacing:.2px;line-height:1.1}
.hero p{margin:10px 0 0 0;max-width:1100px;line-height:1.75;font-size:clamp(13px, 1.35vw, 16px);color:rgba(15,15,16,.92)}
[data-theme="dark"] .hero p{color:rgba(242,242,242,.90)}
.badgeRow{margin-top:12px;display:flex;flex-wrap:wrap;gap:10px}
.pill{font-size:12px;border:1px solid var(--line);background:rgba(255,255,255,.50);padding:7px 10px;border-radius:999px;color:rgba(15,15,16,.86)}
[data-theme="dark"] .pill{background:rgba(255,255,255,.06);color:rgba(242,242,242,.86)}

/* Quick map cards */
.quickMap{margin-top:16px}
.quickGrid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:10px;
  margin-top:10px;
}
@media (max-width: 1100px){ .quickGrid{grid-template-columns: repeat(2, minmax(0,1fr))} }
@media (max-width: 520px){ .quickGrid{grid-template-columns: 1fr} }
.cardLink{
  display:flex;gap:12px;align-items:flex-start;
  padding:12px 12px;border-radius:18px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.36);
  text-decoration:none;
  transition:transform .12s ease, background .12s ease, box-shadow .12s ease;
}
[data-theme="dark"] .cardLink{background:rgba(255,255,255,.05)}
.cardLink:hover{transform:translateY(-1px);box-shadow:0 14px 34px rgba(0,0,0,.10);background:rgba(255,255,255,.50)}
[data-theme="dark"] .cardLink:hover{box-shadow:0 18px 44px rgba(0,0,0,.60);background:rgba(255,255,255,.08)}
.cardIcon{
  width:34px;height:34px;border-radius:12px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.05);
  display:grid;place-items:center;flex:0 0 auto;
}
[data-theme="dark"] .cardIcon{background:rgba(255,255,255,.08)}
.cardText{min-width:0}
.cardTitle{font-weight:950;font-size:13px;line-height:1.25}
.cardDesc{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.45}
.cardArrow{margin-left:auto;opacity:.65;flex:0 0 auto}

/* Content */
.content{padding: clamp(16px, 2.4vw, 24px)}

/* Sections */
.section{padding:20px 0;border-top:1px solid var(--line);scroll-margin-top: 96px}
.section:first-child{border-top:none}
.section h2{margin:0 0 10px 0;font-size:22px;letter-spacing:.1px}
.section .lead{margin:0 0 12px 0;font-size:15px;line-height:1.8;color:rgba(15,15,16,.92)}
[data-theme="dark"] .section .lead{color:rgba(242,242,242,.88)}

/* Meta block */
.sectionMeta{
  display:grid;
  grid-template-columns: minmax(0,1.25fr) minmax(0,.75fr);
  gap:12px;
  margin: 12px 0 14px 0;
}
@media (max-width: 980px){ .sectionMeta{grid-template-columns:1fr} }
.metaBox{
  border:1px solid var(--line);
  background:rgba(255,255,255,.30);
  border-radius:18px;
  padding:12px 12px;
}
[data-theme="dark"] .metaBox{background:rgba(255,255,255,.05)}
.metaLabel{
  font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);
  margin-bottom:8px;
}
.metaList{margin:0;padding-left:18px;display:grid;gap:6px}
.metaList li{line-height:1.55}
.pillRow{display:flex;flex-wrap:wrap;gap:8px}
.miniPill{
  display:inline-flex;align-items:center;gap:8px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.44);
  padding:8px 10px;border-radius:999px;
  text-decoration:none;font-size:12px;font-weight:800;
}
[data-theme="dark"] .miniPill{background:rgba(255,255,255,.06)}
.miniPill:hover{background:rgba(255,255,255,.70)}
[data-theme="dark"] .miniPill:hover{background:rgba(255,255,255,.10)}
.metaHint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.5}
.ruNote{margin:10px 0 0 0;line-height:1.8;color:rgba(15,15,16,.88)}
[data-theme="dark"] .ruNote{color:rgba(242,242,242,.86)}

/* Panels */
.grid{display:grid;gap:14px}
.grid.two{grid-template-columns:minmax(0,1.05fr) minmax(0,.95fr)}
.panel{
  padding:14px 14px;border-radius:var(--radius2);
  border:1px solid var(--line);
  background:var(--paper2);
  box-shadow:0 12px 28px rgba(0,0,0,.06);
  transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  min-width:0;
}
[data-theme="dark"] .panel{box-shadow:0 14px 30px rgba(0,0,0,.40)}
.panel:hover{transform:translateY(-1px);box-shadow:0 18px 44px rgba(0,0,0,.08)}
[data-theme="dark"] .panel:hover{box-shadow:0 20px 56px rgba(0,0,0,.48)}
.section.active .panel{border-color:rgba(0,0,0,.20)}
[data-theme="dark"] .section.active .panel{border-color:rgba(255,255,255,.22)}

.section-title{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin:16px 0 10px 0}
pre{
  margin:0;padding:14px 14px;border-radius:16px;
  background:rgba(15,15,16,.06);border:1px solid var(--line);
  overflow:auto;font-family:var(--mono);font-size:12px;line-height:1.55;color:var(--ink);
  white-space:pre;
  max-width:100%;
}
[data-theme="dark"] pre{background:rgba(255,255,255,.05);color:rgba(242,242,242,.92)}
.copyrow{display:flex;justify-content:space-between;align-items:center;margin:10px 0 8px 0;gap:10px}
.copyrow .label{font-size:12px;color:var(--muted)}
.callout{
  border-left:3px solid var(--accent);
  padding:10px 12px;border-radius:16px;
  background:rgba(0,0,0,.05);margin-top:10px;line-height:1.75
}
[data-theme="dark"] .callout{background:rgba(255,255,255,.06)}
.callout b{font-weight:950}
.svgcard{border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.36);padding:10px;overflow:hidden}
[data-theme="dark"] .svgcard{background:rgba(255,255,255,.05)}
.svgcard svg{width:100%;height:auto;display:block;max-width:100%}
details{border:1px solid var(--line);background:rgba(255,255,255,.22);border-radius:16px;padding:10px 12px}
[data-theme="dark"] details{background:rgba(255,255,255,.05)}
details summary{cursor:pointer;font-weight:900}
hr.sep{border:0;border-top:1px solid var(--line);margin:18px 0}
.anchor{height:1px}

/* Mode toggles */
[data-mode="reader"] pre,
[data-mode="reader"] .copyrow,
[data-mode="reader"] [data-copy]{display:none !important}
[data-mode="dev"] .lead,
[data-mode="dev"] .ruNote,
[data-mode="dev"] .sectionMeta{display:none !important}

/* Bottom nav */
.bottomNav{
  position:fixed;left:0;right:0;bottom:0;
  display:flex;justify-content:center;
  z-index:65;pointer-events:none;
}
.bottomNavInner{
  pointer-events:auto;
  width:min(var(--contentMax), calc(100% - 24px));
  margin: 0 12px 12px 12px;
  border-radius: 999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.62);
  backdrop-filter: blur(12px);
  display:flex;align-items:center;justify-content:space-between;
  padding: 10px 12px;
  box-shadow: 0 14px 44px rgba(0,0,0,.14);
  gap:10px;
}
[data-theme="dark"] .bottomNavInner{background:rgba(0,0,0,.32);box-shadow:0 22px 60px rgba(0,0,0,.62)}
.navMini{display:flex;flex-direction:column;gap:2px;min-width:0}
.navMini .k{font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
.navMini .v{font-size:12px;font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width: 360px}
.navBtn{display:flex;align-items:center;gap:8px}
.navBtn .btn{box-shadow:none;background:rgba(255,255,255,.46)}
[data-theme="dark"] .navBtn .btn{background:rgba(255,255,255,.06)}

/* Mobile */
@media (max-width: 980px){
  .app{grid-template-columns:1fr}
  .sidebar{
    position:fixed;top:0;left:0;bottom:0;height:auto;
    width:min(360px, 92vw);
    transform:translateX(-102%);
    transition:transform .18s ease;
    z-index:80;
    box-shadow:0 20px 70px rgba(0,0,0,.22);
  }
  [data-sidebar-open="true"] .sidebar{transform:translateX(0)}
  .grid.two{grid-template-columns:1fr}
  .navMini .v{max-width: 200px}
  .main{padding-bottom: 140px}
}
@media (max-width: 520px){
  .bottomNavInner{padding:8px 10px}
  .navMini .v{max-width: 150px}
}

@media (prefers-reduced-motion: reduce){
  *{transition:none !important;scroll-behavior:auto !important}
}

@media print{
  .sidebar,.scrim,.bottomNav,.chrome,.progress{display:none !important}
  body{background:#fff}body::before{display:none}
  .main{padding:0}
  .card{box-shadow:none;border:1px solid #ddd}
}


/* v7: better cards + grouping */
.quickGrid{
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap:12px;
}
@media (max-width: 1200px){ .quickGrid{grid-template-columns: repeat(3, minmax(0,1fr))} }
@media (max-width: 920px){ .quickGrid{grid-template-columns: repeat(2, minmax(0,1fr))} }
@media (max-width: 520px){ .quickGrid{grid-template-columns: 1fr} }

.groupHeader{
  grid-column: 1 / -1;
  border:1px solid var(--line);
  background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.20));
  border-radius: 18px;
  padding: 10px 12px;
}
[data-theme="dark"] .groupHeader{
  background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
}
.groupHeaderInner{display:flex;align-items:baseline;justify-content:space-between;gap:10px}
.groupTitle{font-weight:950;letter-spacing:.2px}
.groupSub{font-size:12px;color:var(--muted)}

/* Card v7 */
.cardLinkV7{
  position:relative;
  overflow:hidden;
}
.cardLinkV7::before{
  content:"";
  position:absolute;inset:-1px;
  background: radial-gradient(520px 220px at 20% 0%, rgba(0,0,0,.10), transparent 60%);
  opacity:.25;
  pointer-events:none;
}
[data-theme="dark"] .cardLinkV7::before{
  background: radial-gradient(520px 220px at 20% 0%, rgba(255,255,255,.14), transparent 60%);
  opacity:.35;
}
.cardLinkV7{
  border-radius: 20px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.52), rgba(255,255,255,.26));
  box-shadow: 0 12px 34px rgba(0,0,0,.08);
}
[data-theme="dark"] .cardLinkV7{
  background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  box-shadow: 0 18px 52px rgba(0,0,0,.62);
}
.cardLinkV7:hover{
  transform: translateY(-2px);
  box-shadow: 0 20px 52px rgba(0,0,0,.12);
}
[data-theme="dark"] .cardLinkV7:hover{box-shadow: 0 26px 70px rgba(0,0,0,.70);}

.cardIconV7{
  background: linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.03));
  border-radius: 14px;
}
[data-theme="dark"] .cardIconV7{
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
}

.cardTitle{
  font-size: 13.5px;
  letter-spacing:.1px;
}
.cardDesc{
  display:-webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  overflow:hidden;
  text-overflow: ellipsis;
}

.cardMetaRow{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}
.chipMini{
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.52);
  color: rgba(15,15,16,.86);
  font-weight: 800;
}
[data-theme="dark"] .chipMini{
  background: rgba(255,255,255,.06);
  color: rgba(242,242,242,.86);
}
.chipMiniSoft{
  font-weight: 700;
  color: var(--muted);
  background: rgba(255,255,255,.40);
}
[data-theme="dark"] .chipMiniSoft{background: rgba(255,255,255,.05);}

/* TOC arrow */
.tocArrow{
  margin-left:auto;
  opacity:.55;
  font-weight:900;
}

/* Slightly more depth in hero */
.hero{
  border-bottom: 1px solid var(--line);
}


/* v8: richer visuals + content blocks */
.cardLinkV7{
  border: 1px solid rgba(255,255,255,.0);
  background:
    radial-gradient(800px 260px at 10% 0%, rgba(0,0,0,.08), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.56), rgba(255,255,255,.24));
}
[data-theme="dark"] .cardLinkV7{
  border: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(800px 260px at 10% 0%, rgba(255,255,255,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
}
.cardLinkV7 .spark{
  position:absolute; inset:-60px -60px auto auto;
  width:220px; height:220px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.70), transparent 60%);
  opacity:.0; transform: translate(14px,-8px) rotate(12deg);
  transition: opacity .18s ease, transform .18s ease;
  pointer-events:none;
  filter: blur(0.2px);
}
[data-theme="dark"] .cardLinkV7 .spark{
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 60%);
}
.cardLinkV7:hover .spark{opacity:.55; transform: translate(0,0) rotate(0deg);}
@media (prefers-reduced-motion: reduce){ .cardLinkV7 .spark{transition:none} }

.cardLinkV7:hover .cardIconV7{transform: translateY(-1px);}
.cardIconV7{transition:transform .12s ease}

.implWrap{
  margin: 10px 0 0 0;
  padding: 12px 12px;
  border: 1px solid var(--line);
  border-radius: 18px;
  background: rgba(255,255,255,.26);
}
[data-theme="dark"] .implWrap{background: rgba(255,255,255,.04);}
.implTitle{
  font-size:12px; letter-spacing:.14em; text-transform:uppercase;
  color: var(--muted);
  margin-bottom:10px;
}
.implGrid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap:10px;
}
@media (max-width: 1100px){ .implGrid{grid-template-columns: repeat(2, minmax(0,1fr))} }
@media (max-width: 560px){ .implGrid{grid-template-columns: 1fr} }
.implCol{
  border:1px solid var(--line);
  border-radius: 16px;
  padding: 10px 10px;
  background: rgba(255,255,255,.30);
}
[data-theme="dark"] .implCol{background: rgba(255,255,255,.05);}
.implH{
  display:flex; gap:8px; align-items:center;
  font-weight: 950;
  margin-bottom:8px;
}
.implH svg{opacity:.75}
.implList{
  margin:0; padding-left:18px;
  display:grid; gap:6px;
  color: rgba(15,15,16,.86);
  line-height:1.5;
}
[data-theme="dark"] .implList{color: rgba(242,242,242,.86);}

.ctxBullets{
  margin: 10px 0 0 0;
  padding-left: 18px;
  display:grid;
  gap:6px;
  color: var(--muted);
  font-size: 12px;
  line-height: 1.45;
}
.ctxProg{
  margin-top:10px;
  height:8px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.34);
  overflow:hidden;
}
[data-theme="dark"] .ctxProg{background: rgba(255,255,255,.05);}
.ctxProgBar{
  height:100%;
  width:0%;
  background: var(--accent);
  opacity:.55;
}

/* section header accent */
.section h2{
  position:relative;
  padding-left: 12px;
}
.section h2::before{
  content:"";
  position:absolute; left:0; top:8px;
  width:4px; height: 18px;
  border-radius: 999px;
  background: var(--accent);
  opacity:.35;
}


/* v9: more design depth + tour + DoD + storage */
.hero{
  position:relative;
}
.hero::after{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(720px 360px at 72% 10%, rgba(0,0,0,.10), transparent 62%),
    radial-gradient(620px 340px at 18% 90%, rgba(0,0,0,.06), transparent 60%);
  opacity:.35;
  pointer-events:none;
}
[data-theme="dark"] .hero::after{
  background:
    radial-gradient(720px 360px at 72% 10%, rgba(255,255,255,.14), transparent 62%),
    radial-gradient(620px 340px at 18% 90%, rgba(255,255,255,.08), transparent 60%);
  opacity:.40;
}

/* Tour bar */
.tourBar{
  margin-top:14px;
  display:flex; flex-wrap:wrap;
  gap:10px;
  align-items:center;
  padding:10px 10px;
  border-radius:18px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.26);
}
[data-theme="dark"] .tourBar{background: rgba(255,255,255,.05);}
.tourTitle{font-weight:950}
.tourBtns{display:flex;flex-wrap:wrap;gap:8px}
.tourBtn{
  appearance:none;border:1px solid var(--line);
  background: rgba(255,255,255,.48);
  border-radius:999px;
  padding:8px 10px;
  font-size:12px;
  font-weight:900;
  cursor:pointer;
}
[data-theme="dark"] .tourBtn{background: rgba(255,255,255,.06);}
.tourBtn.active{background: var(--accentSoft);}
.tourChip{
  margin-left:auto;
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.44);
  color: var(--muted);
}
[data-theme="dark"] .tourChip{background: rgba(255,255,255,.06);}

/* Cards: mini flow, start label */
.cardLinkV7{
  padding:12px 12px 14px 12px;
}
.cardLinkV7 .miniFlow{
  margin-top:10px;
  width:100%;
  opacity:.70;
}
.cardLinkV7:hover .miniFlow{opacity:.92}
.cardStart{
  position:absolute;
  right:12px; bottom:10px;
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.56);
  color: rgba(15,15,16,.78);
  font-weight:950;
  opacity:.78;
}
[data-theme="dark"] .cardStart{
  background: rgba(255,255,255,.06);
  color: rgba(242,242,242,.80);
}
.cardLinkV7:hover .cardStart{opacity:1}

/* DoD box */
.dodBox{
  margin-top:14px;
  border:1px solid var(--line);
  border-radius:18px;
  background: rgba(255,255,255,.22);
  padding:12px 12px;
}
[data-theme="dark"] .dodBox{background: rgba(255,255,255,.05);}
.dodTitle{
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color: var(--muted);
  margin-bottom:8px;
}
.dodList{
  margin:0;
  padding-left:18px;
  display:grid;
  gap:6px;
  line-height:1.55;
}

/* Storage details */
.storageDetails{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:16px;
  background: rgba(255,255,255,.18);
  padding:10px 12px;
}
[data-theme="dark"] .storageDetails{background: rgba(255,255,255,.04);}
.storageDetails summary{
  cursor:pointer;
  font-weight:950;
}
.storageGrid{
  margin-top:10px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:10px;
}
@media (max-width: 980px){ .storageGrid{grid-template-columns:1fr} }
.storageCell{
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 10px;
  background: rgba(255,255,255,.24);
}
[data-theme="dark"] .storageCell{background: rgba(255,255,255,.05);}
.storageK{
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color: var(--muted);
  margin-bottom:6px;
}
.storageV{line-height:1.55}

/* Slightly richer typography */
.content{padding: clamp(18px, 2.8vw, 28px)}
.section h2{font-size:24px}
.section .lead{font-size:15px; line-height:1.9}


/* v10: stronger draft polish, more structure */
:root{
  --core: rgba(0,0,0,.82);
  --gameplay: rgba(0,0,0,.70);
  --ops: rgba(0,0,0,.64);
  --business: rgba(0,0,0,.58);
}
[data-theme="dark"]{
  --core: rgba(255,255,255,.92);
  --gameplay: rgba(255,255,255,.86);
  --ops: rgba(255,255,255,.82);
  --business: rgba(255,255,255,.78);
}

/* Group badge on cards */
.groupBadge{
  position:absolute;
  left:12px; bottom:10px;
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.44);
  color: var(--muted);
  font-weight:950;
  opacity:.82;
}
[data-theme="dark"] .groupBadge{background: rgba(255,255,255,.06);}
.groupBadge-core{color: rgba(15,15,16,.85);}
.groupBadge-gameplay{color: rgba(15,15,16,.75);}
.groupBadge-ops{color: rgba(15,15,16,.70);}
.groupBadge-business{color: rgba(15,15,16,.66);}
[data-theme="dark"] .groupBadge-core{color: rgba(242,242,242,.90);}
[data-theme="dark"] .groupBadge-gameplay{color: rgba(242,242,242,.86);}
[data-theme="dark"] .groupBadge-ops{color: rgba(242,242,242,.82);}
[data-theme="dark"] .groupBadge-business{color: rgba(242,242,242,.78);}

/* Tour + CTA */
.groupLegend{margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.legendTitle{font-size:12px; letter-spacing:.14em; text-transform:uppercase; color:var(--muted)}
.legendRow{display:flex; gap:8px; flex-wrap:wrap}
.legendPill{
  font-size:11px; padding:6px 10px; border-radius:999px; border:1px solid var(--line);
  background: rgba(255,255,255,.44); color: var(--muted); font-weight:900;
}
[data-theme="dark"] .legendPill{background: rgba(255,255,255,.06);}
.legend-core{color: var(--core)}
.legend-gameplay{color: var(--gameplay)}
.legend-ops{color: var(--ops)}
.legend-business{color: var(--business)}

.startCTA{
  margin-top:12px;
  border:1px solid var(--line);
  border-radius: 18px;
  background: rgba(255,255,255,.24);
  padding: 12px 12px;
  display:grid;
  gap:10px;
}
[data-theme="dark"] .startCTA{background: rgba(255,255,255,.05);}
.ctaH{font-weight:950}
.ctaP{color:var(--muted); line-height:1.55; font-size:12.5px}
.ctaActions{display:flex; flex-wrap:wrap; gap:8px}
.ctaBtn{
  appearance:none; border:1px solid var(--line);
  border-radius:999px;
  padding:9px 12px;
  background: rgba(255,255,255,.56);
  font-weight:950;
  cursor:pointer;
}
[data-theme="dark"] .ctaBtn{background: rgba(255,255,255,.06); color: rgba(242,242,242,.9);}
.ctaBtn.ghost{background: rgba(255,255,255,.34); font-weight:900; color: var(--muted)}
[data-theme="dark"] .ctaBtn.ghost{background: rgba(255,255,255,.05);}

/* MVP rules */
.mvpRules{
  margin: 12px 0 12px 0;
  border:1px solid var(--line);
  border-radius: 18px;
  background: rgba(255,255,255,.22);
  padding: 12px 12px;
}
[data-theme="dark"] .mvpRules{background: rgba(255,255,255,.05);}
.mvpRulesTitle{
  font-size:12px; letter-spacing:.14em; text-transform:uppercase; color:var(--muted);
  margin-bottom:8px;
}
.mvpRulesList{
  margin:0; padding-left:18px; display:grid; gap:6px; line-height:1.6;
}

/* Related */
.relatedBox{
  margin-top:12px;
  border:1px solid var(--line);
  border-radius: 18px;
  background: rgba(255,255,255,.20);
  padding: 12px 12px;
}
[data-theme="dark"] .relatedBox{background: rgba(255,255,255,.05);}
.relatedTitle{
  font-size:12px; letter-spacing:.14em; text-transform:uppercase; color:var(--muted);
  margin-bottom:8px;
}
.relatedRow{
  display:flex; flex-wrap:wrap; gap:8px;
}
.relatedLink{
  display:inline-flex;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.42);
  text-decoration:none;
  font-size:12px;
  font-weight:900;
}
[data-theme="dark"] .relatedLink{background: rgba(255,255,255,.06);}
.relatedLink:hover{background: rgba(255,255,255,.66)}
[data-theme="dark"] .relatedLink:hover{background: rgba(255,255,255,.10)}

/* Section group accent (subtle) */
.section[data-group="core"] .sectionMeta .metaBox{outline:1px solid rgba(0,0,0,.08)}
.section[data-group="gameplay"] .sectionMeta .metaBox{outline:1px solid rgba(0,0,0,.06)}
.section[data-group="ops"] .sectionMeta .metaBox{outline:1px solid rgba(0,0,0,.05)}
.section[data-group="business"] .sectionMeta .metaBox{outline:1px solid rgba(0,0,0,.04)}
[data-theme="dark"] .section[data-group="core"] .sectionMeta .metaBox{outline:1px solid rgba(255,255,255,.10)}
[data-theme="dark"] .section[data-group="gameplay"] .sectionMeta .metaBox{outline:1px solid rgba(255,255,255,.08)}
[data-theme="dark"] .section[data-group="ops"] .sectionMeta .metaBox{outline:1px solid rgba(255,255,255,.07)}
[data-theme="dark"] .section[data-group="business"] .sectionMeta .metaBox{outline:1px solid rgba(255,255,255,.06)}

/* Fix card bottom labels not overlapping on small screens */
@media (max-width: 520px){
  .cardStart{display:none}
  .groupBadge{position:static; margin-top:10px}
}


/* v11: richer cards + dev copy actions */
.cardLinkV7{
  border-radius: 22px;
}
.cardLinkV7 .miniFlow{margin-top:10px; opacity:.78}
.cardLinkV7:hover .miniFlow{opacity:1}
.miniFlowCore{transform: translateY(1px)}
.miniFlowGameplay{transform: translateY(0px)}
.miniFlowOps{transform: translateY(1px)}
.miniFlowBusiness{transform: translateY(2px)}

.copyBtn{
  margin-left:auto;
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.50);
  cursor:pointer;
  font-weight:900;
  color: var(--muted);
}
[data-theme="dark"] .copyBtn{background: rgba(255,255,255,.06);}
.copyBtn:hover{background: rgba(255,255,255,.72)}
[data-theme="dark"] .copyBtn:hover{background: rgba(255,255,255,.10)}

.rwTag{
  margin-top:8px;
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  display:inline-flex;
  background: rgba(255,255,255,.38);
  color: var(--muted);
  font-weight:900;
}
[data-theme="dark"] .rwTag{background: rgba(255,255,255,.06);}

.devActions{
  margin-top:12px;
  border:1px solid var(--line);
  border-radius: 18px;
  background: rgba(255,255,255,.22);
  padding: 12px 12px;
}
[data-theme="dark"] .devActions{background: rgba(255,255,255,.05);}
.devActionsTitle{
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color: var(--muted);
  margin-bottom:8px;
}
.devActionsSub{color: var(--muted); font-size:12px; line-height:1.5; margin-bottom:10px}
.devActionsRow{display:flex; gap:8px; flex-wrap:wrap}
.devActionBtn{
  flex:1 1 auto;
  border:1px solid var(--line);
  border-radius: 14px;
  padding:10px 12px;
  background: rgba(255,255,255,.56);
  font-weight:950;
  cursor:pointer;
}
[data-theme="dark"] .devActionBtn{background: rgba(255,255,255,.06); color: rgba(242,242,242,.9);}
.devActionBtn:hover{background: rgba(255,255,255,.78)}
[data-theme="dark"] .devActionBtn:hover{background: rgba(255,255,255,.10)}

/* nicer focus for copied */
.toast{
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%);
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.78);
  color: rgba(15,15,16,.86);
  font-weight:950;
  z-index: 9999;
  box-shadow: 0 14px 48px rgba(0,0,0,.16);
}
[data-theme="dark"] .toast{
  background: rgba(20,20,22,.85);
  color: rgba(242,242,242,.86);
  box-shadow: 0 18px 58px rgba(0,0,0,.72);
}


/* v12: diagrams */
.heroGalleryBtn{
  display:inline-flex;
  margin-top:12px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.56);
  text-decoration:none;
  font-weight:950;
}
[data-theme="dark"] .heroGalleryBtn{background: rgba(255,255,255,.06);}
.heroGalleryBtn:hover{background: rgba(255,255,255,.78)}
[data-theme="dark"] .heroGalleryBtn:hover{background: rgba(255,255,255,.10)}

.diagramPanel{
  margin: 12px 0 14px 0;
  border:1px solid var(--line);
  border-radius: 20px;
  background: rgba(255,255,255,.20);
  overflow:hidden;
}
[data-theme="dark"] .diagramPanel{background: rgba(255,255,255,.05);}
.diagramHead{
  padding: 12px 12px 10px 12px;
  display:flex; flex-wrap:wrap; gap:10px;
  align-items:baseline;
  border-bottom:1px solid var(--line);
}
.diagramTitle{font-weight:950}
.diagramSub{color:var(--muted); font-size:12px}

.diagramTabs{
  padding: 10px 12px;
  display:flex; gap:8px; flex-wrap:wrap;
  border-bottom:1px solid var(--line);
}
.diagramTab{
  border:1px solid var(--line);
  border-radius: 999px;
  padding:8px 10px;
  background: rgba(255,255,255,.50);
  cursor:pointer;
  font-weight:950;
}
[data-theme="dark"] .diagramTab{background: rgba(255,255,255,.06); color: rgba(242,242,242,.9)}
.diagramTab.active{background: var(--accentSoft);}

.diagramBody{padding: 12px 12px}
.diagramPane{display:none}
.diagramPane.active{display:block}
.diagSvg{
  width: 100%;
  height: 260px;
  border-radius: 16px;
  border:1px solid var(--line);
  background:
    radial-gradient(520px 220px at 18% 10%, rgba(0,0,0,.08), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.42), rgba(255,255,255,.18));
}
[data-theme="dark"] .diagSvg{
  background:
    radial-gradient(520px 220px at 18% 10%, rgba(255,255,255,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
}

/* Gallery */
.galleryGrid{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:10px;
}
@media (max-width: 980px){ .galleryGrid{grid-template-columns:1fr} }
.galleryCard{
  border:1px solid var(--line);
  border-radius: 18px;
  background: rgba(255,255,255,.24);
  padding: 12px 12px;
  text-decoration:none;
}
[data-theme="dark"] .galleryCard{background: rgba(255,255,255,.05);}
.galleryCard:hover{background: rgba(255,255,255,.38)}
[data-theme="dark"] .galleryCard:hover{background: rgba(255,255,255,.08);}
.galleryK{font-weight:950}
.galleryV{color:var(--muted); font-size:12px; margin-top:4px}


/* v13: export controls + sequence support */
.diagSvg{height: 300px;}
@media (max-width: 520px){ .diagSvg{height: 340px;} }

.diagExport{
  margin-left:auto;
  display:flex;
  gap:8px;
  align-items:center;
}
.diagExportBtn{
  border:1px solid var(--line);
  border-radius: 999px;
  padding: 8px 10px;
  background: rgba(255,255,255,.52);
  cursor:pointer;
  font-weight: 950;
  font-size: 12px;
}
[data-theme="dark"] .diagExportBtn{background: rgba(255,255,255,.06); color: rgba(242,242,242,.9);}
.diagExportBtn:hover{background: rgba(255,255,255,.78);}
[data-theme="dark"] .diagExportBtn:hover{background: rgba(255,255,255,.10);}

/* Make tabs wrap nicely */
.diagramTabs{justify-content:flex-start}


/* v14: tasteful color accents */
:root{
  --c-core: rgba(87, 166, 255, 1);
  --c-game: rgba(168, 132, 255, 1);
  --c-ops: rgba(74, 214, 178, 1);
  --c-biz: rgba(255, 186, 92, 1);
}
.heroHeatBtn{
  display:inline-flex;
  margin-top:12px;
  margin-right:10px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.56);
  text-decoration:none;
  font-weight:950;
}
[data-theme="dark"] .heroHeatBtn{background: rgba(255,255,255,.06);}
.heroHeatBtn:hover{background: rgba(255,255,255,.78)}
[data-theme="dark"] .heroHeatBtn:hover{background: rgba(255,255,255,.10)}

.section[data-group="core"] h2{background: linear-gradient(90deg, rgba(87,166,255,.18), transparent 55%); border-radius: 14px; padding: 8px 10px;}
.section[data-group="gameplay"] h2{background: linear-gradient(90deg, rgba(168,132,255,.18), transparent 55%); border-radius: 14px; padding: 8px 10px;}
.section[data-group="ops"] h2{background: linear-gradient(90deg, rgba(74,214,178,.16), transparent 55%); border-radius: 14px; padding: 8px 10px;}
.section[data-group="business"] h2{background: linear-gradient(90deg, rgba(255,186,92,.16), transparent 55%); border-radius: 14px; padding: 8px 10px;}

.diagSvg{
  background:
    radial-gradient(520px 240px at 16% 10%, rgba(87,166,255,.10), transparent 60%),
    radial-gradient(520px 240px at 76% 10%, rgba(168,132,255,.08), transparent 60%),
    radial-gradient(520px 240px at 46% 92%, rgba(74,214,178,.08), transparent 62%),
    linear-gradient(180deg, rgba(255,255,255,.44), rgba(255,255,255,.14));
}
[data-theme="dark"] .diagSvg{
  background:
    radial-gradient(520px 240px at 16% 10%, rgba(87,166,255,.14), transparent 60%),
    radial-gradient(520px 240px at 76% 10%, rgba(168,132,255,.12), transparent 60%),
    radial-gradient(520px 240px at 46% 92%, rgba(74,214,178,.10), transparent 62%),
    linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
}

/* Glossary cards */
.glossGrid{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap:10px;
}
@media (max-width: 980px){ .glossGrid{grid-template-columns:1fr} }
.glossCard{
  border:1px solid var(--line);
  border-radius:18px;
  background: rgba(255,255,255,.22);
  padding:12px 12px;
}
[data-theme="dark"] .glossCard{background: rgba(255,255,255,.05);}
.glossK{font-weight:950}
.glossV{color:var(--muted); font-size:12px; line-height:1.55; margin-top:6px}

/* Heatmap */
.heatWrap{
  margin-top:12px;
  display:grid;
  grid-template-columns: 1.6fr 1fr;
  gap:12px;
}
@media (max-width: 1100px){ .heatWrap{grid-template-columns:1fr} }
.heatGrid{
  border:1px solid var(--line);
  border-radius: 20px;
  overflow:auto;
  background: rgba(255,255,255,.18);
  display:grid;
  grid-template-columns: 200px repeat(11, minmax(120px, 1fr));
  min-height: 520px;
}
[data-theme="dark"] .heatGrid{background: rgba(255,255,255,.05);}

.heatCorner{
  position: sticky;
  left:0; top:0;
  background: rgba(255,255,255,.42);
  border-bottom:1px solid var(--line);
  border-right:1px solid var(--line);
  z-index: 3;
}
[data-theme="dark"] .heatCorner{background: rgba(255,255,255,.06);}

.heatHead{
  padding:10px 10px;
  font-weight:950;
  font-size:12px;
  color: rgba(0,0,0,.68);
  background: rgba(255,255,255,.42);
  border-bottom:1px solid var(--line);
  border-right:1px solid var(--line);
  position: sticky;
  z-index: 2;
}
[data-theme="dark"] .heatHead{color: rgba(242,242,242,.80); background: rgba(255,255,255,.06);}
.heatCol{top:0}
.heatRow{left:0; z-index: 2}
.heatHead.isHi{background: rgba(255,255,255,.70)}
[data-theme="dark"] .heatHead.isHi{background: rgba(255,255,255,.10)}

.heatCell{
  border-right:1px solid var(--line);
  border-bottom:1px solid var(--line);
  min-height: 44px;
  padding:8px 8px;
  font-weight: 950;
  cursor:pointer;
  text-align:center;
  background: rgba(255,255,255,.14);
}
[data-theme="dark"] .heatCell{background: rgba(255,255,255,.03); color: rgba(242,242,242,.86);}
.heatCell:hover{outline:2px solid rgba(0,0,0,.18); outline-offset:-2px;}
[data-theme="dark"] .heatCell:hover{outline:2px solid rgba(255,255,255,.14);}

.heatCell.w0{background: rgba(255,255,255,.06)}
.heatCell.w1{background: rgba(87,166,255,.12)}
.heatCell.w2{background: rgba(168,132,255,.12)}
.heatCell.w3{background: rgba(74,214,178,.14)}
.heatCell.w4{background: rgba(255,186,92,.16)}
[data-theme="dark"] .heatCell.w0{background: rgba(255,255,255,.02)}
[data-theme="dark"] .heatCell.w1{background: rgba(87,166,255,.18)}
[data-theme="dark"] .heatCell.w2{background: rgba(168,132,255,.18)}
[data-theme="dark"] .heatCell.w3{background: rgba(74,214,178,.18)}
[data-theme="dark"] .heatCell.w4{background: rgba(255,186,92,.20)}

.heatCell.isSel{outline: 3px solid rgba(0,0,0,.24); outline-offset:-3px;}
[data-theme="dark"] .heatCell.isSel{outline: 3px solid rgba(255,255,255,.18);}

.heatPanel{
  border:1px solid var(--line);
  border-radius: 20px;
  background: rgba(255,255,255,.22);
  padding:12px 12px;
  position: sticky;
  top: 14px;
  height: fit-content;
}
[data-theme="dark"] .heatPanel{background: rgba(255,255,255,.05);}
.heatPanelTitle{font-weight:950}
.heatPanelSub{color:var(--muted); font-size:12px; line-height:1.55; margin-top:6px}
.heatPanelBody{margin-top:12px; border:1px solid var(--line); border-radius: 18px; padding:12px 12px; background: rgba(255,255,255,.18)}
[data-theme="dark"] .heatPanelBody{background: rgba(255,255,255,.04);}
.heatK{font-weight:950}
.heatV{color:var(--muted); line-height:1.6; margin-top:8px}

.heatLegend{margin-top:12px}
.heatLegendTitle{font-size:12px; letter-spacing:.14em; text-transform:uppercase; color:var(--muted); margin-bottom:8px}
.heatLegendRow{display:flex; gap:8px; flex-wrap:wrap}
.heatLegendPill{
  border:1px solid var(--line);
  border-radius: 999px;
  padding:6px 10px;
  font-weight:950;
  background: rgba(255,255,255,.18);
}
[data-theme="dark"] .heatLegendPill{background: rgba(255,255,255,.05);}
.heatLegendPill.w1{background: rgba(87,166,255,.12)}
.heatLegendPill.w2{background: rgba(168,132,255,.12)}
.heatLegendPill.w3{background: rgba(74,214,178,.14)}
.heatLegendPill.w4{background: rgba(255,186,92,.16)}


/* v15: heatmap alignment + controls + graph view */
.heatControls{
  margin-top: 12px;
  border: 1px solid var(--line);
  border-radius: 20px;
  padding: 12px 12px;
  background: rgba(255,255,255,.22);
}
[data-theme="dark"] .heatControls{background: rgba(255,255,255,.05);}
.heatControlsRow{
  display:flex;
  gap: 10px;
  align-items:center;
  flex-wrap: wrap;
  justify-content: space-between;
}
.heatToggleGroup{
  display:flex;
  gap: 8px;
  align-items:center;
  padding: 6px 6px;
  border: 1px solid var(--line);
  border-radius: 999px;
  background: rgba(255,255,255,.14);
}
[data-theme="dark"] .heatToggleGroup{background: rgba(255,255,255,.04);}
.heatViewBtn, .heatTypeBtn{
  border: 1px solid transparent;
  background: transparent;
  padding: 8px 10px;
  border-radius: 999px;
  font-weight: 950;
  cursor: pointer;
  color: rgba(0,0,0,.72);
}
[data-theme="dark"] .heatViewBtn, [data-theme="dark"] .heatTypeBtn{color: rgba(242,242,242,.84);}
.heatViewBtn.isOn{background: rgba(87,166,255,.16); border-color: rgba(87,166,255,.24);}
.heatTypeBtn.isOn[data-type="data"]{background: rgba(87,166,255,.16); border-color: rgba(87,166,255,.24);}
.heatTypeBtn.isOn[data-type="events"]{background: rgba(168,132,255,.16); border-color: rgba(168,132,255,.24);}
.heatTypeBtn.isOn[data-type="ux"]{background: rgba(74,214,178,.16); border-color: rgba(74,214,178,.24);}
.heatViewBtn:hover,.heatTypeBtn:hover{background: rgba(255,255,255,.26)}
[data-theme="dark"] .heatViewBtn:hover,[data-theme="dark"] .heatTypeBtn:hover{background: rgba(255,255,255,.06)}

.heatRange{display:flex; align-items:center; gap:10px; flex-wrap: wrap;}
.heatRangeLabel{font-weight:950}
.heatRangeInput{width: 220px; accent-color: rgba(87,166,255,.9);}
.heatRangeValue{font-weight:950; color: var(--muted);}
.heatCheck{display:flex; align-items:center; gap:10px; font-weight: 900; color: rgba(0,0,0,.70)}
[data-theme="dark"] .heatCheck{color: rgba(242,242,242,.82);}
.heatHint{color: var(--muted); font-size:12px; margin-left:auto}

/* Fix grid "crooked" look: explicit row/col sizes and centering */
.heatGrid{
  --rowHeadW: 220px;
  --colW: 140px;
  --cellH: 46px;
  grid-template-columns: var(--rowHeadW) repeat(11, var(--colW));
  grid-auto-rows: var(--cellH);
  align-items: stretch;
}
@media (max-width: 720px){
  .heatGrid{ --rowHeadW: 180px; --colW: 130px; }
}
.heatHead, .heatCell, .heatCorner{
  display:flex;
  align-items:center;
  justify-content:center;
  box-sizing:border-box;
}
.heatHead{line-height:1.15; text-align:center;}
.heatCol{height: var(--cellH);}
.heatRow{justify-content:flex-start; padding-left: 12px; text-align:left;}
.heatCell{height: var(--cellH);}
.heatCorner{height: var(--cellH);}

/* Prevent header text from pushing heights */
.heatHead{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.heatHead:hover{white-space: normal;}

/* Subtle crosshair glow on hover */
.heatGrid:hover .heatHead.isHi{box-shadow: inset 0 0 0 2px rgba(0,0,0,.08);}
[data-theme="dark"] .heatGrid:hover .heatHead.isHi{box-shadow: inset 0 0 0 2px rgba(255,255,255,.10);}

/* Filtered cells */
.heatCell.isDim{
  opacity: .28;
  filter: saturate(.55);
}
.heatCell.isDim:hover{outline: none;}

/* Graph view */
.heatGraphWrap{
  border:1px solid var(--line);
  border-radius: 20px;
  background: rgba(255,255,255,.18);
  padding: 12px 12px;
}
[data-theme="dark"] .heatGraphWrap{background: rgba(255,255,255,.04);}
.heatGraphHead{display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap: wrap;}
.heatGraphTitle{font-weight: 950;}
.heatGraphSub{color: var(--muted); font-size: 12px;}
.heatGraphCanvas{
  margin-top: 10px;
  border: 1px solid var(--line);
  border-radius: 18px;
  min-height: 520px;
  background:
    radial-gradient(680px 320px at 22% 18%, rgba(87,166,255,.10), transparent 60%),
    radial-gradient(680px 320px at 78% 18%, rgba(168,132,255,.08), transparent 60%),
    radial-gradient(680px 320px at 50% 86%, rgba(74,214,178,.08), transparent 62%),
    linear-gradient(180deg, rgba(255,255,255,.36), rgba(255,255,255,.10));
  overflow: hidden;
  position: relative;
}
[data-theme="dark"] .heatGraphCanvas{
  background:
    radial-gradient(680px 320px at 22% 18%, rgba(87,166,255,.14), transparent 60%),
    radial-gradient(680px 320px at 78% 18%, rgba(168,132,255,.12), transparent 60%),
    radial-gradient(680px 320px at 50% 86%, rgba(74,214,178,.10), transparent 62%),
    linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
}
.heatGraphSvg{width:100%; height: 520px; display:block;}
@media (max-width: 1100px){ .heatGraphSvg{height: 460px;} }
.heatNode{
  cursor: pointer;
}
.heatNodeLabel{font-weight: 950; font-size: 11px; fill: currentColor; fill-opacity: .82;}
.heatEdge{
  cursor: pointer;
}

/* v15 polish: rules card highlight */
.mvpRules{
  border-top: 3px solid rgba(74,214,178,.45);
}
[data-theme="dark"] .mvpRules{border-top:3px solid rgba(74,214,178,.55);}


/* v16: heatmap polish + search + focus + responsive left column */
.heatWrap{
  grid-template-columns: 1.55fr 1fr;
}
.heatLeft{
  display:block;
  min-width: 0;
}
@media (max-width: 1100px){
  .heatWrap{grid-template-columns: 1fr;}
  .heatPanel{position: static;}
}

/* Controls row 3 */
.heatControlsRow3{
  align-items: flex-start;
}
.heatSearch{
  display:flex;
  flex-direction: column;
  gap:8px;
  min-width: 280px;
  flex: 1 1 360px;
}
.heatSearchLabel{font-weight:950}
.heatSearchInput{
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 10px 12px;
  background: rgba(255,255,255,.22);
  outline: none;
  font-weight: 850;
}
[data-theme="dark"] .heatSearchInput{background: rgba(255,255,255,.05); color: rgba(242,242,242,.86);}
.heatSearchInput:focus{box-shadow: 0 0 0 4px rgba(87,166,255,.12); border-color: rgba(87,166,255,.35);}

.heatSearchActions{
  display:flex;
  gap:8px;
  flex-wrap: wrap;
}
.heatFocusBtn,.heatClearBtn{
  border: 1px solid var(--line);
  border-radius: 999px;
  padding: 10px 12px;
  font-weight: 950;
  cursor:pointer;
  background: rgba(255,255,255,.18);
}
[data-theme="dark"] .heatFocusBtn, [data-theme="dark"] .heatClearBtn{background: rgba(255,255,255,.05); color: rgba(242,242,242,.86);}
.heatFocusBtn.isOn{background: rgba(255,186,92,.16); border-color: rgba(255,186,92,.28);}
.heatClearBtn:hover,.heatFocusBtn:hover{background: rgba(255,255,255,.26)}
[data-theme="dark"] .heatClearBtn:hover,[data-theme="dark"] .heatFocusBtn:hover{background: rgba(255,255,255,.08)}

/* Legend explain */
.heatLegendExplain{
  flex: 1 1 420px;
  border: 1px solid var(--line);
  border-radius: 18px;
  padding: 10px 10px;
  background: rgba(255,255,255,.14);
}
[data-theme="dark"] .heatLegendExplain{background: rgba(255,255,255,.04);}
.heatLegendExplainTitle{
  font-weight: 950;
  margin-bottom: 8px;
}
.heatLegendExplainRow{
  display:flex;
  gap:8px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}
.heatLegendChip{
  border: 1px solid var(--line);
  border-radius: 999px;
  padding: 8px 10px;
  font-weight: 950;
  cursor:pointer;
  background: rgba(255,255,255,.18);
}
[data-theme="dark"] .heatLegendChip{background: rgba(255,255,255,.05); color: rgba(242,242,242,.86);}
.heatLegendChip[data-chip="data"]{box-shadow: inset 0 0 0 1px rgba(87,166,255,.18);}
.heatLegendChip[data-chip="events"]{box-shadow: inset 0 0 0 1px rgba(168,132,255,.18);}
.heatLegendChip[data-chip="ux"]{box-shadow: inset 0 0 0 1px rgba(74,214,178,.18);}
.heatLegendChip.isOn{background: rgba(87,166,255,.10);}
.heatLegendExplainText{
  display:grid;
  grid-template-columns: 1fr;
  gap: 6px;
  color: var(--muted);
  font-size: 12px;
  line-height: 1.55;
}
.heatLegendExplainItem{
  border: 1px dashed rgba(0,0,0,.08);
  border-radius: 14px;
  padding: 8px 10px;
  background: rgba(255,255,255,.10);
}
[data-theme="dark"] .heatLegendExplainItem{border-color: rgba(255,255,255,.10); background: rgba(255,255,255,.03);}

/* Matrix: make sticky headers feel sturdier */
.heatGrid{
  box-shadow: 0 18px 40px rgba(0,0,0,.08);
}
[data-theme="dark"] .heatGrid{box-shadow: 0 18px 40px rgba(0,0,0,.22);}
.heatHead.heatCol{
  backdrop-filter: blur(10px);
}
.heatHead.heatRow{
  backdrop-filter: blur(10px);
}

/* Selected focus mode */
.heatGrid.isFocus .heatCell{opacity: .22;}
.heatGrid.isFocus .heatCell.isFocus{opacity: 1; filter: none;}
.heatGrid.isFocus .heatHead{opacity: .40;}
.heatGrid.isFocus .heatHead.isFocus{opacity: 1;}

/* Graph: nicer nodes and edge labels on hover */
.heatGraphCanvas{
  box-shadow: 0 18px 40px rgba(0,0,0,.08);
}
[data-theme="dark"] .heatGraphCanvas{box-shadow: 0 18px 40px rgba(0,0,0,.22);}
.heatNode circle{
  transition: transform .12s ease, fill-opacity .12s ease;
}
.heatNode:hover circle{transform: scale(1.06); fill-opacity: .16;}
.heatEdge:hover{opacity: 1 !important; stroke-width: calc(var(--sw) + 1px);}


/* v17: autocomplete + graph tools + tooltip + pin states */
.heatSearchInput::-webkit-search-cancel-button{cursor:pointer}
.heatGraphTools{
  display:flex;
  gap:8px;
  flex-wrap: wrap;
}
.heatGraphBtn{
  border:1px solid var(--line);
  border-radius: 999px;
  padding: 8px 10px;
  font-weight: 950;
  cursor:pointer;
  background: rgba(255,255,255,.18);
}
[data-theme="dark"] .heatGraphBtn{background: rgba(255,255,255,.05); color: rgba(242,242,242,.86);}
.heatGraphBtn:hover{background: rgba(255,255,255,.26)}
[data-theme="dark"] .heatGraphBtn:hover{background: rgba(255,255,255,.08);}

.heatGraphNote{
  margin-top:10px;
  color: var(--muted);
  font-size: 12px;
  line-height: 1.55;
}

.heatNode.isPinned circle{
  fill-opacity: .18 !important;
  stroke-opacity: .38 !important;
}
.heatNode.isPinned .heatNodeLabel{
  fill-opacity: .92 !important;
}
.heatTip{
  position:absolute;
  left: 14px;
  top: 14px;
  max-width: 360px;
  border:1px solid var(--line);
  border-radius: 16px;
  background: rgba(255,255,255,.68);
  backdrop-filter: blur(10px);
  padding: 10px 10px;
  box-shadow: 0 18px 40px rgba(0,0,0,.12);
  pointer-events:none;
}
[data-theme="dark"] .heatTip{
  background: rgba(20,20,22,.72);
  box-shadow: 0 18px 40px rgba(0,0,0,.35);
}
.heatTipK{font-weight:950}
.heatTipV{color: var(--muted); font-size:12px; line-height:1.55; margin-top:6px}

/* allow left column to breathe on mid widths */
@media (max-width: 1280px) and (min-width: 1101px){
  .heatWrap{grid-template-columns: 1.35fr 1fr;}
  .heatGrid{--colW: 132px;}
}


/* v18: neighborhood (hops) + copy link + better highlight semantics */
.heatHop{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.heatHopLabel{font-weight:950}
.heatHopSelect{
  border:1px solid var(--line);
  border-radius: 12px;
  padding: 10px 10px;
  background: rgba(255,255,255,.22);
  font-weight: 950;
}
[data-theme="dark"] .heatHopSelect{background: rgba(255,255,255,.05); color: rgba(242,242,242,.86);}
.heatCopyLinkBtn{
  border:1px solid var(--line);
  border-radius: 999px;
  padding: 10px 12px;
  font-weight: 950;
  cursor:pointer;
  background: rgba(255,255,255,.18);
}
[data-theme="dark"] .heatCopyLinkBtn{background: rgba(255,255,255,.05); color: rgba(242,242,242,.86);}
.heatCopyLinkBtn:hover{background: rgba(255,255,255,.26)}
[data-theme="dark"] .heatCopyLinkBtn:hover{background: rgba(255,255,255,.08)}

/* Neighborhood highlight in matrix */
.heatHead.isNear1{box-shadow: inset 0 0 0 2px rgba(87,166,255,.12);}
.heatHead.isNear2{box-shadow: inset 0 0 0 2px rgba(168,132,255,.12);}
.heatCell.isNear1{outline: 2px solid rgba(87,166,255,.14); outline-offset:-2px;}
.heatCell.isNear2{outline: 2px solid rgba(168,132,255,.14); outline-offset:-2px;}
.heatGrid.isFocus .heatCell.isDim{opacity: .10;}

/* Graph labels */
.heatEdgeLabel{
  font-size: 10px;
  font-weight: 950;
  fill: currentColor;
  fill-opacity: .82;
}
.heatEdgePill{
  fill: rgba(255,255,255,.70);
  stroke: rgba(0,0,0,.08);
}
[data-theme="dark"] .heatEdgePill{
  fill: rgba(20,20,22,.70);
  stroke: rgba(255,255,255,.10);
}


/* v19: nicer hops segmented + graph legend + export buttons */
.heatHopSelect.isHidden{display:none}
.heatHopSeg{
  display:inline-flex;
  border:1px solid var(--line);
  border-radius: 999px;
  overflow:hidden;
  background: rgba(255,255,255,.16);
}
[data-theme="dark"] .heatHopSeg{background: rgba(255,255,255,.05);}
.heatHopBtn{
  border:0;
  background: transparent;
  padding: 10px 12px;
  font-weight: 950;
  cursor:pointer;
  min-width: 38px;
}
.heatHopBtn.isOn{
  background: rgba(87,166,255,.14);
}
.heatIso{
  display:flex;
  align-items:center;
  gap:10px;
  margin-left: 10px;
  font-weight: 900;
  user-select:none;
}
.heatIsoInput{width:18px;height:18px; accent-color: rgba(87,166,255,.9);}

.heatGraphToolsV19{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 10px;
}
.heatGraphLegend{
  display:flex;
  align-items:center;
  gap: 8px;
  flex-wrap: wrap;
  border:1px solid var(--line);
  border-radius: 999px;
  padding: 8px 10px;
  background: rgba(255,255,255,.12);
}
[data-theme="dark"] .heatGraphLegend{background: rgba(255,255,255,.04);}
.heatGraphLegendTitle{font-weight: 950; margin-right: 6px;}
.heatPill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width: 22px;
  height: 22px;
  border-radius: 999px;
  border: 1px solid var(--line);
  font-weight: 950;
}
.heatPillD{box-shadow: inset 0 0 0 2px rgba(87,166,255,.22);}
.heatPillE{box-shadow: inset 0 0 0 2px rgba(168,132,255,.22);}
.heatPillU{box-shadow: inset 0 0 0 2px rgba(74,214,178,.22);}
.heatLegendText{color: var(--muted); font-size: 12px; margin-right: 4px;}

.heatGraphBtns{display:flex; gap:8px; flex-wrap:wrap;}
.heatGraphBtnV19{
  border:1px solid var(--line);
  border-radius: 999px;
  padding: 8px 10px;
  font-weight: 950;
  cursor:pointer;
  background: rgba(255,255,255,.18);
}
[data-theme="dark"] .heatGraphBtnV19{background: rgba(255,255,255,.05); color: rgba(242,242,242,.86);}
.heatGraphBtnV19:hover{background: rgba(255,255,255,.26)}
[data-theme="dark"] .heatGraphBtnV19:hover{background: rgba(255,255,255,.08)}


/* v20: true isolate + minimap + presentation mode */
#heatmap.isIsoOn .heatGraphNote{opacity:.95}
.heatMiniMap{
  position:absolute;
  right: 14px;
  top: 14px;
  border:1px solid var(--line);
  border-radius: 16px;
  background: rgba(255,255,255,.62);
  backdrop-filter: blur(10px);
  padding: 10px 10px 8px 10px;
  box-shadow: 0 18px 40px rgba(0,0,0,.14);
}
[data-theme="dark"] .heatMiniMap{background: rgba(20,20,22,.70); box-shadow: 0 18px 40px rgba(0,0,0,.35);}
.heatMiniMapTitle{font-weight:950; font-size:12px; color: var(--muted); margin-bottom: 6px;}
.heatMiniMapSvg{display:block; border-radius: 12px; overflow:hidden; background: rgba(255,255,255,.14);}
[data-theme="dark"] .heatMiniMapSvg{background: rgba(255,255,255,.05);}

.heatPresentBtn{
  position:absolute;
  left: 14px;
  top: 14px;
  border:1px solid var(--line);
  border-radius: 999px;
  padding: 10px 12px;
  font-weight: 950;
  cursor:pointer;
  background: rgba(255,255,255,.18);
}
[data-theme="dark"] .heatPresentBtn{background: rgba(255,255,255,.05); color: rgba(242,242,242,.86);}
.heatPresentBtn:hover{background: rgba(255,255,255,.26)}
[data-theme="dark"] .heatPresentBtn:hover{background: rgba(255,255,255,.08)}

body.isPresent{
  overflow:hidden;
}
body.isPresent .topbar, body.isPresent header, body.isPresent .hero, body.isPresent .toc{
  display:none !important;
}
body.isPresent #heatmap{
  margin-top: 10px !important;
}
body.isPresent .heatWrap{
  max-width: 1400px;
  margin: 0 auto;
}
body.isPresent .heatGraphCanvas{
  height: min(82vh, 920px) !important;
}
body.isPresent .heatGrid{
  max-height: min(78vh, 840px) !important;
}


/* v21: interactive minimap + presentation stepper */
.heatMiniMap{cursor: pointer}
.heatMiniMapSvg{cursor: crosshair}
.heatMiniMapHint{
  margin-top: 6px;
  font-size: 11px;
  color: var(--muted);
}

.heatPresenter{
  position:absolute;
  left: 14px;
  right: 14px;
  bottom: 14px;
  border:1px solid var(--line);
  border-radius: 18px;
  background: rgba(255,255,255,.62);
  backdrop-filter: blur(10px);
  padding: 12px 12px;
  box-shadow: 0 18px 40px rgba(0,0,0,.14);
}
[data-theme="dark"] .heatPresenter{
  background: rgba(20,20,22,.72);
  box-shadow: 0 18px 40px rgba(0,0,0,.35);
}
.heatPresenterTop{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
}
.heatPresenterTitle{font-weight: 950}
.heatPresenterRight{display:flex; gap:8px; flex-wrap:wrap}
.heatPresenterBtn{
  border:1px solid var(--line);
  border-radius: 999px;
  padding: 8px 10px;
  font-weight: 950;
  cursor:pointer;
  background: rgba(255,255,255,.18);
}
[data-theme="dark"] .heatPresenterBtn{background: rgba(255,255,255,.05); color: rgba(242,242,242,.86);}
.heatPresenterBtn:hover{background: rgba(255,255,255,.26)}
[data-theme="dark"] .heatPresenterBtn:hover{background: rgba(255,255,255,.08)}

.heatPresenterMain{
  margin-top: 10px;
  display:grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items:end;
}
.heatPresenterStepK{font-weight: 950; font-size: 14px;}
.heatPresenterStepV{margin-top: 6px; color: var(--muted); line-height: 1.55; font-size: 12px;}
.heatPresenterNav{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
.heatPresenterNavBtn{
  border:1px solid var(--line);
  border-radius: 999px;
  padding: 10px 12px;
  font-weight: 950;
  cursor:pointer;
  background: rgba(255,255,255,.18);
}
[data-theme="dark"] .heatPresenterNavBtn{background: rgba(255,255,255,.05); color: rgba(242,242,242,.86);}
.heatPresenterNavBtn:hover{background: rgba(255,255,255,.26)}
[data-theme="dark"] .heatPresenterNavBtn:hover{background: rgba(255,255,255,.08)}

.heatPresenterList{
  margin-top: 10px;
  border-top: 1px solid var(--line);
  padding-top: 10px;
  max-height: 38vh;
  overflow:auto;
}
.heatPresenterItem{
  display:flex;
  gap:10px;
  padding: 10px 10px;
  border:1px solid var(--line);
  border-radius: 14px;
  background: rgba(255,255,255,.10);
  cursor:pointer;
  margin-bottom: 8px;
}
[data-theme="dark"] .heatPresenterItem{background: rgba(255,255,255,.04);}
.heatPresenterItem:hover{background: rgba(255,255,255,.18)}
[data-theme="dark"] .heatPresenterItem:hover{background: rgba(255,255,255,.07)}
.heatPresenterItemN{
  width: 26px;
  height: 26px;
  border-radius: 999px;
  border: 1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 950;
}
.heatPresenterItemBody{min-width: 0}
.heatPresenterItemK{font-weight: 950; white-space: nowrap; overflow:hidden; text-overflow: ellipsis;}
.heatPresenterItemV{color: var(--muted); font-size: 12px; margin-top: 4px; line-height: 1.45;}

body.isPresent .heatPresenter{display:block}
body.isPresent .heatMiniMap{top: 58px} /* avoid overlap with Present button area */
</style>
</head>
<body>
<div class="progress"><div id="progressBar"></div></div>
<div aria-hidden="true" class="scrim" id="scrim"></div>
<div class="app">
<aside aria-label="Навигация" class="sidebar">
<div class="brand">
<div aria-hidden="true" class="logo">
<svg viewbox="0 0 24 24"><path d="M12 2l2.2 6.3H21l-5.4 3.9 2.1 6.4L12 14.9 6.3 18.6l2.1-6.4L3 8.3h6.8L12 2z"></path></svg>
</div>
<div>
<h1>Гейм‑механики</h1>
<div class="sub">v6 • RU • расширено • 2026-01-01</div>
</div>
</div>
<div class="search">
<label>Поиск (Ctrl/⌘ + K)</label>
<div class="row">
<input autocomplete="off" id="searchBox" placeholder="Фильтр оглавления + подсветка…"/>
<span class="chip" id="matchChip">12 разделов</span>
</div>
</div>
<div class="toc">
<h2>Оглавление</h2>
<a data-toc="" href="#overview"><span class="dot"></span> 0) Обзор и границы MVP<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#core_loop"><span class="dot"></span> 1) Основная петля игры<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#points"><span class="dot"></span> 2) Очки и экономика<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#characters"><span class="dot"></span> 3) Персонажи и взаимодействие<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#quests"><span class="dot"></span> 4) Квесты и многолокационные события<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#badges"><span class="dot"></span> 5) Бейджи<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#stories"><span class="dot"></span> 6) Истории и маршруты<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#monetization"><span class="dot"></span> 7) Монетизация (билеты/мерч/подписка ×2)<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#persona"><span class="dot"></span> 8) Persona Radar (архетипы)<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#telemetry"><span class="dot"></span> 9) Телеметрия (MVP-safe)<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#content"><span class="dot"></span> 10) Контент-релизы и валидация<span aria-hidden="true" class="tocArrow">›</span></a>
<a data-toc="" href="#devnotes"><span class="dot"></span> 11) Заметки разработчика: события, DoD, QA<span aria-hidden="true" class="tocArrow">›</span></a>
</div>
<div aria-live="polite" class="contextBox">
<div class="contextTitle">Текущий раздел</div>
<div class="contextH" id="ctxH">—</div>
<div class="contextP" id="ctxP">Прокрути документ — здесь будет контекст текущего раздела.</div>
<div class="contextActions">
<span class="chip" id="ctxLink">#—</span>
<button class="btn ghost" id="ctxCopy">Скопировать ссылку</button>
<button class="btn ghost" id="ctxExpand">Детали</button>
</div>
<ul class="ctxBullets" id="ctxBullets"><li>—</li><li>—</li><li>—</li></ul><div class="ctxProg"><div class="ctxProgBar" id="ctxProgBar"></div></div></div><div class="devActions" id="devActions"><div class="devActionsTitle">Dev actions</div><div class="devActionsSub">Копирование из активного раздела:</div><div class="devActionsRow"><button class="devActionBtn" data-copy-active="events" type="button">Events</button><button class="devActionBtn" data-copy-active="state" type="button">State keys</button></div></div>
<div class="hint">• Это «черновик-дек»: постепенно наращиваем смысл и дизайн.<br/>• Сначала выбери маршрут ревью (Core / Gameplay / Ops), затем листай Prev/Next.<br/>• В каждом разделе есть: тезисы → реализация → storage → DoD.</div>
</aside>
<main class="main">
<div class="mainInner">
<div aria-label="Действия" class="chrome" role="toolbar">
<div class="chromeLeft">
<button aria-label="Меню" class="btn icon ghost" id="burgerBtn" title="Меню">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M3 6h18M3 12h18M3 18h18"></path>
</svg>
</button>
<button class="btn ghost" id="resetBtn">Сброс</button>
<button class="btn" id="printBtn">Экспорт PDF</button>
<button class="btn ghost" id="themeBtn">Тема</button>
</div>
<div class="chromeRight">
<div aria-label="Режим" class="segment">
<button data-mode-btn="reader" type="button">Чтение</button>
<button class="active" data-mode-btn="both" type="button">Чтение + Dev</button>
<button data-mode-btn="dev" type="button">Dev</button>
</div>
</div>
</div>
<article class="card" id="doc">
<header class="hero">
<h1>Art Flâneur — Blueprint гейм‑механик</h1>
<p>Единая «дорожная карта» механик Art Flâneur для разработки и ревью. Здесь — логика геймплея, контракты событий, ключи состояния и QA-границы. Каждый раздел дополнен краткими тезисами и блоком «Реализация (MVP)».</p>
<div class="badgeRow"><span class="pill">Группы</span><span class="pill">Теги</span><span class="pill">Время чтения</span><span class="pill">Reader/Dev</span><span class="pill">Поиск + подсветка</span></div><a class="heroHeatBtn" href="#heatmap">Heatmap зависимостей</a><a class="heroGalleryBtn" href="#diagramGallery">Перейти к диаграммам</a><div class="tourBar" id="tourBar"><div class="tourLeft"><div class="tourTitle">Маршруты ревью</div></div><div class="tourBtns"><button class="tourBtn" data-tour="all" type="button">Все</button><button class="tourBtn" data-tour="core" type="button">Core</button><button class="tourBtn" data-tour="gameplay" type="button">Gameplay</button><button class="tourBtn" data-tour="ops" type="button">Ops</button><button class="tourBtn" data-tour="business" type="button">Business</button></div><span class="tourChip" id="tourChip">Tour: Все</span></div><div class="groupLegend"><div class="legendTitle">Легенда</div><div class="legendRow"><span class="legendPill legend-core">Core</span><span class="legendPill legend-gameplay">Gameplay</span><span class="legendPill legend-ops">Ops</span><span class="legendPill legend-business">Business</span></div></div><div class="startCTA" id="startCTA"><div class="ctaH">Быстрый старт ревью</div><div class="ctaP">Выбери маршрут и нажми «Старт» — документ пролистывается как deck, а Prev/Next идут по выбранному пути.</div><div class="ctaActions"><button class="ctaBtn" data-start="core" type="button">Старт Core</button><button class="ctaBtn ghost" data-start="gameplay" type="button">Старт Gameplay</button><button class="ctaBtn ghost" data-start="ops" type="button">Старт Ops</button></div></div>
<div class="quickMap">
<div class="section-title">Карта разделов</div>
<div class="quickGrid"><div class="groupHeader"><div class="groupHeaderInner"><div class="groupTitle">Core</div><div class="groupSub">Секция</div></div></div><a class="cardLink cardLinkV7" data-card="" data-group="core" href="#overview"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">0) Обзор и границы MVP</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowCore" viewbox="0 0 140 34">
<path d="M10 17H130" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.18" stroke-width="2"></path>
<rect fill="currentColor" fill-opacity="0.16" height="14" rx="6" width="18" x="8" y="10"></rect>
<rect fill="currentColor" fill-opacity="0.12" height="18" rx="7" width="26" x="38" y="8"></rect>
<rect fill="currentColor" fill-opacity="0.10" height="14" rx="6" width="20" x="78" y="10"></rect>
<rect fill="currentColor" fill-opacity="0.08" height="16" rx="7" width="18" x="112" y="9"></rect>
<path d="M26 17h12M64 17h14M98 17h14" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.20" stroke-width="2"></path>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">Scope</span><span class="chipMini chipMiniSoft">Invariants</span><span class="chipMini chipMiniSoft">Anti-scope</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-core">Core</span></a><a class="cardLink cardLinkV7" data-card="" data-group="core" href="#core_loop"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">1) Основная петля игры</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowCore" viewbox="0 0 140 34">
<path d="M10 17H130" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.18" stroke-width="2"></path>
<rect fill="currentColor" fill-opacity="0.16" height="14" rx="6" width="18" x="8" y="10"></rect>
<rect fill="currentColor" fill-opacity="0.12" height="18" rx="7" width="26" x="38" y="8"></rect>
<rect fill="currentColor" fill-opacity="0.10" height="14" rx="6" width="20" x="78" y="10"></rect>
<rect fill="currentColor" fill-opacity="0.08" height="16" rx="7" width="18" x="112" y="9"></rect>
<path d="M26 17h12M64 17h14M98 17h14" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.20" stroke-width="2"></path>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">Funnel</span><span class="chipMini chipMiniSoft">State</span><span class="chipMini chipMiniSoft">Idempotency</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-core">Core</span></a><a class="cardLink cardLinkV7" data-card="" data-group="core" href="#points"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">2) Очки и экономика</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowCore" viewbox="0 0 140 34">
<path d="M10 17H130" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.18" stroke-width="2"></path>
<rect fill="currentColor" fill-opacity="0.16" height="14" rx="6" width="18" x="8" y="10"></rect>
<rect fill="currentColor" fill-opacity="0.12" height="18" rx="7" width="26" x="38" y="8"></rect>
<rect fill="currentColor" fill-opacity="0.10" height="14" rx="6" width="20" x="78" y="10"></rect>
<rect fill="currentColor" fill-opacity="0.08" height="16" rx="7" width="18" x="112" y="9"></rect>
<path d="M26 17h12M64 17h14M98 17h14" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.20" stroke-width="2"></path>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">Ledger</span><span class="chipMini chipMiniSoft">Multipliers</span><span class="chipMini chipMiniSoft">Anti-farm</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-core">Core</span></a><div class="groupHeader"><div class="groupHeaderInner"><div class="groupTitle">Gameplay</div><div class="groupSub">Секция</div></div></div><a class="cardLink cardLinkV7" data-card="" data-group="gameplay" href="#characters"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">3) Персонажи и взаимодействие</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowGameplay" viewbox="0 0 140 34">
<path d="M10 17H130" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
<circle cx="20" cy="17" fill="currentColor" fill-opacity="0.16" r="7"></circle>
<circle cx="52" cy="17" fill="currentColor" fill-opacity="0.12" r="6"></circle>
<circle cx="84" cy="17" fill="currentColor" fill-opacity="0.10" r="7"></circle>
<circle cx="116" cy="17" fill="currentColor" fill-opacity="0.08" r="6"></circle>
<path d="M27 17h18M58 17h18M91 17h18" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.20" stroke-width="2"></path>
<path d="M52 10v14" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">Archetypes</span><span class="chipMini chipMiniSoft">Discovery</span><span class="chipMini chipMiniSoft">UX</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-gameplay">Gameplay</span></a><a class="cardLink cardLinkV7" data-card="" data-group="gameplay" href="#quests"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">4) Квесты и многолокационные события</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowGameplay" viewbox="0 0 140 34">
<path d="M10 17H130" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
<circle cx="20" cy="17" fill="currentColor" fill-opacity="0.16" r="7"></circle>
<circle cx="52" cy="17" fill="currentColor" fill-opacity="0.12" r="6"></circle>
<circle cx="84" cy="17" fill="currentColor" fill-opacity="0.10" r="7"></circle>
<circle cx="116" cy="17" fill="currentColor" fill-opacity="0.08" r="6"></circle>
<path d="M27 17h18M58 17h18M91 17h18" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.20" stroke-width="2"></path>
<path d="M52 10v14" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">Stops</span><span class="chipMini chipMiniSoft">Gates</span><span class="chipMini chipMiniSoft">Transitions</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-gameplay">Gameplay</span></a><a class="cardLink cardLinkV7" data-card="" data-group="gameplay" href="#badges"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">5) Бейджи</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowGameplay" viewbox="0 0 140 34">
<path d="M10 17H130" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
<circle cx="20" cy="17" fill="currentColor" fill-opacity="0.16" r="7"></circle>
<circle cx="52" cy="17" fill="currentColor" fill-opacity="0.12" r="6"></circle>
<circle cx="84" cy="17" fill="currentColor" fill-opacity="0.10" r="7"></circle>
<circle cx="116" cy="17" fill="currentColor" fill-opacity="0.08" r="6"></circle>
<path d="M27 17h18M58 17h18M91 17h18" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.20" stroke-width="2"></path>
<path d="M52 10v14" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">Rules</span><span class="chipMini chipMiniSoft">Progress</span><span class="chipMini chipMiniSoft">Unlock</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-gameplay">Gameplay</span></a><a class="cardLink cardLinkV7" data-card="" data-group="gameplay" href="#stories"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">6) Истории и маршруты</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowGameplay" viewbox="0 0 140 34">
<path d="M10 17H130" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
<circle cx="20" cy="17" fill="currentColor" fill-opacity="0.16" r="7"></circle>
<circle cx="52" cy="17" fill="currentColor" fill-opacity="0.12" r="6"></circle>
<circle cx="84" cy="17" fill="currentColor" fill-opacity="0.10" r="7"></circle>
<circle cx="116" cy="17" fill="currentColor" fill-opacity="0.08" r="6"></circle>
<path d="M27 17h18M58 17h18M91 17h18" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.20" stroke-width="2"></path>
<path d="M52 10v14" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">Routes</span><span class="chipMini chipMiniSoft">EventStory</span><span class="chipMini chipMiniSoft">Rewards</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-gameplay">Gameplay</span></a><div class="groupHeader"><div class="groupHeaderInner"><div class="groupTitle">Business</div><div class="groupSub">Секция</div></div></div><a class="cardLink cardLinkV7" data-card="" data-group="business" href="#monetization"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">7) Монетизация (билеты/мерч/подписка ×2)</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowBusiness" viewbox="0 0 140 34">
<path d="M10 20h120" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.14" stroke-width="2"></path>
<path d="M18 22v-8" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
<path d="M34 22v-12" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.14" stroke-width="2"></path>
<path d="M50 22v-6" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.12" stroke-width="2"></path>
<path d="M66 22v-14" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.10" stroke-width="2"></path>
<path d="M82 22v-9" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.10" stroke-width="2"></path>
<path d="M98 22v-5" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.08" stroke-width="2"></path>
<path d="M114 22v-11" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.08" stroke-width="2"></path>
<circle cx="120" cy="11" fill="currentColor" fill-opacity="0.10" r="4"></circle>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">Entitlements</span><span class="chipMini chipMiniSoft">Membership</span><span class="chipMini chipMiniSoft">Store</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-business">Business</span></a><a class="cardLink cardLinkV7" data-card="" data-group="business" href="#persona"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">8) Persona Radar (архетипы)</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowBusiness" viewbox="0 0 140 34">
<path d="M10 20h120" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.14" stroke-width="2"></path>
<path d="M18 22v-8" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
<path d="M34 22v-12" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.14" stroke-width="2"></path>
<path d="M50 22v-6" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.12" stroke-width="2"></path>
<path d="M66 22v-14" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.10" stroke-width="2"></path>
<path d="M82 22v-9" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.10" stroke-width="2"></path>
<path d="M98 22v-5" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.08" stroke-width="2"></path>
<path d="M114 22v-11" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.08" stroke-width="2"></path>
<circle cx="120" cy="11" fill="currentColor" fill-opacity="0.10" r="4"></circle>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">Radar</span><span class="chipMini chipMiniSoft">Counters</span><span class="chipMini chipMiniSoft">Reco</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-business">Business</span></a><div class="groupHeader"><div class="groupHeaderInner"><div class="groupTitle">Ops</div><div class="groupSub">Секция</div></div></div><a class="cardLink cardLinkV7" data-card="" data-group="ops" href="#telemetry"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">9) Телеметрия (MVP-safe)</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowOps" viewbox="0 0 140 34">
<path d="M14 20h112" stroke="currentColor" stroke-dasharray="3 5" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
<path d="M18 12h104" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.10" stroke-width="2"></path>
<rect fill="currentColor" fill-opacity="0.12" height="18" rx="7" width="18" x="18" y="8"></rect>
<rect fill="currentColor" fill-opacity="0.10" height="14" rx="7" width="24" x="58" y="10"></rect>
<rect fill="currentColor" fill-opacity="0.08" height="16" rx="7" width="18" x="104" y="9"></rect>
<path d="M36 17h22M82 17h22" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.18" stroke-width="2"></path>
<path d="M27 14l2 2 4-5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="0.22" stroke-width="2"></path>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">Opt‑in</span><span class="chipMini chipMiniSoft">Events</span><span class="chipMini chipMiniSoft">QA</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-ops">Ops</span></a><a class="cardLink cardLinkV7" data-card="" data-group="ops" href="#content"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">10) Контент-релизы и валидация</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowOps" viewbox="0 0 140 34">
<path d="M14 20h112" stroke="currentColor" stroke-dasharray="3 5" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
<path d="M18 12h104" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.10" stroke-width="2"></path>
<rect fill="currentColor" fill-opacity="0.12" height="18" rx="7" width="18" x="18" y="8"></rect>
<rect fill="currentColor" fill-opacity="0.10" height="14" rx="7" width="24" x="58" y="10"></rect>
<rect fill="currentColor" fill-opacity="0.08" height="16" rx="7" width="18" x="104" y="9"></rect>
<path d="M36 17h22M82 17h22" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.18" stroke-width="2"></path>
<path d="M27 14l2 2 4-5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="0.22" stroke-width="2"></path>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 1 мин</span><span class="chipMini chipMiniSoft">Releases</span><span class="chipMini chipMiniSoft">Validation</span><span class="chipMini chipMiniSoft">Rollback</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-ops">Ops</span></a><a class="cardLink cardLinkV7" data-card="" data-group="ops" href="#devnotes"><span aria-hidden="true" class="spark"></span><div class="cardIcon cardIconV7"></div><div class="cardText"><div class="cardTitle">11) Заметки разработчика: события, DoD, QA</div><div class="cardDesc"></div>
<svg aria-hidden="true" class="miniFlow miniFlowOps" viewbox="0 0 140 34">
<path d="M14 20h112" stroke="currentColor" stroke-dasharray="3 5" stroke-linecap="round" stroke-opacity="0.16" stroke-width="2"></path>
<path d="M18 12h104" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.10" stroke-width="2"></path>
<rect fill="currentColor" fill-opacity="0.12" height="18" rx="7" width="18" x="18" y="8"></rect>
<rect fill="currentColor" fill-opacity="0.10" height="14" rx="7" width="24" x="58" y="10"></rect>
<rect fill="currentColor" fill-opacity="0.08" height="16" rx="7" width="18" x="104" y="9"></rect>
<path d="M36 17h22M82 17h22" stroke="currentColor" stroke-linecap="round" stroke-opacity="0.18" stroke-width="2"></path>
<path d="M27 14l2 2 4-5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="0.22" stroke-width="2"></path>
</svg>
<div class="cardMetaRow"><span class="chipMini">≈ 2 мин</span><span class="chipMini chipMiniSoft">DoD</span><span class="chipMini chipMiniSoft">Smoke</span><span class="chipMini chipMiniSoft">Contracts</span></div></div><div aria-hidden="true" class="cardArrow"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 18l6-6-6-6"></path></svg></div><span class="cardStart">Открыть</span><span class="groupBadge groupBadge-ops">Ops</span></a></div>
</div>
</header>
<div class="content">
<section class="section" data-group="core" data-section="" id="overview">
<h2>Обзор и границы MVP</h2><div class="anchor" id="overview-diagrams"></div>
<p class="lead">Границы MVP, инварианты и то, что сознательно НЕ делаем — чтобы продукт не разросся.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Scope фиксируем заранее: «скелет опыта» важнее фич.</li><li>Единая правда: Quest Engine + tx_log (идемпотентные коммиты).</li><li>Контент — релизами (immutable) + rollback переключением версии.</li><li>Телеметрия и монетизация — MVP-safe: без PII и платежных данных.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>MVP = узкий «скелет» опыта: открыть → прийти → выполнить → получить → вернуться.</li><li>Все награды и прогресс коммитятся идемпотентно (без дублей) через tx_log.</li><li>Контент релизами: версии неизменяемы; rollback = переключение активной версии.</li><li>Телеметрия и монетизация — только MVP-safe (без PII, без платежных данных).</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#overview-contracts">Контракты</a>
<a class="miniPill" href="#overview-diagrams">Диаграммы</a>
<a class="miniPill" href="#overview-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="overview-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage / Sequence</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button><button class="diagramTab" data-diagtab="sequence" type="button">Sequence</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="10" flood-color="rgba(0,0,0,0.18)" stddeviation="12"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Архитектура MVP (внутри приложения)</text><path d="M210 105.0 C 225.0 105.0, 225.0 100.0, 240 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="215.0" y="95.5">dispatch</text><path d="M410 100.0 C 430.0 100.0, 430.0 95.0, 450 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="420.0" y="90.5">route</text><path d="M630 95.0 C 645.0 95.0, 645.0 105.0, 660 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="635.0" y="93.0">persist</text><g filter="url(#softShadow)"><rect fill="var(--c-core)" fill-opacity="0.18" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="97.0">AppShell</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="113.0">(UI/Navigation)</text><g filter="url(#softShadow)"><rect fill="var(--c-core)" fill-opacity="0.14" height="80" rx="18" stroke="currentColor" stroke-opacity="0.20" width="170" x="240" y="60"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="254" y="92.0">Spine</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="254" y="108.0">(contracts)</text><g filter="url(#softShadow)"><rect fill="var(--c-game)" fill-opacity="0.14" height="90" rx="18" stroke="currentColor" stroke-opacity="0.20" width="180" x="450" y="50"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="464" y="79.0">Modules</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="464" y="95.0">(Discover/Quests/</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="464" y="111.0">Badges/Stories)</text><g filter="url(#softShadow)"><rect fill="var(--c-ops)" fill-opacity="0.14" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="120" x="660" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="674" y="105.0">DB + tx_log</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="10" flood-color="rgba(0,0,0,0.18)" stddeviation="12"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Жизненный цикл состояния (упрощенно)</text><path d="M230 110.0 C 245.0 110.0, 245.0 105.0, 260 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="235.0" y="100.5">start</text><path d="M450 105.0 C 465.0 105.0, 465.0 105.0, 480 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="455.0" y="98.0">progress</text><path d="M670 105.0 C 685.0 105.0, 685.0 110.0, 700 110.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="675.0" y="100.5">derive</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.09" height="60" rx="18" stroke="currentColor" stroke-opacity="0.20" width="190" x="40" y="80"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="110.0">Idle / Resume</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="190" x="260" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="274" y="105.0">Active session</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="190" x="480" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="494" y="97.0">Commit facts</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="494" y="113.0">(tx_log)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.09" height="60" rx="18" stroke="currentColor" stroke-opacity="0.20" width="160" x="700" y="80"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="714" y="102.0">Render</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="714" y="118.0">(projections)</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="10" flood-color="rgba(0,0,0,0.18)" stddeviation="12"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Границы хранения (MVP-safe)</text><path d="M240 105.0 C 260.0 105.0, 260.0 100.0, 280 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="250.0" y="95.5">persist</text><path d="M760 105.0 C 400.0 105.0, 400.0 105.0, 40 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="390.0" y="98.0">download</text><path d="M240 105.0 C 380.0 105.0, 380.0 105.0, 520 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="370.0" y="98.0">upload</text><g filter="url(#softShadow)"><rect fill="var(--c-ops)" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="200" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="97.0">Local</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="113.0">(cache/queue/settings)</text><g filter="url(#softShadow)"><rect fill="var(--c-ops)" fill-opacity="0.16" height="80" rx="18" stroke="currentColor" stroke-opacity="0.20" width="200" x="280" y="60"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="294" y="92.0">SQLite DB</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="294" y="108.0">(world + user + tx_log)</text><g filter="url(#softShadow)"><rect fill="var(--c-biz)" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="240" x="520" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="534" y="97.0">Remote (optional)</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="534" y="113.0">content bundles / telemetry</text></svg></div><div class="diagramPane" data-diagpane="sequence"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 300" width="100%">
<defs>
<marker id="arrow3" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Sequence (action → commit → hydrate)</text><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="42.0" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="100.0" y="50">UI</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="100.0" x2="100.0" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="182.0" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="240.0" y="50">Spine</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="240.0" x2="240.0" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="322.0" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="380.0" y="50">Quest</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="380.0" x2="380.0" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="462.0" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="520.0" y="50">DB</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="520.0" x2="520.0" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="602.0" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="660.0" y="50">Telemetry</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="660.0" x2="660.0" y1="64" y2="282"></line><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="100.0" x2="240.0" y1="98" y2="98"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="170.0" y="91">action</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="240.0" x2="380.0" y1="128" y2="128"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="310.0" y="121">domain event</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="380.0" x2="520.0" y1="158" y2="158"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="450.0" y="151">tx_log commit</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="380.0" x2="660.0" y1="188" y2="188"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="520.0" y="181">telemetry enqueue</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="520.0" x2="100.0" y1="228" y2="228"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="310.0" y="221">state hydrate</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>AppShell/Spine</li><li>DB schema &amp; tx_log</li><li>Content releases</li><li>Telemetry (opt-in)</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="app_boot
session_start
consent_changed
release_activated"><li>app_boot</li><li>session_start</li><li>consent_changed</li><li>release_activated</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="app.version
user.profile
entitlements
telemetry.optIn
release.activeId"><li>app.version</li><li>user.profile</li><li>entitlements</li><li>telemetry.optIn</li><li>release.activeId</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Оффлайн старт → восстановление state</li><li>Rollback релиза без миграций</li><li>Нет PII в payload</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">Local</div><div class="storageV">settings, consent, active release pointer</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">DB</div><div class="storageV">tx_log schema present (even if minimal)</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">telemetry endpoint optional</div><div class="rwTag">Читаем: опц. • Пишем: опц.</div></div></div></details></div>
<p class="ruNote">Этот документ — не «идеология», а практический набор правил, которые удерживают MVP в рабочем размере. Мы фиксируем, что является источником истины (Quest Engine/tx_log), как устроены релизы контента и какие данные мы принципиально не собираем.</p><p class="ruNote">Если в процессе разработки появляется новый сценарий, он должен укладываться в существующие контракты: событийную модель, статусы квестов и идемпотентный коммит наград. Всё остальное — дополнения витрин и контента.</p>
<div class="grid two">
<div class="panel">
<div class="section-title">MVP boundaries</div>
<div class="anchor" id="overview-contracts"></div><pre>- цель MVP: доказать, что loop «Discover → Quest → Reward → Return» работает
- минимальные сущности: Location, Character(archetype+rarity), Quest(stops), Badge(rule), Story(Route), Collectible(entitlement)
- локальная модель: (release content ⊕ user state) → derived UI
- отсутствие аккаунта/PII: прогресс на устройстве, экспорт/импорт позже</pre>
<div class="section-title">Non-goals (чтобы не “размазать” MVP)</div>
<pre>- не делаем полноценно геолокационную верификацию (GPS/radius)
- не делаем реальный NFT minting / payments
- не делаем социальные фичи, лидерборды и т.п.
- не делаем генеративные диалоги: тексты персонажей фиксируются контентом</pre>
<div class="callout"><b>Правило:</b> любая механика должна быть выражена в виде контента + счётчиков/состояния. Если нужна “магия” — это уже post‑MVP.</div>
</div>
<div class="panel">
<div class="section-title">Key decisions (implementation)</div>
<pre>1) Event-driven engines:
   UI emits intents → engines commit → store updated → UI renders.

2) Idempotency first:
   - любой reward/tx/badge unlock должен быть “один раз”.

3) Content releases:
   - всё геймплейное приходит из release bundle
   - validation + rollback (last-known-good)

4) Telemetry is optional:
   - consent-gated, allowlist, fail-open</pre>
<div class="section-title">Deliverables for this spec</div>
<div class="tagrow">
<span class="tag">Events dictionary</span>
<span class="tag">State shape</span>
<span class="tag">Content schema hints</span>
<span class="tag">Edge cases</span>
<span class="tag">QA scenarios</span>
</div>
<div class="anchor" id="overview-qa"></div><details style="margin-top:12px">
<summary>Acceptance criteria (MVP)</summary>
<div class="muted" style="margin-top:8px;line-height:1.6">
    Пользователь может: открыть Discover, выбрать локацию, увидеть персонажа, стартовать квест,
    выполнить его (включая stop gates), получить points и (возможный) badge unlock, увидеть прогресс по Story/Route,
    и при желании включить телеметрию (которая не ломает приложение).
  </div>
</details>
</div>
</div>
<div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#core_loop">Основная петля игры</a><a class="relatedLink" href="#content">Контент-релизы и валидация</a><a class="relatedLink" href="#telemetry">Телеметрия (MVP-safe)</a></div></div><div class="dodBox" id="overview-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>MVP-границы зафиксированы в документации</li><li>Есть список invariant'ов и anti-scope</li><li>PII-политика описана и проверяемая</li></ul></div></section>
<section class="section" data-group="core" data-section="" id="core_loop">
<h2>Основная петля игры</h2>
<p class="lead">Базовая петля: Discover → Location → Quest → Reward → Return. Offline‑first и без дублей наград.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Discover формирует intent и не хранит «прогресс» отдельно.</li><li>Награды — только после валидного завершения шага/квеста.</li><li>Оффлайн/перезапуск: восстановление должно приводить к тому же state.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>Discover формирует «намерение» (intent) и передает его в Location/Quest.</li><li>Quest Engine — единственный источник истины по статусам выполнения.</li><li>Reward commit всегда после проверки легальности выполнения.</li><li>Любой шаг должен быть воспроизводим после офлайна/перезапуска.</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#core_loop-contracts">Контракты</a>
<a class="miniPill" href="#core_loop-diagrams">Диаграммы</a>
<a class="miniPill" href="#core_loop-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="core_loop-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage (встроенные SVG)</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<g opacity="0.10"><path d="M0 0H760V240H0Z" fill="none"></path></g><text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Поток (Core loop)</text><path d="M190 100.0 C 215.0 100.0, 215.0 85.0, 240 85.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="205.0" y="86.5">open</text><path d="M400 85.0 C 425.0 85.0, 425.0 95.0, 450 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="415.0" y="84.0">start</text><path d="M610 95.0 C 625.0 95.0, 625.0 100.0, 640 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="615.0" y="91.5">commit</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="150" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="92.0">Discover</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="108.0">(intent)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="160" x="240" y="50"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="77.0">Location</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="93.0">(artefact)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="160" x="450" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="87.0">Quest Engine</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="103.0">(state)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="120" x="640" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="654" y="92.0">Reward</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="654" y="108.0">commit</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow2" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Состояния квеста (упрощенно)</text><path d="M140 140 C 230.0 140, 230.0 90, 320 90" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="212.0" y="107.0">start</text><path d="M320 90 C 420.0 90, 420.0 70, 520 70" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="402.0" y="72.0">complete</text><path d="M320 90 C 420.0 90, 420.0 150, 520 150" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="402.0" y="112.0">fail</text><circle cx="140" cy="140" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="140" y="144">Idle</text><circle cx="320" cy="90" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="320" y="94">Active</text><circle cx="520" cy="70" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="520" cy="70" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="520" y="74">Done</text><circle cx="520" cy="150" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="520" cy="150" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="520" y="154">Fail</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<g opacity="0.10"><path d="M0 0H760V240H0Z" fill="none"></path></g><text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Storage touchpoints</text><path d="M230 100.0 C 255.0 100.0, 255.0 95.0, 280 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="245.0" y="91.5">persist</text><path d="M710 100.0 C 495.0 100.0, 495.0 95.0, 280 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="485.0" y="91.5">validate</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="60" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="74" y="92.0">Local cache</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="74" y="108.0">(nav/intent)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="180" x="280" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="294" y="87.0">DB</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="294" y="103.0">quests + visits</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="190" x="520" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="534" y="92.0">Remote</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="534" y="108.0">bundle fetch (opt)</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>Discover</li><li>Location</li><li>Quest Engine</li><li>Rewards</li><li>Badges/Stories aggregation</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="discover_open
location_open
quest_start
quest_step
reward_commit"><li>discover_open</li><li>location_open</li><li>quest_start</li><li>quest_step</li><li>reward_commit</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="discover.intent
quest.activeQuestId
quest.statusById
reward.pending
nav.lastRoute"><li>discover.intent</li><li>quest.activeQuestId</li><li>quest.statusById</li><li>reward.pending</li><li>nav.lastRoute</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Повторный commit не создаёт дубль</li><li>Восстановление после kill/restart</li><li>Сбой телеметрии не ломает UX</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">Local</div><div class="storageV">navigation intent, last route, offline cache</div><div class="rwTag">Читаем: да • Пишем: да (кэш)</div></div><div class="storageCell"><div class="storageK">DB</div><div class="storageV">quest status, reward commits, visit facts</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">content bundle download (optional)</div><div class="rwTag">Читаем: опц. • Пишем: опц.</div></div></div></details></div>
<p class="ruNote">Core loop специально собран так, чтобы быть повторяемым: пользователь может потерять сеть, перезапустить приложение, вернуться на шаг назад — и мы всё равно придём к одному состоянию без дублей и расхождений.</p><p class="ruNote">Практика: любые экраны (Discover/Location/Quest) должны уметь восстановиться из state+storage, а коммиты наград должны проходить через единую транзакционную точку.</p>
<div class="grid two">
<div class="panel">
<div class="anchor" id="core_loop-diagrams"></div><div class="svgcard">
<svg viewbox="0 0 980 400" xmlns="http://www.w3.org/2000/svg">
<defs>
<style>
      .b{fill:rgba(255,255,255,.58);stroke:rgba(0,0,0,.22);stroke-width:2}
      .t{font: 15px ui-sans-serif, system-ui; fill: rgba(16,16,16,.92)}
      .s{font: 12px ui-sans-serif, system-ui; fill: rgba(16,16,16,.62)}
      .a{stroke:rgba(0,0,0,.36);stroke-width:2;fill:none;marker-end:url(#m)}
    </style>
<marker id="m" markerheight="8" markerwidth="8" orient="auto-start-reverse" refx="8" refy="5" viewbox="0 0 10 10">
<path d="M0 0 L10 5 L0 10z" fill="rgba(0,0,0,.36)"></path>
</marker>
</defs>
<rect class="b" height="90" rx="16" ry="16" width="190" x="50" y="80"></rect>
<text class="t" x="74" y="116">UI</text>
<text class="s" x="74" y="140">Discover / Location</text>
<rect class="b" height="90" rx="16" ry="16" width="200" x="270" y="80"></rect>
<text class="t" x="294" y="116">Quest Engine</text>
<text class="s" x="294" y="140">state transitions</text>
<rect class="b" height="90" rx="16" ry="16" width="200" x="500" y="40"></rect>
<text class="t" x="524" y="76">Economy</text>
<text class="s" x="524" y="100">tx_log + multiplier</text>
<rect class="b" height="90" rx="16" ry="16" width="200" x="500" y="150"></rect>
<text class="t" x="524" y="186">Badge Engine</text>
<text class="s" x="524" y="210">unlock evaluation</text>
<rect class="b" height="90" rx="16" ry="16" width="200" x="730" y="95"></rect>
<text class="t" x="754" y="131">Telemetry</text>
<text class="s" x="754" y="155">allowlist emit</text>
<path class="a" d="M240 125 L270 125"></path>
<text class="s" x="246" y="110">intent</text>
<path class="a" d="M470 110 L500 85"></path>
<text class="s" x="476" y="82">points</text>
<path class="a" d="M470 140 L500 170"></path>
<text class="s" x="476" y="170">badge eval</text>
<path class="a" d="M700 95 L730 125"></path>
<path class="a" d="M700 195 L730 155"></path>
<rect class="b" height="100" rx="16" ry="16" width="660" x="270" y="260"></rect>
<text class="t" x="292" y="296">Content Releases</text>
<text class="s" x="292" y="320">locations.json · characters.json · quests.json · stories.json · badges.json + assets + schemas</text>
<path class="a" d="M370 170 L420 260"></path>
<path class="a" d="M600 240 L600 260"></path>
</svg>
</div>
<div class="section-title">Loop steps (strict)</div>
<div class="anchor" id="core_loop-contracts"></div><pre>Step 0: App opens → load content release → hydrate user state
Step 1: Discover list → user selects location
Step 2: Location screen → show characters + quests + story stops
Step 3: User starts quest (intent) → quest state = InProgress
Step 4: User completes tasks / gates → quest state = Completed
Step 5: Commit reward:
        - Economy points tx (membership multiplier)
        - Badge evaluation
        - Story/Route derived progress changes
Step 6: UI shows reward + next suggested actions (return loop)</pre>
</div>
<div class="panel">
<div class="section-title">Edge cases</div>
<pre>- quest started but user closes app → on resume, quest still InProgress
- repeated “complete” intent → no-op (idempotent)
- content release updates during progress:
  - use stable IDs
  - keep last-known-good content pinned per session
- character disappears in new release:
  - keep already-discovered characters in user state
  - mark as “legacy” / “archived” in UI</pre>
<div class="section-title">UI mapping</div>
<pre>- Discover screen: filters + “featured story” banner
- Location screen: meet character card + list of quests
- Quest screen: stepper (stops) + check-in/QR manual
- Reward summary: points delta + unlocked badges + “next” CTA</pre>
<div class="callout"><b>Design invariant:</b> loop должен быть завершён даже без интернета (offline-first).</div>
</div>
</div>
<div class="anchor" id="core_loop-qa"></div><div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#quests">Квесты и многолокационные события</a><a class="relatedLink" href="#badges">Бейджи</a><a class="relatedLink" href="#telemetry">Телеметрия (MVP-safe)</a></div></div><div class="dodBox" id="core_loop-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>Полный e2e сценарий проходит офлайн/онлайн</li><li>Idempotency на reward_commit покрыта тестами</li><li>Перезапуск не ломает активный квест</li></ul></div></section>
<section class="section" data-group="core" data-section="" id="points">
<h2>Очки и экономика</h2><div class="anchor" id="points-diagrams"></div>
<p class="lead">Экономика очков: источники, ×2 membership, tx_log и правила против фарма.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Ledger first: tx_log append-only, витрины — производные.</li><li>Множители применяются при начислении, не задним числом.</li><li>Anti-farm: лимиты, cooldown, уникальные ключи начислений.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>Единый ledger (tx_log) + агрегаты по витринам (быстро показывать в UI).</li><li>Membership ×2 применяется как «множитель» в момент начисления, а не пересчётом задним числом.</li><li>Anti-farm: лимиты, cooldown, одноразовые токены, запрет повторного коммита.</li><li>Валидация источника начисления (eventId, questId, stopId).</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#points-contracts">Контракты</a>
<a class="miniPill" href="#points-diagrams">Диаграммы</a>
<a class="miniPill" href="#points-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="points-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage / Sequence (встроенные SVG)</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button><button class="diagramTab" data-diagtab="sequence" type="button">Sequence</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Поток (Points / Ledger)</text><path d="M210 100.0 C 225.0 100.0, 225.0 95.0, 240 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="211.0" y="91.5">calc</text><path d="M410 95.0 C 430.0 95.0, 430.0 95.0, 450 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="416.0" y="89.0">append</text><path d="M630 95.0 C 645.0 95.0, 645.0 100.0, 660 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="631.0" y="91.5">rebuild</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="92.0">Source event</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="108.0">(quest/story)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="240" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="87.0">Apply multipliers</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="103.0">(membership)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="180" x="450" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="87.0">tx_log append</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="103.0">(idempotent)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="120" x="660" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="674" y="92.0">Balance</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="674" y="108.0">projection</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow2" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Статус начисления</text><path d="M220 120 C 320.0 120, 320.0 120, 420 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="302.0" y="112.0">valid</text><path d="M220 120 C 420.0 120, 420.0 120, 620 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="402.0" y="112.0">dup/limit</text><circle cx="220" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="220" y="124">Pending</text><circle cx="420" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="420" cy="120" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="420" y="124">Committed</text><circle cx="620" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="620" cy="120" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="620" y="124">Rejected</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Хранение и витрины</text><path d="M290 95.0 C 305.0 95.0, 305.0 100.0, 320 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="291.0" y="91.5">derive</text><path d="M760 95.0 C 420.0 95.0, 420.0 95.0, 80 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="406.0" y="89.0">block</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="210" x="80" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="87.0">DB tx_log</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="103.0">append-only</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="320" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="334" y="92.0">View tables</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="334" y="108.0">(balance)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="560" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="574" y="87.0">Limits</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="574" y="103.0">(cooldowns)</text></svg></div><div class="diagramPane" data-diagpane="sequence"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow3" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Sequence (начисление очков)</text><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="62.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="117.5" y="44">UI</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="117.5" x2="117.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="237.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="292.5" y="44">Quest</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="292.5" x2="292.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="412.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="467.5" y="44">Rewards</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="467.5" x2="467.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="587.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="642.5" y="44">DB</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="642.5" x2="642.5" y1="52" y2="242"></line><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="117.5" x2="292.5" y1="90" y2="90"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="205.0" y="84">quest_complete</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="292.5" x2="467.5" y1="120" y2="120"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="380.0" y="114">reward_calc</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="467.5" x2="642.5" y1="150" y2="150"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="555.0" y="144">append tx_log</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="642.5" x2="467.5" y1="180" y2="180"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="555.0" y="174">ok/dup</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="467.5" x2="117.5" y1="210" y2="210"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="292.5" y="204">render balance</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>tx_log ledger</li><li>Balance projection</li><li>Membership multiplier</li><li>Anti-farm rules</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="points_earned
points_spent
multiplier_applied
cooldown_blocked"><li>points_earned</li><li>points_spent</li><li>multiplier_applied</li><li>cooldown_blocked</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="wallet.balance
wallet.txIndex
membership.tier
limits.cooldowns"><li>wallet.balance</li><li>wallet.txIndex</li><li>membership.tier</li><li>limits.cooldowns</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Idempotency key на начисление</li><li>Лимиты по источникам</li><li>Пересчёт витрины из tx_log</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">DB</div><div class="storageV">tx_log append-only; unique keys</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Local</div><div class="storageV">balance projection cache</div><div class="rwTag">Читаем: да • Пишем: да (кэш)</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">none in MVP</div><div class="rwTag">Читаем: нет • Пишем: нет</div></div></div></details></div>
<p class="ruNote">Экономика очков — это не только «сколько дать», а в первую очередь «как не дать дважды». Поэтому ledger/tx_log — обязательная часть MVP, даже если визуально UI пока простой.</p><p class="ruNote">Мы разделяем: транзакции (источник истины) и витрины/агрегаты (быстро показать баланс, прогресс, мультипликаторы). Любую витрину можно пересчитать, а транзакции — нет.</p>
<div class="grid two">
<div class="panel">
<div class="section-title">Points sources (MVP table)</div>
<div class="anchor" id="points-contracts"></div><pre>location_first_visit        +10
character_discovered_common  +5
character_discovered_rare   +15
character_discovered_ultra  +30
quest_completed             +reward.points
route_story_completed       +60 (content-defined)
event_story_completed       +120 (content-defined)
ticket_purchase (supporter) +0..20 (optional)
merch_collectible_acquired  +0..10 (optional)
contributor_submission_ok   +25 (optional)</pre>
<div class="section-title">Membership ×2</div>
<pre>- implemented as multiplier at commit time
- does not change historical txs
- multiplier applies only to "eligible sources" (config)</pre>
<div class="section-title">Anti-farm controls (MVP)</div>
<pre>- first_visit points only once per location_id
- character discovery points only once per character_id
- non-repeatable quests award only once
- repeatable quests: enforce cooldown (later) or daily cap (later)</pre>
</div>
<div class="panel">
<div class="section-title">Economy state (copy)</div>
<div class="copyrow"><span class="label">economyState:</span><button class="btn" data-copy="#economyState">Copy</button></div>
<pre id="economyState">{
  "points_balance": 120,
  "membership_active": false,
  "tx_log": [
    {"id":"tx.quest.quest.q1","at":1735689600,"amount":20,"source":"quest","ref":"quest.q1"},
    {"id":"tx.char.char.historian.001","at":1735689700,"amount":10,"source":"character","ref":"char.historian.001"}
  ],
  "caps": {"daily_points_cap": null}
}</pre>
<div class="section-title">Commit algorithm (pseudocode)</div>
<pre>function commitPoints({source, ref, baseAmount}) {
  const txId = `tx.${source}.${ref}`;
  if (tx_log.has(txId)) return NOOP;

  let amount = baseAmount;
  if (membership_active &amp;&amp; isEligibleSource(source)) amount *= 2;

  tx_log.add({id: txId, amount, source, ref});
  points_balance += amount;
  emit('economy_points_added', {amount, source, ref, tx_id: txId});
}</pre>
</div>
</div>
<div class="anchor" id="points-qa"></div><div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#monetization">Монетизация (билеты/мерч/подписка ×2)</a><a class="relatedLink" href="#badges">Бейджи</a><a class="relatedLink" href="#telemetry">Телеметрия (MVP-safe)</a></div></div><div class="dodBox" id="points-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>tx_log существует и используется для всех начислений</li><li>Витрины пересчитываются из tx_log</li><li>Anti-farm лимиты покрыты тестами</li></ul></div></section>
<section class="section" data-group="gameplay" data-section="" id="characters">
<h2>Персонажи и взаимодействие</h2><div class="anchor" id="characters-diagrams"></div>
<p class="lead">Персонажи: архетипы, редкость, правила discovery и UX-взаимодействия.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Архетипы управляют тоном/типом заданий, а не «сюжетом в пустоте».</li><li>Discovery управляется данными, не рандомом без правил.</li><li>Counters → Persona Radar и рекомендации (без профилирования личности).</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>Архетипы — управляют тоном и типом заданий, а не «сюжетом в вакууме».</li><li>Discovery: условия появления (гео/контент/редкость/ограничения).</li><li>Interaction counters → Persona Radar и рекомендации контента.</li><li>События взаимодействия — часть телеметрии и части геймификации.</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#characters-contracts">Контракты</a>
<a class="miniPill" href="#characters-diagrams">Диаграммы</a>
<a class="miniPill" href="#characters-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="characters-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage / Sequence (встроенные SVG)</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button><button class="diagramTab" data-diagtab="sequence" type="button">Sequence</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Поток (Characters → Persona)</text><path d="M210 100.0 C 225.0 100.0, 225.0 95.0, 240 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="211.0" y="91.5">show</text><path d="M410 95.0 C 430.0 95.0, 430.0 95.0, 450 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="416.0" y="89.0">event</text><path d="M620 95.0 C 635.0 95.0, 635.0 100.0, 650 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="621.0" y="91.5">update</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="92.0">Discovery rule</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="108.0">(when/where)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="240" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="87.0">Character</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="103.0">interaction UI</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="450" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="87.0">Archetype signal</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="103.0">+ counters</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="120" x="650" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="664" y="92.0">Persona</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="664" y="108.0">Radar</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow2" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Состояния персонажа</text><path d="M200 120 C 280.0 120, 280.0 120, 360 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="262.0" y="112.0">discover</text><path d="M360 120 C 440.0 120, 440.0 120, 520 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="422.0" y="112.0">unlock</text><circle cx="200" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="200" y="124">Unknown</text><circle cx="360" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="360" y="124">Seen</text><circle cx="520" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="520" cy="120" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="520" y="124">Owned</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Хранение и сигналы</text><path d="M300 95.0 C 440.0 95.0, 440.0 95.0, 580 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="426.0" y="89.0">signal</text><path d="M540 100.0 C 310.0 100.0, 310.0 95.0, 80 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="296.0" y="91.5">sync</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="220" x="80" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="87.0">DB facts</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="103.0">seen/owned</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="340" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="354" y="92.0">Dialog flags</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="354" y="108.0">(local)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="580" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="594" y="87.0">Persona counters</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="594" y="103.0">(db)</text></svg></div><div class="diagramPane" data-diagpane="sequence"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow3" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Sequence (interaction)</text><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="62.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="117.5" y="44">UI</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="117.5" x2="117.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="237.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="292.5" y="44">Discovery</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="292.5" x2="292.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="412.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="467.5" y="44">Character</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="467.5" x2="467.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="587.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="642.5" y="44">DB</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="642.5" x2="642.5" y1="52" y2="242"></line><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="117.5" x2="292.5" y1="90" y2="90"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="205.0" y="84">location_open</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="292.5" x2="117.5" y1="120" y2="120"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="205.0" y="114">spawn character</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="117.5" x2="467.5" y1="150" y2="150"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="292.5" y="144">interact</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="467.5" x2="642.5" y1="180" y2="180"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="555.0" y="174">character_interact event</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="642.5" x2="117.5" y1="210" y2="210"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="380.0" y="204">updated state</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>Archetype catalogue</li><li>Discovery rules</li><li>Interaction UI</li><li>Persona counters</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="character_discovered
character_interact
dialog_choice
archetype_signal"><li>character_discovered</li><li>character_interact</li><li>dialog_choice</li><li>archetype_signal</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="characters.seen
characters.owned
persona.counters
dialog.flags"><li>characters.seen</li><li>characters.owned</li><li>persona.counters</li><li>dialog.flags</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Discovery не спамит редких</li><li>События взаимодействия без PII</li><li>Персонализация не блокирует контент</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">DB</div><div class="storageV">character discovery facts</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Local</div><div class="storageV">dialog flags (optional)</div><div class="rwTag">Читаем: опц. • Пишем: опц.</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">none in MVP</div><div class="rwTag">Читаем: нет • Пишем: нет</div></div></div></details></div>
<p class="ruNote">Персонажи — это управляемые «голоса» системы: они задают формат заданий и эмоциональный тон, но опираются на реальные действия пользователя (посещения, выборы, успехи).</p><p class="ruNote">Важно: взаимодействие с персонажами не должно создавать отдельный «параллельный» прогресс. Оно должно питать Quest Engine / Badges / Persona Radar через события и счётчики.</p>
<div class="grid two">
<div class="panel">
<div class="section-title">Archetypes (fixed set)</div>
<div class="anchor" id="characters-contracts"></div><pre>- Gallerist   → curator mindset, exhibitions, galleries
- Art Dealer  → market, collecting, provenance, value
- Historian   → context, art movements, references
- Layperson   → accessibility, feelings, entry-level</pre>
<div class="section-title">Character entity</div>
<div class="copyrow"><span class="label">character JSON:</span><button class="btn" data-copy="#charJson">Copy</button></div>
<pre id="charJson">{
  "id":"char.historian.001",
  "archetype":"Historian",
  "rarity":"common",
  "home_locations":["loc.lviv_001","loc.lviv_003"],
  "dialogs":[{"id":"dlg.h1","lines":["..."]}],
  "questions":["q.h1","q.h2"],
  "quests":["quest.q1"],
  "tags":["modernism","painting"]
}</pre>
<div class="section-title">Rarity</div>
<pre>- common: frequently available
- rare: only specific locations/stories
- ultra: tiny curated set, special unlock moments</pre>
</div>
<div class="panel">
<div class="section-title">Discovery mechanics</div>
<pre>- discovery happens when:
  - user opens location and character is present, OR
  - user completes quest that reveals character, OR
  - story stop reveals character
- discovery emits:
  - character_discovered {character_id, archetype, rarity}
  - economy_points_added (once)
  - telemetry_character_discovered (optional)</pre>
<div class="section-title">UI pattern (MVP)</div>
<pre>- location shows "Meet {Character}" card
- tap → dialog + optional question set
- finishing a question set can:
  - grant points
  - progress quest
  - update persona counters</pre>
<div class="anchor" id="characters-qa"></div><details style="margin-top:12px">
<summary>Edge cases</summary>
<div class="muted" style="margin-top:8px;line-height:1.6">
    Если character удалён/переименован в новом релизе — мы сохраняем discovered record в user state и
    показываем как “Archived character”. Если archetype set расширится — хранить unknown как string, но UI сгруппировать в “Other”.
  </div>
</details>
</div>
</div>
<div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#quests">Квесты и многолокационные события</a><a class="relatedLink" href="#persona">Persona Radar (архетипы)</a><a class="relatedLink" href="#telemetry">Телеметрия (MVP-safe)</a></div></div><div class="dodBox" id="characters-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>Discovery rules не спамят редкими</li><li>События взаимодействия идут в persona counters</li><li>Взаимодействие не создаёт дублей наград</li></ul></div></section>
<section class="section" data-group="gameplay" data-section="" id="quests">
<h2>Квесты и многолокационные события</h2>
<p class="lead">Квесты/ивенты: стопы, гейты (check‑in/QR), статусы и порядок коммита.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Статусы и переходы формализованы: Active/Completed/Failed/Expired.</li><li>Gate/legality проверяем до коммита награды.</li><li>Multi-location event = квест + правила времени/локаций в данных.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>Статусная модель: Draft/Active/Completed/Failed/Expired + checkpoints по стопам.</li><li>Гейты: check-in, QR, proximity — выбирается на уровне контента/локации.</li><li>Legality validation перед наградой: квест можно выполнить, но не «зачесть».</li><li>Ивенты = связка локаций со временем/правилами и отдельным reward mapping.</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#quests-contracts">Контракты</a>
<a class="miniPill" href="#quests-diagrams">Диаграммы</a>
<a class="miniPill" href="#quests-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="quests-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage (встроенные SVG)</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<g opacity="0.10"><path d="M0 0H760V240H0Z" fill="none"></path></g><text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Поток (Quest Engine)</text><path d="M200 105.0 C 220.0 105.0, 220.0 95.0, 240 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="210.0" y="94.0">load</text><path d="M400 95.0 C 420.0 95.0, 420.0 95.0, 440 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="410.0" y="89.0">pass</text><path d="M610 95.0 C 630.0 95.0, 630.0 100.0, 650 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="620.0" y="91.5">complete</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="160" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="97.0">Quest def</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="113.0">(release)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="160" x="240" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="87.0">Gates</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="103.0">(legality)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="440" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="454" y="87.0">Progress</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="454" y="103.0">(stops)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="120" x="650" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="664" y="92.0">Commit</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="664" y="108.0">reward</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow2" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Машина состояний квеста</text><path d="M120 120 C 190.0 120, 190.0 80, 260 80" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="172.0" y="92.0">activate</text><path d="M260 80 C 390.0 80, 390.0 50, 520 50" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="372.0" y="57.0">complete</text><path d="M260 80 C 390.0 80, 390.0 150, 520 150" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="372.0" y="107.0">fail</text><path d="M260 80 C 340.0 80, 340.0 80, 420 80" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="322.0" y="72.0">timeout</text><circle cx="120" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="120" y="124">Draft</text><circle cx="260" cy="80" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="260" y="84">Active</text><circle cx="420" cy="80" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="420" cy="80" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="420" y="84">Expired</text><circle cx="520" cy="50" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="520" cy="50" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="520" y="54">Done</text><circle cx="520" cy="150" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="520" cy="150" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="520" y="154">Failed</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<g opacity="0.10"><path d="M0 0H760V240H0Z" fill="none"></path></g><text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Хранение и коммиты</text><path d="M210 100.0 C 230.0 100.0, 230.0 95.0, 250 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="220.0" y="91.5">hydrate</text><path d="M450 95.0 C 485.0 95.0, 485.0 95.0, 520 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="475.0" y="89.0">commit</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="92.0">Release bundle</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="108.0">(quest json)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="250" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="264" y="87.0">DB</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="264" y="103.0">progress + tokens</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="520" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="534" y="87.0">tx_log</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="534" y="103.0">idempotency</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>Quest definition</li><li>Stops/gates</li><li>Legality validation</li><li>Reward mapping</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="quest_activated
stop_reached
gate_passed
quest_completed
quest_failed"><li>quest_activated</li><li>stop_reached</li><li>gate_passed</li><li>quest_completed</li><li>quest_failed</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="quests.byId
quests.active
stops.progress
gates.tokens
rewards.committed"><li>quests.byId</li><li>quests.active</li><li>stops.progress</li><li>gates.tokens</li><li>rewards.committed</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Зачёт только после gate</li><li>Истечение срока ивента</li><li>Переигровка шага не даёт награду</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">DB</div><div class="storageV">quests, stops progress, gate tokens, reward mapping</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Local</div><div class="storageV">pending writes queue</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">QR validation optional if online</div><div class="rwTag">Читаем: опц. • Пишем: опц.</div></div></div></details></div>
<p class="ruNote">Quest Engine — самый строгий блок: здесь нужна ясная статусная модель, ключи идемпотентности, и порядок операций (проверка → запись факта → награда).</p><p class="ruNote">События (multi-location) рассматриваем как квесты с доп. ограничениями по времени/локациям. Это позволяет не плодить отдельные подсистемы, а расширять правила в данных (content).</p>
<div class="grid two">
<div class="panel">
<div class="anchor" id="quests-diagrams"></div><div class="svgcard">
<svg viewbox="0 0 980 360" xmlns="http://www.w3.org/2000/svg">
<defs>
<style>
      .b{fill:rgba(255,255,255,.58);stroke:rgba(0,0,0,.22);stroke-width:2}
      .t{font: 15px ui-sans-serif, system-ui; fill: rgba(16,16,16,.92)}
      .s{font: 12px ui-sans-serif, system-ui; fill: rgba(16,16,16,.62)}
      .a{stroke:rgba(0,0,0,.36);stroke-width:2;fill:none;marker-end:url(#m)}
    </style>
<marker id="m" markerheight="8" markerwidth="8" orient="auto-start-reverse" refx="8" refy="5" viewbox="0 0 10 10">
<path d="M0 0 L10 5 L0 10z" fill="rgba(0,0,0,.36)"></path>
</marker>
</defs>
<rect class="b" height="90" rx="16" ry="16" width="200" x="60" y="90"></rect>
<text class="t" x="92" y="125">NotStarted</text>
<text class="s" x="92" y="150">quest visible</text>
<rect class="b" height="90" rx="16" ry="16" width="200" x="330" y="60"></rect>
<text class="t" x="362" y="95">InProgress</text>
<text class="s" x="362" y="120">stop i active</text>
<rect class="b" height="90" rx="16" ry="16" width="200" x="330" y="190"></rect>
<text class="t" x="360" y="225">Blocked</text>
<text class="s" x="360" y="250">needs check-in/QR</text>
<rect class="b" height="90" rx="16" ry="16" width="200" x="600" y="90"></rect>
<text class="t" x="633" y="125">Completed</text>
<text class="s" x="633" y="150">reward committed once</text>
<path class="a" d="M260 135 L330 105"></path>
<text class="s" x="268" y="110">start</text>
<path class="a" d="M430 150 L430 190"></path>
<text class="s" x="442" y="176">fail gate</text>
<path class="a" d="M430 190 L430 150"></path>
<text class="s" x="442" y="168">pass gate</text>
<path class="a" d="M530 105 L600 135"></path>
<text class="s" x="542" y="110">complete</text>
</svg>
</div>
<div class="section-title">Quest types</div>
<div class="anchor" id="quests-contracts"></div><pre>- local_quest: внутри одной локации
- event_story: multi-location "stops"
- route_story: лучше как Story (derived), но можно как quest (если удобно)</pre>
<div class="section-title">Quest definition</div>
<div class="copyrow"><span class="label">quest JSON:</span><button class="btn" data-copy="#questJson">Copy</button></div>
<pre id="questJson">{
  "id":"quest.event_biennale_01",
  "type":"event_story",
  "main_character_id":"char.gallerist.001",
  "stops":[
    {"id":"s1","location_id":"loc.lviv_001","character_id":"char.historian.002","task":"checkin"},
    {"id":"s2","location_id":"loc.lviv_005","character_id":"char.dealer.004","task":"question_set","question_set_id":"qs.01"},
    {"id":"s3","location_id":"loc.lviv_011","task":"qr_scan","qr_hint":"B1-ART-011"}
  ],
  "reward":{"points":120,"badge_id":"badge.event_biennale_01"}
}</pre>
</div>
<div class="panel">
<div class="section-title">Quest state (user)</div>
<pre>{
  "quest_id":"quest.event_biennale_01",
  "status":"InProgress",
  "active_stop":"s2",
  "completed_stops":["s1"],
  "gates":{
    "s3":{"type":"qr_scan","value":"", "completed":false}
  },
  "started_at":1735689600,
  "completed_at":null
}</pre>
<div class="section-title">Transitions (intents)</div>
<pre>- startQuest(quest_id)
- completeStop(quest_id, stop_id, payload?)
- submitQR(quest_id, stop_id, code) [MVP: manual]
- completeQuest(quest_id)</pre>
<div class="section-title">Commit order (important)</div>
<pre>1) validate transition legality
2) update quest state (idempotent)
3) if quest completed:
   - commit points tx (economy)
   - run badge evaluation
   - emit story derived progress change
4) emit telemetry events (if enabled)</pre>
<div class="callout"><b>MVP gate:</b> QR/Check-in — manual confirm. Later we can add GPS radius + QR signature.</div>
</div>
</div>
<div class="anchor" id="quests-qa"></div><div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#badges">Бейджи</a><a class="relatedLink" href="#stories">Истории и маршруты</a><a class="relatedLink" href="#content">Контент-релизы и валидация</a></div></div><div class="dodBox" id="quests-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>Статусы и переходы формализованы</li><li>Gates валидируются до зачёта</li><li>Expired/Failed обрабатываются корректно</li></ul></div></section>
<section class="section" data-group="gameplay" data-section="" id="badges">
<h2>Бейджи</h2><div class="anchor" id="badges-diagrams"></div>
<p class="lead">Бейджи: типы правил, хранение unlock, пересчёт прогресса и UX отображение.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Rule engine event-driven, без тяжёлых full-scan.</li><li>Прогресс хранится для UX (сколько осталось и почему).</li><li>Unlock — отдельный факт + журнал событий для пересчёта.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>Rule types: count / unique / streak / time-window / collection.</li><li>Оценка unlock — событийная (event-driven), а не тяжёлый full-scan.</li><li>Прогресс хранить отдельно от результата unlock (для UX).</li><li>Бейджи — витрина достижений + мягкие цели (guide rails).</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#badges-contracts">Контракты</a>
<a class="miniPill" href="#badges-diagrams">Диаграммы</a>
<a class="miniPill" href="#badges-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="badges-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage (встроенные SVG)</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<g opacity="0.10"><path d="M0 0H760V240H0Z" fill="none"></path></g><text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Поток (Badges)</text><path d="M210 100.0 C 230.0 100.0, 230.0 95.0, 250 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="220.0" y="91.5">match</text><path d="M420 95.0 C 440.0 95.0, 440.0 95.0, 460 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="430.0" y="89.0">update</text><path d="M630 95.0 C 650.0 95.0, 650.0 100.0, 670 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="640.0" y="91.5">unlock</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="92.0">Incoming events</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="108.0">(allowlist)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="250" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="264" y="87.0">Rule engine</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="264" y="103.0">(event-driven)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="460" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="474" y="87.0">Progress store</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="474" y="103.0">(by badgeId)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="120" x="670" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="684" y="92.0">Unlock</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="684" y="108.0">+ feed</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow2" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Состояния бейджа</text><path d="M170 120 C 265.0 120, 265.0 120, 360 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="247.0" y="112.0">event</text><path d="M360 120 C 360.0 120, 360.0 120, 360 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="342.0" y="112.0">+progress</text><path d="M360 120 C 460.0 120, 460.0 120, 560 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="442.0" y="112.0">threshold</text><circle cx="170" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="170" y="124">Locked</text><circle cx="360" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="360" y="124">Progress</text><circle cx="560" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="560" cy="120" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="560" y="124">Unlocked</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<g opacity="0.10"><path d="M0 0H760V240H0Z" fill="none"></path></g><text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Пересчёт и UX</text><path d="M760 95.0 C 420.0 95.0, 420.0 95.0, 80 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="410.0" y="89.0">rebuild</text><path d="M280 95.0 C 305.0 95.0, 305.0 100.0, 330 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="295.0" y="91.5">render</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="80" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="87.0">DB</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="103.0">progress/unlocked</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="180" x="330" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="344" y="92.0">UI feed cache</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="344" y="108.0">(local)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="560" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="574" y="87.0">Recalc</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="574" y="103.0">from event facts</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>Badge catalogue</li><li>Rule engine</li><li>Progress store</li><li>Unlock feed</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="badge_progress
badge_unlocked
badge_seen
badge_share"><li>badge_progress</li><li>badge_unlocked</li><li>badge_seen</li><li>badge_share</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="badges.progressById
badges.unlocked
badges.lastEvaluated
feed.items"><li>badges.progressById</li><li>badges.unlocked</li><li>badges.lastEvaluated</li><li>feed.items</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Event-driven оценка</li><li>Пояснение причины прогресса</li><li>Пересчёт прогресса по событийному журналу</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">DB</div><div class="storageV">badge progress/unlocked, last evaluated</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Local</div><div class="storageV">feed cache</div><div class="rwTag">Читаем: да • Пишем: да (кэш)</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">none in MVP</div><div class="rwTag">Читаем: нет • Пишем: нет</div></div></div></details></div>
<p class="ruNote">Бейджи — это витрина мотивации и «мягкие цели». Они должны быть дешёвыми по вычислениям: в идеале пересчитываться от событий, а не сканировать историю целиком при каждом запуске.</p><p class="ruNote">Для UX ключевое — прогресс (сколько осталось) и объяснение причины. Поэтому хранить нужно и unlock, и прогресс/причину, даже если это производные значения.</p>
<div class="grid two">
<div class="panel">
<div class="section-title">Badge categories (MVP)</div>
<div class="anchor" id="badges-contracts"></div><pre>- Progress badges: for quests/stories/events
- Collection badges: for collectibles (nft/physical)
- Preference badges: medium/archetype alignment
- Contribution badges: contributor mode (optional)</pre>
<div class="section-title">Collector badge (copy)</div>
<div class="copyrow"><span class="label">badge JSON:</span><button class="btn" data-copy="#collectorBadge">Copy</button></div>
<pre id="collectorBadge">{
  "id":"badge.collector.young",
  "tier":"bronze",
  "title":"Young Collector",
  "rule":{"type":"collectibles_count","kind":"nft","min":3}
}</pre>
<div class="section-title">Medium badge (copy)</div>
<div class="copyrow"><span class="label">badge JSON:</span><button class="btn" data-copy="#mediumBadge">Copy</button></div>
<pre id="mediumBadge">{
  "id":"badge.medium.photography",
  "tier":"silver",
  "title":"Photography Enthusiast",
  "rule":{"type":"medium_interactions","medium":"photography","min":5}
}</pre>
</div>
<div class="panel">
<div class="section-title">Evaluation model</div>
<pre>- badge engine runs on triggers:
  - quest_completed
  - collectible_acquired
  - medium_interaction_logged
- evaluator reads snapshot counters:
  - collectibles_count_by_kind
  - interactions_by_medium
  - quest_completed_set
  - story_completed_set
- unlock is idempotent:
  - if user.badges_unlocked has badge_id → NOOP</pre>
<div class="section-title">User badge state</div>
<pre>{
  "unlocked":[
    {"id":"badge.collector.young","at":1735689800,"source":"collectible_acquired"}
  ],
  "progress":{
    "badge.collector.young":{"current":2,"target":3}
  }
}</pre>
<div class="anchor" id="badges-qa"></div><details style="margin-top:12px">
<summary>Progress UI (optional MVP)</summary>
<div class="muted" style="margin-top:8px;line-height:1.6">
    Прогресс можно вычислять на лету: rule → (current,target). Не хранить progress постоянно, чтобы не ломался при изменении правил.
    Хранить только unlocked.
  </div>
</details>
</div>
</div>
<div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#quests">Квесты и многолокационные события</a><a class="relatedLink" href="#telemetry">Телеметрия (MVP-safe)</a><a class="relatedLink" href="#points">Очки и экономика</a></div></div><div class="dodBox" id="badges-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>Unlock вычисляется event-driven</li><li>Пояснение прогресса есть в UX</li><li>Пересчёт прогресса возможен</li></ul></div></section>
<section class="section" data-group="gameplay" data-section="" id="stories">
<h2>Истории и маршруты</h2><div class="anchor" id="stories-diagrams"></div>
<p class="lead">Story‑дуги: RouteStory (derived) и EventStory (quest). Прогресс, бонусы, отображение.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>RouteStory derived из фактов посещений/квестов; EventStory задаётся релизом.</li><li>Награды истории = отдельные транзакции.</li><li>Истории — «пакеты опыта» для релизов.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>RouteStory (derived) строится из посещений/квестов; EventStory задаётся контентом.</li><li>Прогресс истории = агрегат по стопам (можно пересчитать).</li><li>Награды истории коммитятся как отдельные транзакции.</li><li>Истории — основной «пакетируемый» опыт для релизов.</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#stories-contracts">Контракты</a>
<a class="miniPill" href="#stories-diagrams">Диаграммы</a>
<a class="miniPill" href="#stories-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="stories-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage / Sequence (встроенные SVG)</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button><button class="diagramTab" data-diagtab="sequence" type="button">Sequence</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Поток (Stories)</text><path d="M210 100.0 C 225.0 100.0, 225.0 95.0, 240 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="211.0" y="91.5">build</text><path d="M410 95.0 C 430.0 95.0, 430.0 95.0, 450 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="416.0" y="89.0">merge</text><path d="M620 95.0 C 635.0 95.0, 635.0 100.0, 650 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="621.0" y="91.5">complete</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="92.0">Facts</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="108.0">(visits/quests)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="240" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="87.0">Derive RouteStory</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="103.0">(rules)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="450" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="87.0">EventStory</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="103.0">(scripted release)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="120" x="650" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="664" y="92.0">Story reward</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="664" y="108.0">commit</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow2" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Состояния истории</text><path d="M200 120 C 290.0 120, 290.0 120, 380 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="272.0" y="112.0">unlock</text><path d="M380 120 C 470.0 120, 470.0 120, 560 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="452.0" y="112.0">complete</text><circle cx="200" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="200" y="124">Locked</text><circle cx="380" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="380" y="124">Active</text><circle cx="560" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="560" cy="120" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="560" y="124">Done</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Хранение и награды</text><path d="M290 95.0 C 305.0 95.0, 305.0 100.0, 320 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="291.0" y="91.5">derive</text><path d="M520 100.0 C 540.0 100.0, 540.0 95.0, 560 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="526.0" y="91.5">commit</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="210" x="80" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="87.0">DB facts</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="103.0">visits + quests</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="320" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="334" y="92.0">story_progress</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="334" y="108.0">(db)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="560" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="574" y="87.0">tx_log</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="574" y="103.0">story rewards</text></svg></div><div class="diagramPane" data-diagpane="sequence"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow3" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Sequence (story completion)</text><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="62.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="117.5" y="44">UI</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="117.5" x2="117.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="237.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="292.5" y="44">Story</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="292.5" x2="292.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="412.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="467.5" y="44">Rewards</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="467.5" x2="467.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="587.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="642.5" y="44">DB</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="642.5" x2="642.5" y1="52" y2="242"></line><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="117.5" x2="292.5" y1="90" y2="90"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="205.0" y="84">story_step</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="292.5" x2="642.5" y1="120" y2="120"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="467.5" y="114">progress save</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="292.5" x2="467.5" y1="150" y2="150"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="380.0" y="144">reward_calc</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="467.5" x2="642.5" y1="180" y2="180"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="555.0" y="174">append tx_log</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="642.5" x2="117.5" y1="210" y2="210"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="380.0" y="204">render feed</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>RouteStory derived</li><li>EventStory scripted</li><li>Story progress</li><li>Story rewards</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="story_step
route_completed
eventstory_completed
story_reward_commit"><li>story_step</li><li>route_completed</li><li>eventstory_completed</li><li>story_reward_commit</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="stories.progressById
routes.visits
stories.unlocked
story.rewards"><li>stories.progressById</li><li>routes.visits</li><li>stories.unlocked</li><li>story.rewards</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Derived истории восстанавливаются</li><li>Награды отдельными транзакциями</li><li>Смена релиза не ломает прогресс</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">DB</div><div class="storageV">route visits, story progress, story rewards</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Local</div><div class="storageV">story UI cache</div><div class="rwTag">Читаем: да • Пишем: да (кэш)</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">none in MVP</div><div class="rwTag">Читаем: нет • Пишем: нет</div></div></div></details></div>
<p class="ruNote">Истории/маршруты — способ «упаковать» опыт в понятные блоки. RouteStory можно вывести из фактов посещений и квестов, а EventStory задаётся контентом как «сценарий».</p><p class="ruNote">Преимущество такой схемы — простая поддержка релизов: историю можно доставить в bundle, а прогресс всегда можно восстановить из фактов/транзакций.</p>
<div class="grid two">
<div class="panel">
<div class="section-title">Two long-arc mechanisms</div>
<div class="anchor" id="stories-contracts"></div><pre>1) RouteStory:
   - curated "route" (sequence of locations)
   - completion derived from stop satisfaction
2) EventStory:
   - time-bound / themed multi-location quest
   - has main character + QR/check-in</pre>
<div class="section-title">RouteStory content (copy)</div>
<div class="copyrow"><span class="label">route JSON:</span><button class="btn" data-copy="#routeJson">Copy</button></div>
<pre id="routeJson">{
  "id":"story.route_oldtown",
  "title":"Old Town Highlights",
  "curator":"storyteller.curated",
  "stops":[
    {"location_id":"loc.lviv_001","require":"visited"},
    {"location_id":"loc.lviv_003","require":"quest_completed:quest.q1"},
    {"location_id":"loc.lviv_007","require":"visited"}
  ],
  "reward":{"points":60,"badge_id":"badge.route_oldtown"}
}</pre>
</div>
<div class="panel">
<div class="section-title">Derived progress logic</div>
<pre>- for each stop:
  - visited = location_first_visit completed
  - quest_completed = quest_id in completed_set
- story completed when all stops satisfied
- on completion:
  - commit points (idempotent)
  - unlock story badge (idempotent)</pre>
<div class="section-title">Where to surface in UI</div>
<pre>- Discover: "Featured story" card
- Location: story stop indicator ("This place is a stop in …")
- Profile: Stories tab (completed / in-progress)</pre>
<div class="callout"><b>MVP friendly:</b> RouteStory requires zero new engine if derived from existing state sets.</div>
</div>
</div>
<div class="anchor" id="stories-qa"></div><div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#quests">Квесты и многолокационные события</a><a class="relatedLink" href="#content">Контент-релизы и валидация</a><a class="relatedLink" href="#points">Очки и экономика</a></div></div><div class="dodBox" id="stories-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>RouteStory восстанавливается из фактов</li><li>Награды истории транзакционные</li><li>Смена релиза не ломает прогресс</li></ul></div></section>
<section class="section" data-group="business" data-section="" id="monetization">
<h2>Монетизация (билеты/мерч/подписка ×2)</h2><div class="anchor" id="monetization-diagrams"></div>
<p class="lead">Модель монетизации без платежных данных: entitlements / collectibles / membership.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Модель прав (entitlements) раньше оплат.</li><li>Membership меняет множители/доступ, но не ломает core loop.</li><li>События и аналитика — без платежных атрибутов.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>В MVP — модель entitlements и предметов; оплату можно подставить позже.</li><li>Membership влияет на мультипликаторы/доступ/витрины, но не ломает core loop.</li><li>Билеты/мерч = «права/скины/коллекции» с источником выдачи.</li><li>Никаких платежных реквизитов и PII в аналитике/событиях.</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#monetization-contracts">Контракты</a>
<a class="miniPill" href="#monetization-diagrams">Диаграммы</a>
<a class="miniPill" href="#monetization-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="monetization-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage / Sequence (встроенные SVG)</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button><button class="diagramTab" data-diagtab="sequence" type="button">Sequence</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Поток (Business / Entitlements)</text><path d="M210 100.0 C 225.0 100.0, 225.0 95.0, 240 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="211.0" y="91.5">unlock</text><path d="M410 95.0 C 430.0 95.0, 430.0 95.0, 450 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="416.0" y="89.0">tier</text><path d="M620 95.0 C 635.0 95.0, 635.0 100.0, 650 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="621.0" y="91.5">apply</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="92.0">Entitlements</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="108.0">(grant)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="240" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="87.0">Inventory</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="103.0">(items)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="450" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="87.0">Membership</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="103.0">multiplier</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="120" x="650" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="664" y="92.0">UX gating</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="664" y="108.0">(access)</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow2" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Состояния подписки</text><path d="M220 120 C 320.0 120, 320.0 120, 420 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="302.0" y="112.0">upgrade</text><path d="M420 120 C 520.0 120, 520.0 120, 620 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="502.0" y="112.0">upgrade</text><circle cx="220" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="220" y="124">Free</text><circle cx="420" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="420" cy="120" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="420" y="124">Member</text><circle cx="620" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="620" cy="120" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="620" y="124">Premium</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Хранение и аналитика</text><path d="M540 100.0 C 310.0 100.0, 310.0 95.0, 80 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="296.0" y="91.5">hydrate</text><path d="M780 95.0 C 430.0 95.0, 430.0 95.0, 80 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="416.0" y="89.0">(no PII)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="220" x="80" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="87.0">DB entitlements</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="103.0">+ inventory</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="340" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="354" y="92.0">Offers cache</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="354" y="108.0">(local)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="580" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="594" y="87.0">Telemetry</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="594" y="103.0">(offer viewed)</text></svg></div><div class="diagramPane" data-diagpane="sequence"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow3" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Sequence (membership)</text><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="62.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="117.5" y="44">UI</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="117.5" x2="117.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="237.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="292.5" y="44">Entitlements</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="292.5" x2="292.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="412.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="467.5" y="44">DB</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="467.5" x2="467.5" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="587.5" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="642.5" y="44">Telemetry</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="642.5" x2="642.5" y1="52" y2="242"></line><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="117.5" x2="292.5" y1="90" y2="90"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="205.0" y="84">membership_changed</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="292.5" x2="467.5" y1="120" y2="120"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="380.0" y="114">save entitlement</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="117.5" x2="642.5" y1="150" y2="150"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="380.0" y="144">offer_viewed</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="467.5" x2="117.5" y1="200" y2="200"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="292.5" y="194">updated gating</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>Entitlements</li><li>Collectibles</li><li>Membership ×2</li><li>Storefront (stub)</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="entitlement_granted
membership_changed
item_unlocked
offer_viewed"><li>entitlement_granted</li><li>membership_changed</li><li>item_unlocked</li><li>offer_viewed</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="entitlements.byId
inventory.items
membership.multiplier
offers.cache"><li>entitlements.byId</li><li>inventory.items</li><li>membership.multiplier</li><li>offers.cache</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Без платёжных данных</li><li>Entitlements проверяются локально</li><li>Graceful fallback без сети</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">DB</div><div class="storageV">entitlements + inventory</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Local</div><div class="storageV">offers cache</div><div class="rwTag">Читаем: да • Пишем: да (кэш)</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">store provider later</div><div class="rwTag">Читаем: да • Пишем: да</div></div></div></details></div>
<p class="ruNote">Мы проектируем монетизацию как модель прав и предметов (entitlements), а не как платежный модуль. Это безопасно для MVP и ускоряет интеграцию позже (провайдер можно заменить без поломки логики).</p><p class="ruNote">Membership и покупки должны влиять только на множители/доступ/витрины. Core loop остаётся тем же — иначе появится две версии продукта.</p>
<div class="grid two">
<div class="panel">
<div class="section-title">MVP monetization modeling</div>
<div class="anchor" id="monetization-contracts"></div><pre>- Tickets:
  - record as entitlement (event_id)
  - optional: unlock access to event story
- Merch:
  - record as collectible (nft/physical)
  - affects Collector badges counters
- Membership:
  - boolean flag
  - points multiplier ×2 (eligible sources)</pre>
<div class="section-title">Entitlement/collectible state (copy)</div>
<div class="copyrow"><span class="label">entitlements:</span><button class="btn" data-copy="#entitlements">Copy</button></div>
<pre id="entitlements">{
  "tickets":[{"id":"t1","event_id":"event.biennale_01","at":1735689600}],
  "collectibles":[{"id":"nft.001","kind":"nft","at":1735689700,"meta":{"title":"AF Token #1"}}],
  "membership":{"active":true,"since":1735689000}
}</pre>
</div>
<div class="panel">
<div class="section-title">MVP rules (safe)</div>
<pre>- no payment details stored
- receipts/transactions handled externally (later)
- app only stores:
  - entitlement ids
  - collectible ids + metadata
  - membership active flag</pre>
<div class="section-title">Gating (optional)</div>
<pre>- event_story can require ticket:
  - if no ticket → show CTA (buy ticket)
  - allow "preview" mode (read-only) for MVP</pre>
<div class="section-title">Telemetry (consent)</div>
<pre>- entitlement_added {kind, ref_id}
- membership_toggled {active}
(no price, no payment provider, no personal details)</pre>
</div>
</div>
<div class="anchor" id="monetization-qa"></div><div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#points">Очки и экономика</a><a class="relatedLink" href="#telemetry">Телеметрия (MVP-safe)</a></div></div><div class="dodBox" id="monetization-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>Entitlements модель без платежных данных</li><li>Membership ×2 не ломает core loop</li><li>Fallback без сети не блокирует UX</li></ul></div></section>
<section class="section" data-group="business" data-section="" id="persona">
<h2>Persona Radar (архетипы)</h2>
<p class="lead">Persona Radar: счётчики по архетипам, нормализация и рекомендации контента.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Радар строится из counters, с порогом данных и сглаживанием.</li><li>Используем для рекомендаций, не для блокировки контента.</li><li>Персонализацию можно выключить.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>Persona Radar = вектор по архетипам из локальных счетчиков.</li><li>Нормализация: веса, сглаживание, минимум данных прежде чем показывать выводы.</li><li>Использование: рекомендации квестов/персонажей/историй, но без «профилирования личности».</li><li>Только агрегаты — никаких сырых траекторий перемещения в облако.</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#persona-contracts">Контракты</a>
<a class="miniPill" href="#persona-diagrams">Диаграммы</a>
<a class="miniPill" href="#persona-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="persona-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage / Sequence (встроенные SVG)</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button><button class="diagramTab" data-diagtab="sequence" type="button">Sequence</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Поток (Persona Radar)</text><path d="M210 100.0 C 225.0 100.0, 225.0 95.0, 240 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="211.0" y="91.5">update</text><path d="M410 95.0 C 430.0 95.0, 430.0 95.0, 450 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="416.0" y="89.0">render</text><path d="M620 95.0 C 635.0 95.0, 635.0 100.0, 650 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="621.0" y="91.5">use</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="92.0">Signals</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="108.0">(events)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="240" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="87.0">Counters</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="254" y="103.0">(normalize)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="450" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="87.0">Radar snapshot</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="464" y="103.0">(UI)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="120" x="650" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="664" y="92.0">Reco hooks</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="664" y="108.0">(optional)</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow2" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Состояния качества профиля</text><path d="M220 120 C 320.0 120, 320.0 120, 420 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="302.0" y="112.0">enough data</text><path d="M420 120 C 520.0 120, 520.0 120, 620 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="502.0" y="112.0">stable</text><circle cx="220" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="220" y="124">Cold</text><circle cx="420" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="420" y="124">Warm</text><circle cx="620" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="620" cy="120" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="620" y="124">Hot</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Хранение и UX</text><path d="M300 95.0 C 320.0 95.0, 320.0 100.0, 340 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="306.0" y="91.5">derive</text><path d="M780 95.0 C 560.0 95.0, 560.0 100.0, 340 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="546.0" y="91.5">hide</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="220" x="80" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="94" y="95.0">DB persona counters</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="340" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="354" y="92.0">Radar snapshot</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="354" y="108.0">(local)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="580" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="594" y="87.0">Opt-out flag</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="594" y="103.0">(settings)</text></svg></div><div class="diagramPane" data-diagpane="sequence"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow3" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Sequence (radar update)</text><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="91.66666666666669" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="146.66666666666669" y="44">UI</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="146.66666666666669" x2="146.66666666666669" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="325.00000000000006" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="380.00000000000006" y="44">Persona</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="380.00000000000006" x2="380.00000000000006" y1="52" y2="242"></line><rect fill="currentColor" fill-opacity="0.10" height="26" rx="10" stroke="currentColor" stroke-opacity="0.20" width="110" x="558.3333333333334" y="26"></rect><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="613.3333333333334" y="44">DB</text><line stroke="currentColor" stroke-dasharray="3 6" stroke-opacity="0.18" stroke-width="2" x1="613.3333333333334" x2="613.3333333333334" y1="52" y2="242"></line><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="146.66666666666669" x2="380.00000000000006" y1="90" y2="90"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="263.33333333333337" y="84">persona_signal</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="380.00000000000006" x2="613.3333333333334" y1="120" y2="120"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="496.66666666666674" y="114">update counters</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="613.3333333333334" x2="380.00000000000006" y1="150" y2="150"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="496.66666666666674" y="144">new vector</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2" x1="380.00000000000006" x2="146.66666666666669" y1="200" y2="200"></line><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" text-anchor="middle" x="263.33333333333337" y="194">radar_updated</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>Counters</li><li>Normalization</li><li>Radar UI</li><li>Recommendation hooks</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="persona_signal
radar_updated
reco_shown
reco_clicked"><li>persona_signal</li><li>radar_updated</li><li>reco_shown</li><li>reco_clicked</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="persona.vector
persona.weights
radar.lastUpdated
reco.history"><li>persona.vector</li><li>persona.weights</li><li>radar.lastUpdated</li><li>reco.history</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Порог данных до отображения</li><li>Сглаживание от шума</li><li>Можно выключить персонализацию</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">DB</div><div class="storageV">persona counters</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Local</div><div class="storageV">radar snapshot</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">none in MVP</div><div class="rwTag">Читаем: нет • Пишем: нет</div></div></div></details></div>
<p class="ruNote">Persona Radar — это инструмент персонализации, а не психологический профиль. Мы строим его из счётчиков взаимодействий и выбираем консервативную нормализацию, чтобы не «перегнуть».</p><p class="ruNote">Радар используется для рекомендации контента и персонажей, но не для принятия «жёстких» решений. В MVP достаточно показать мягкую подсказку: какие архетипы сейчас доминируют.</p>
<div class="grid two">
<div class="panel">
<div class="anchor" id="persona-diagrams"></div><div class="svgcard">
<svg viewbox="0 0 980 420" xmlns="http://www.w3.org/2000/svg">
<defs>
<style>
      .grid{stroke:rgba(0,0,0,.18);stroke-width:2;fill:none}
      .axis{stroke:rgba(0,0,0,.28);stroke-width:2}
      .lbl{font: 14px ui-sans-serif, system-ui; fill: rgba(16,16,16,.80)}
      .note{font: 12px ui-sans-serif, system-ui; fill: rgba(16,16,16,.62)}
      .poly{fill:rgba(0,0,0,.08);stroke:rgba(0,0,0,.40);stroke-width:2}
    </style>
</defs>
<text class="note" x="32" y="34">Persona Radar (derived): weights from archetype interactions counters</text>
<g transform="translate(490,220)">
<circle class="grid" r="150"></circle>
<circle class="grid" r="110"></circle>
<circle class="grid" r="70"></circle>
<circle class="grid" r="30"></circle>
<line class="axis" x1="0" x2="0" y1="0" y2="-160"></line>
<line class="axis" x1="0" x2="160" y1="0" y2="0"></line>
<line class="axis" x1="0" x2="0" y1="0" y2="160"></line>
<line class="axis" x1="0" x2="-160" y1="0" y2="0"></line>
<polygon class="poly" points="0,-120 88,0 0,56 -96,0"></polygon>
</g>
<text class="lbl" text-anchor="middle" x="490" y="44">Historian</text>
<text class="lbl" text-anchor="middle" x="848" y="224">Art Dealer</text>
<text class="lbl" text-anchor="middle" x="490" y="404">Layperson</text>
<text class="lbl" text-anchor="middle" x="132" y="224">Gallerist</text>
<text class="note" x="32" y="392">MVP: store only aggregated counters; never send raw dialog or raw search queries.</text>
</svg>
</div>
<div class="section-title">Counters model</div>
<div class="anchor" id="persona-contracts"></div><pre>- interaction counted on:
  - opening character dialog (optional)
  - completing quest with archetype owner
  - answering questions tagged with archetype
- counters stored as aggregated integers</pre>
<div class="section-title">Counters (copy)</div>
<div class="copyrow"><span class="label">personaCounters:</span><button class="btn" data-copy="#personaCounters">Copy</button></div>
<pre id="personaCounters">{
  "Gallerist": 7,
  "ArtDealer": 5,
  "Historian": 3,
  "Layperson": 6
}</pre>
</div>
<div class="panel">
<div class="section-title">Weighting &amp; smoothing</div>
<pre>- simple normalize:
  w[a] = cnt[a] / max(cnt)
- alternative:
  w[a] = cnt[a] / sum(cnt)
- optional smoothing:
  cnt[a] = cnt[a]*0.98 per day (later)</pre>
<div class="section-title">UX usage</div>
<pre>- show radar chart
- show "leaning towards X"
- suggest content:
  - if ArtDealer high → show auctions/collectibles route
  - if Historian high → show contextual stories</pre>
<div class="callout"><b>Constraint:</b> do NOT turn this into psychological profiling. It’s a game mechanic derived only from in-app events.</div>
</div>
</div>
<div class="anchor" id="persona-qa"></div><div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#characters">Персонажи и взаимодействие</a><a class="relatedLink" href="#telemetry">Телеметрия (MVP-safe)</a><a class="relatedLink" href="#core_loop">Основная петля игры</a></div></div><div class="dodBox" id="persona-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>Радар показывается после порога данных</li><li>Персонализацию можно отключить</li><li>Рекомендации не блокируют контент</li></ul></div></section>
<section class="section" data-group="ops" data-section="" id="telemetry">
<h2>Телеметрия (MVP-safe)</h2><div class="anchor" id="telemetry-diagrams"></div>
<p class="lead">MVP‑safe телеметрия: opt‑in, allowlist payload, fail‑open, без PII.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Opt-in, allowlist payload, размер/частота ограничены.</li><li>Fail-open: отправка аналитики не влияет на UX.</li><li>Разделяем продуктовую аналитику и QA диагностику.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>Opt-in согласие, allowlist payload, fail-open (не ломаем UX).</li><li>События минимальны: screen, click, quest_state, reward_commit, error.</li><li>Разделение: product analytics vs QA diagnostics.</li><li>Тестовая матрица: что эмитим, когда, и как проверяем.</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#telemetry-contracts">Контракты</a>
<a class="miniPill" href="#telemetry-diagrams">Диаграммы</a>
<a class="miniPill" href="#telemetry-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="telemetry-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage (встроенные SVG)</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<g opacity="0.10"><path d="M0 0H760V240H0Z" fill="none"></path></g><text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Пайплайн телеметрии</text><path d="M210 100.0 C 230.0 100.0, 230.0 95.0, 250 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="220.0" y="91.5">sanitize</text><path d="M420 95.0 C 440.0 95.0, 440.0 95.0, 460 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="430.0" y="89.0">enqueue</text><path d="M630 95.0 C 650.0 95.0, 650.0 100.0, 670 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="640.0" y="91.5">flush</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="92.0">UI events</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="108.0">(screen/action)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="250" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="264" y="87.0">Allowlist</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="264" y="103.0">payload</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="460" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="474" y="87.0">Queue + batch</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="474" y="103.0">(local)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="120" x="670" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="684" y="92.0">Upload</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="684" y="108.0">(remote)</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow2" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Consent / flush</text><path d="M180 120 C 270.0 120, 270.0 120, 360 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="252.0" y="112.0">consent</text><path d="M360 120 C 270.0 120, 270.0 120, 180 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="252.0" y="112.0">withdraw</text><path d="M360 120 C 450.0 120, 450.0 120, 540 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="432.0" y="112.0">timer</text><circle cx="180" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="180" y="124">Opt-out</text><circle cx="360" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="360" y="124">Opt-in</text><circle cx="540" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="540" y="124">Flush</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<g opacity="0.10"><path d="M0 0H760V240H0Z" fill="none"></path></g><text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Storage touchpoints</text><path d="M260 100.0 C 280.0 100.0, 280.0 100.0, 300 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="270.0" y="94.0">send</text><path d="M760 95.0 C 410.0 95.0, 410.0 100.0, 60 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="400.0" y="91.5">append</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="60" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="74" y="92.0">Local queue</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="74" y="108.0">(events)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="300" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="314" y="92.0">Remote endpoint</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="314" y="108.0">(batch)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="220" x="540" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="554" y="87.0">QA diagnostics</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="554" y="103.0">(error/perf)</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>Event emitter</li><li>Allowlist payload</li><li>Batcher</li><li>QA diagnostics</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="screen_view
ui_action
quest_state
error
perf_metric"><li>screen_view</li><li>ui_action</li><li>quest_state</li><li>error</li><li>perf_metric</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="telemetry.optIn
telemetry.queue
telemetry.lastFlush
telemetry.failCount"><li>telemetry.optIn</li><li>telemetry.queue</li><li>telemetry.lastFlush</li><li>telemetry.failCount</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Fail-open</li><li>Payload size limits</li><li>PII lint (test)</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">Local</div><div class="storageV">event queue, failCount</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">batch upload endpoint</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">DB</div><div class="storageV">(опционально) diagnostics log</div><div class="rwTag">Читаем: да • Пишем: да</div></div></div></details></div>
<p class="ruNote">Телеметрия нужна для двух задач: понять, где пользователи «ломаются» в воронке, и поймать технические ошибки. В MVP это решается минимальным набором событий и строгим allowlist payload.</p><p class="ruNote">Ключевой принцип: телеметрия не должна быть критическим путём. Если аналитика не отправилась — пользователь всё равно получает награду и прогресс.</p>
<div class="grid two">
<div class="panel">
<div class="section-title">MVP-safe telemetry principles</div>
<div class="anchor" id="telemetry-contracts"></div><pre>- consent gated (opt-in)
- allowlist payload keys
- never send:
  - raw dialog text
  - raw search queries
  - exact GPS
  - personal identifiers</pre>
<div class="section-title">Core funnel events</div>
<pre>- product_app_opened
- product_screen_viewed {screen_id, duration_ms}
- product_location_opened {location_id}
- game_quest_started {quest_id, location_id}
- game_quest_completed {quest_id, points_delta}
- economy_badge_unlocked {badge_id, tier, source_event}</pre>
<div class="section-title">Search telemetry (safe)</div>
<pre>- discover_search_used {query_len_bucket, filters_count}
- discover_filter_applied {city, tags_count, status}</pre>
</div>
<div class="panel">
<div class="section-title">Allowlist mapping (copy)</div>
<div class="copyrow"><span class="label">allowlist sample:</span><button class="btn" data-copy="#allowlist">Copy</button></div>
<pre id="allowlist">{
  "product_location_opened":["location_id"],
  "game_quest_completed":["quest_id","points_delta"],
  "economy_badge_unlocked":["badge_id","tier","source_event"],
  "discover_search_used":["query_len_bucket","filters_count"]
}</pre>
<div class="section-title">Emission policy</div>
<pre>- enqueue locally (telemetry_queue)
- flush on connectivity (optional)
- drop policy:
  - keep last N events
  - never block UI
  - never throw if queue fails</pre>
<div class="anchor" id="telemetry-qa"></div><details style="margin-top:12px">
<summary>QA checks (telemetry)</summary>
<div class="muted" style="margin-top:8px;line-height:1.6">
    1) Telemetry off: no events emitted, gameplay unaffected.
    2) Telemetry on: payloads pass allowlist validation.
    3) Search telemetry: no raw query appears in payload.
  </div>
</details>
</div>
</div>
<div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#core_loop">Основная петля игры</a><a class="relatedLink" href="#badges">Бейджи</a><a class="relatedLink" href="#content">Контент-релизы и валидация</a></div></div><div class="dodBox" id="telemetry-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>Opt-in включен/выключен корректно</li><li>Allowlist payload + size limits</li><li>Fail-open: UX не зависит от отправки</li></ul></div></section>
<section class="section" data-group="ops" data-section="" id="content">
<h2>Контент-релизы и валидация</h2><div class="anchor" id="content-diagrams"></div>
<p class="lead">Контент‑релизы: структура бандла, схемы, проверки ссылок/ассетов и rollback.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Bundle schema + cross-ref validation обязательны.</li><li>Semver/совместимость фиксируем и тестируем.</li><li>Rollback — переключение активной версии + повторная валидация.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>Release bundle содержит: места/квесты/персонажей/бейджи/правила/локализацию.</li><li>Cross-ref validation: ссылки на assets, ids, зависимости между модулями.</li><li>Версионирование: immutable + семантика совместимости.</li><li>Rollback: переключение активной версии + повторная валидация.</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#content-contracts">Контракты</a>
<a class="miniPill" href="#content-diagrams">Диаграммы</a>
<a class="miniPill" href="#content-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="content-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage (встроенные SVG)</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<g opacity="0.10"><path d="M0 0H760V240H0Z" fill="none"></path></g><text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Контент-релиз и валидация</text><path d="M210 100.0 C 230.0 100.0, 230.0 95.0, 250 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="220.0" y="91.5">load</text><path d="M420 95.0 C 440.0 95.0, 440.0 95.0, 460 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="430.0" y="89.0">pass</text><path d="M630 95.0 C 650.0 95.0, 650.0 100.0, 670 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="640.0" y="91.5">fail</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="92.0">Download bundle</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="54" y="108.0">(remote)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="250" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="264" y="87.0">Validation</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="264" y="103.0">schema + refs</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="170" x="460" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="474" y="87.0">Activate</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="474" y="103.0">releaseId</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="120" x="670" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="684" y="92.0">Rollback</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="684" y="108.0">switch</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow2" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Состояния релиза</text><path d="M160 120 C 250.0 120, 250.0 120, 340 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="232.0" y="112.0">validate</text><path d="M340 120 C 430.0 120, 430.0 120, 520 120" fill="none" marker-end="url(#arrow2)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="412.0" y="112.0">switch</text><circle cx="160" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="160" y="124">New</text><circle cx="340" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="340" y="124">Valid</text><circle cx="520" cy="120" fill="currentColor" fill-opacity="0.10" r="20" stroke="currentColor" stroke-opacity="0.22"></circle><circle cx="520" cy="120" fill="none" r="14" stroke="currentColor" stroke-opacity="0.26" stroke-width="2"></circle><text fill="currentColor" fill-opacity="0.78" font-size="11" font-weight="900" text-anchor="middle" x="520" y="124">Active</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg aria-label="diagram" class="diagSvg" height="100%" role="img" viewbox="0 0 760 240" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.35"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="8" flood-color="rgba(0,0,0,0.18)" stddeviation="10"></fedropshadow>
</filter>
</defs>
<g opacity="0.10"><path d="M0 0H760V240H0Z" fill="none"></path></g><text fill="currentColor" fill-opacity="0.72" font-size="14" font-weight="900" x="14" y="22">Где живёт контент</text><path d="M740 95.0 C 520.0 95.0, 520.0 100.0, 300 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="510.0" y="91.5">download</text><path d="M500 100.0 C 285.0 100.0, 285.0 95.0, 70 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.28" stroke-width="2"></path><text fill="currentColor" fill-opacity="0.55" font-size="11" font-weight="800" x="275.0" y="91.5">report</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.1" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="70" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="84" y="87.0">DB</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="84" y="103.0">active release + report</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="60" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="300" y="70"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="314" y="92.0">Assets cache</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="314" y="108.0">(local)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.08" height="70" rx="16" stroke="currentColor" stroke-opacity="0.20" width="200" x="540" y="60"></rect></g><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="554" y="87.0">Bundle store</text><text fill="currentColor" fill-opacity="0.75" font-size="12" font-weight="900" x="554" y="103.0">(remote)</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>Bundle schema</li><li>Validator</li><li>Asset resolver</li><li>Release switcher</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="release_loaded
validation_failed
asset_missing
release_rolled_back"><li>release_loaded</li><li>validation_failed</li><li>asset_missing</li><li>release_rolled_back</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="release.active
release.available
validation.report
assets.cache"><li>release.active</li><li>release.available</li><li>validation.report</li><li>assets.cache</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Cross-ref валидатор</li><li>Semver совместимость</li><li>Rollback + повторная валидация</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">Local</div><div class="storageV">assets cache</div><div class="rwTag">Читаем: да • Пишем: да (кэш)</div></div><div class="storageCell"><div class="storageK">DB</div><div class="storageV">active release id, validation report</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">bundle fetch</div><div class="rwTag">Читаем: да • Пишем: да</div></div></div></details></div>
<p class="ruNote">Релизы — это «контент как код»: версии, схемы и проверки ссылок. Если мы держим это дисциплинированно, мы можем быстро выпускать новые города/маршруты без риска поломки.</p><p class="ruNote">Валидация должна ловить: битые ссылки, несоответствия id, отсутствующие assets, и несовместимость версий. Rollback — всегда возможен без миграций данных пользователя.</p>
<div class="grid two">
<div class="panel">
<div class="section-title">Release bundle structure</div>
<div class="copyrow"><span class="label">tree:</span><button class="btn" data-copy="#releaseTree">Copy</button></div>
<div class="anchor" id="content-contracts"></div><pre id="releaseTree">content/releases/v1.0.0/
  manifest.json
  schemas/
    location.schema.json
    character.schema.json
    quest.schema.json
    story.schema.json
    badge.schema.json
  locations.json
  characters.json
  quests.json
  stories.json
  badges.json
  assets/
    locations/
    characters/
    badges/</pre>
<div class="section-title">Manifest</div>
<pre>{
  "version":"v1.0.0",
  "created_at":"2026-01-02",
  "hashes":{"locations.json":"...","assets/locations/loc.lviv_001.jpg":"..."},
  "compat":{"min_app":"0.1.0"}
}</pre>
</div>
<div class="panel">
<div class="section-title">Validation gates</div>
<pre>1) Schema validation (strict, no unknown keys)
2) Cross-ref validation:
   - location ids referenced exist
   - character home_locations exist
   - quest stops location_id exist
   - badges referenced by rewards exist
3) Assets integrity:
   - required images exist
4) Rollback:
   - if any gate fails → keep last-known-good</pre>
<div class="section-title">Migration policy</div>
<pre>- IDs are stable forever
- titles/descriptions can change
- if content removed:
  - keep it in LKG
  - or mark "archived": true</pre>
<div class="callout"><b>Best practice:</b> release bundle is immutable; new changes ship as new version folder.</div>
</div>
</div>
<div class="anchor" id="content-qa"></div><div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#overview">Обзор и границы MVP</a><a class="relatedLink" href="#quests">Квесты и многолокационные события</a><a class="relatedLink" href="#devnotes">Заметки разработчика: события, DoD, QA</a></div></div><div class="dodBox" id="content-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>Валидация cross-ref/asset работает</li><li>Semver политика описана</li><li>Rollback переключает активный релиз</li></ul></div></section>
<section class="section" data-group="ops" data-section="" id="devnotes">
<h2>Заметки разработчика: события, DoD, QA</h2><div class="anchor" id="devnotes-diagrams"></div>
<p class="lead">События, ключи идемпотентности, DoD и smoke‑прогон полного цикла.</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Event dictionary — контракт (именование, payload, keys).</li><li>Idempotency keys перечислены и покрыты тестами.</li><li>Smoke suite прогоняется перед каждым релизом.</li></ul></div><div class="sectionMeta">
<div class="metaBox">
<div class="metaLabel">Ключевое</div>
<ul class="metaList"><li>Event dictionary: имена, когда эмитится, payload, idempotency keys.</li><li>Definition of Done: тест полного цикла + отказоустойчивость офлайна.</li><li>Smoke run: быстрый сценарий для регрессии перед релизом.</li><li>Контроль дублей: уникальные ключи на commit операций.</li></ul>
</div>
<div class="metaBox">
<div class="metaLabel">Быстрые переходы</div>
<div class="pillRow">
<a class="miniPill" href="#devnotes-contracts">Контракты</a>
<a class="miniPill" href="#devnotes-diagrams">Диаграммы</a>
<a class="miniPill" href="#devnotes-qa">QA / Edge cases</a>
</div>
<div class="metaHint">Если блока нет — якорь ведёт к первому подходящему месту в разделе.</div>
</div>
</div><div class="diagramPanel" id="devnotes-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage / Sequence</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button><button class="diagramTab" data-diagtab="sequence" type="button">Sequence</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="10" flood-color="rgba(0,0,0,0.18)" stddeviation="12"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Dev loop (спека → код → тест → релиз)</text><path d="M210 105.0 C 225.0 105.0, 225.0 100.0, 240 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="215.0" y="95.5">build</text><path d="M410 100.0 C 430.0 100.0, 430.0 100.0, 450 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="420.0" y="93.0">test</text><path d="M620 100.0 C 640.0 100.0, 640.0 105.0, 660 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="630.0" y="95.5">package</text><g filter="url(#softShadow)"><rect fill="var(--c-core)" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="97.0">Spec</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="113.0">(contracts)</text><g filter="url(#softShadow)"><rect fill="var(--c-core)" fill-opacity="0.14" height="80" rx="18" stroke="currentColor" stroke-opacity="0.20" width="170" x="240" y="60"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="254" y="92.0">Implementation</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="254" y="108.0">(branch)</text><g filter="url(#softShadow)"><rect fill="var(--c-ops)" fill-opacity="0.14" height="80" rx="18" stroke="currentColor" stroke-opacity="0.20" width="170" x="450" y="60"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="464" y="92.0">Smoke suite</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="464" y="108.0">+ scenarios</text><g filter="url(#softShadow)"><rect fill="var(--c-ops)" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="120" x="660" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="674" y="97.0">Release</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="674" y="113.0">bundle</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="10" flood-color="rgba(0,0,0,0.18)" stddeviation="12"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Состояния артефактов (упрощенно)</text><path d="M230 110.0 C 245.0 110.0, 245.0 105.0, 260 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="235.0" y="100.5">review</text><path d="M450 105.0 C 465.0 105.0, 465.0 105.0, 480 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="455.0" y="98.0">build</text><path d="M670 105.0 C 685.0 105.0, 685.0 110.0, 700 110.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="675.0" y="100.5">merge</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.09" height="60" rx="18" stroke="currentColor" stroke-opacity="0.20" width="190" x="40" y="80"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="110.0">Draft spec</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="190" x="260" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="274" y="105.0">Stable contracts</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="190" x="480" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="494" y="105.0">Feature branch</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.09" height="60" rx="18" stroke="currentColor" stroke-opacity="0.20" width="160" x="700" y="80"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="714" y="102.0">Main</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="714" y="118.0">(tag)</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="10" flood-color="rgba(0,0,0,0.18)" stddeviation="12"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Dev storage touchpoints</text><path d="M260 105.0 C 280.0 105.0, 280.0 100.0, 300 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="270.0" y="95.5">pipeline</text><path d="M760 105.0 C 530.0 105.0, 530.0 100.0, 300 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="520.0" y="95.5">validate</text><g filter="url(#softShadow)"><rect fill="var(--c-core)" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="220" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="97.0">Repo</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="113.0">(branches/tags)</text><g filter="url(#softShadow)"><rect fill="var(--c-ops)" fill-opacity="0.12" height="80" rx="18" stroke="currentColor" stroke-opacity="0.20" width="200" x="300" y="60"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="314" y="92.0">Artifacts</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="314" y="108.0">(build, reports)</text><g filter="url(#softShadow)"><rect fill="var(--c-ops)" fill-opacity="0.14" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="220" x="540" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="554" y="97.0">Content release bundles</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="554" y="113.0">(immutable)</text></svg></div><div class="diagramPane" data-diagpane="sequence"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 300" width="100%">
<defs>
<marker id="arrow3" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Sequence (CI smoke)</text><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="59.5" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="117.5" y="50">Dev</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="117.5" x2="117.5" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="234.5" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="292.5" y="50">CI</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="292.5" x2="292.5" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="409.5" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="467.5" y="50">App</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="467.5" x2="467.5" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="584.5" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="642.5" y="50">DB</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="642.5" x2="642.5" y1="64" y2="282"></line><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="117.5" x2="292.5" y1="96" y2="96"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="205.0" y="89">push</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="292.5" x2="467.5" y1="126" y2="126"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="380.0" y="119">run smoke</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="467.5" x2="642.5" y1="156" y2="156"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="555.0" y="149">hydrate</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="467.5" x2="292.5" y1="186" y2="186"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="380.0" y="179">report</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="292.5" x2="117.5" y1="226" y2="226"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="205.0" y="219">status</text></svg></div></div></div><div class="implWrap"><div class="implTitle">Реализация (MVP)</div><div class="implGrid"><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M4 7h16M4 12h16M4 17h16"></path></svg><span>Компоненты</span></div><ul class="implList"><li>Event dictionary</li><li>Idempotency keys</li><li>DoD checklist</li><li>Smoke suite</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M7 14l3-3 3 2 4-5"></path><path d="M4 18V6"></path><path d="M4 18h16"></path></svg><span>События</span><button class="copyBtn" data-copy="events" type="button">копировать</button></div><ul class="implList" data-copytext="(контрактные)
(диагностические)
(эксперименты)"><li>(контрактные)</li><li>(диагностические)</li><li>(эксперименты)</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M12 2v20"></path><path d="M4 7h16"></path><path d="M4 17h16"></path></svg><span>State keys</span><button class="copyBtn" data-copy="state" type="button">копировать</button></div><ul class="implList" data-copytext="keys.idempotency
qa.smokeResults
build.version
flags.experiments"><li>keys.idempotency</li><li>qa.smokeResults</li><li>build.version</li><li>flags.experiments</li></ul></div><div class="implCol"><div class="implH"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 12l2 2 4-4"></path><path d="M7 3h10v18H7z"></path></svg><span>QA / Edge cases</span></div><ul class="implList"><li>Полный e2e сценарий</li><li>Регрессия на релизах</li><li>Логи ошибок без PII</li></ul></div></div><details class="storageDetails"><summary>Storage touchpoints (где читаем/пишем)</summary><div class="storageGrid"><div class="storageCell"><div class="storageK">Local</div><div class="storageV">smoke results cache</div><div class="rwTag">Читаем: да • Пишем: да (кэш)</div></div><div class="storageCell"><div class="storageK">DB</div><div class="storageV">(опционально) qa logs</div><div class="rwTag">Читаем: да • Пишем: да</div></div><div class="storageCell"><div class="storageK">Remote</div><div class="storageV">CI artifacts</div><div class="rwTag">Читаем: да • Пишем: да</div></div></div></details></div>
<p class="ruNote">Этот раздел — для команды: какие события считаются контрактом, какие ключи идемпотентности обязательны, и что должно пройти smoke-тест перед выпуском.</p><p class="ruNote">Если сомневаемся — тестируем полный цикл: Discover → Location → Quest → Reward → Badges/Stories → Telemetry. Это минимальная гарантия, что мы не сломали «скелет» продукта.</p>
<div class="grid two">
<div class="panel">
<div class="section-title">Event dictionary (MVP)</div>
<div class="anchor" id="devnotes-contracts"></div><pre>product_screen_viewed
product_location_opened
character_discovered
game_quest_started
game_quest_stop_completed
game_quest_completed
economy_points_added
economy_badge_unlocked
story_route_completed
event_story_completed
collectible_acquired
membership_toggled</pre>
<div class="section-title">Idempotency keys</div>
<pre>- quest completion: quest_id
- story completion: story_id
- location first visit: location_id
- character discovery: character_id
- badge unlock: badge_id
- points tx: tx.{source}.{ref}</pre>
<div class="section-title">Quest DoD</div>
<pre>- illegal transitions prevented
- stop gates enforced
- completion reward committed once
- state survives reload</pre>
</div>
<div class="panel">
<div class="section-title">Definition of Done (copy)</div>
<div class="copyrow"><span class="label">DoD:</span><button class="btn" data-copy="#dod">Copy</button></div>
<pre id="dod">[ ] Discover: filters deterministic, stable sort, navigation contracts
[ ] Quest Engine: illegal transitions prevented, rewards once
[ ] Economy: tx_log idempotent, membership multiplier works
[ ] Badges: unlock idempotent, rules covered by tests
[ ] Stories/Event Stories: completion derived correctly, bonus awarded
[ ] Telemetry: consent-gated + allowlist passes + fail-open
[ ] Content releases: validate schema/refs/assets + rollback works</pre>
<div class="section-title">Smoke run</div>
<pre>1) Discover → open location → meet character
2) Start quest → complete stops → complete quest
3) Points added → badge unlocked → toast
4) Apply filters/search → list updates
5) Complete route story → bonus points + badge
6) Telemetry on/off toggle works</pre>
<div class="callout"><b>Testing tip:</b> keep deterministic “seed content pack” to make QA repeatable.</div>
</div>
</div>
<hr class="sep"/><div class="footerNote">
          Дальше могу “развернуть ещё глубже” — по одному разделу в отдельную HTML‑страницу: с sequence diagrams,
          таблицами правил, и готовыми интерфейсами TS (types + reducers + selectors).
          </div>
<div class="anchor" id="devnotes-qa"></div><div class="relatedBox"><div class="relatedTitle">Связанные разделы</div><div class="relatedRow"><a class="relatedLink" href="#telemetry">Телеметрия (MVP-safe)</a><a class="relatedLink" href="#content">Контент-релизы и валидация</a><a class="relatedLink" href="#core_loop">Основная петля игры</a></div></div><div class="dodBox" id="devnotes-dod"><div class="dodTitle">Definition of Done (MVP)</div><ul class="dodList"><li>Event dictionary актуален</li><li>Smoke suite запускается быстро</li><li>Idempotency keys перечислены</li></ul></div></section>
</div>
</article>
</div>
<section class="section" data-group="ops" id="heatmap"><h2>Heatmap зависимостей компонентов</h2><p class="lead">Матрица зависимостей «кто кого трогает» (данные/события/UX). Наведи — выделится строка/колонка; кликни — получишь объяснение связи.</p>
<div aria-label="Heatmap controls" class="heatControls">
<div class="heatControlsRow">
<div aria-label="View mode" class="heatToggleGroup" role="group">
<button class="heatViewBtn isOn" data-view="matrix" type="button">Matrix</button>
<button class="heatViewBtn" data-view="graph" type="button">Graph</button>
</div>
<div aria-label="Dependency types" class="heatToggleGroup" role="group">
<button class="heatTypeBtn isOn" data-type="data" type="button">Data</button>
<button class="heatTypeBtn isOn" data-type="events" type="button">Events</button>
<button class="heatTypeBtn isOn" data-type="ux" type="button">UX</button>
</div>
</div>
<div class="heatControlsRow">
<label class="heatRange">
<span class="heatRangeLabel">Минимальная сила</span>
<input class="heatRangeInput" max="4" min="0" step="1" type="range" value="1"/>
<span class="heatRangeValue">≥ 1</span>
</label>
<label class="heatCheck">
<input class="heatCheckInput" type="checkbox"/>
<span>Только сильные (≥3)</span>
</label>
<label class="heatHop">
<span class="heatHopLabel">Окружение</span>
<select class="heatHopSelect isHidden">
<option value="0">0 hops</option>
<option selected="" value="1">1 hop</option>
<option value="2">2 hops</option>
</select>
<div aria-label="Окружение hops" class="heatHopSeg" role="group">
<button class="heatHopBtn isOn" data-hop="0" type="button">0</button>
<button class="heatHopBtn isOn" data-hop="1" type="button">1</button>
<button class="heatHopBtn" data-hop="2" type="button">2</button>
</div>
<label class="heatIso">
<input class="heatIsoInput" type="checkbox"/>
<span>Изолировать subgraph</span>
</label>
</label>
<button class="heatCopyLinkBtn" title="Скопировать ссылку с фильтрами" type="button">Copy link</button>
<div class="heatHint">Подсказка: в Graph-режиме кликай по ребру, в Matrix — по клетке.</div>
</div>
<div class="heatControlsRow heatControlsRow3">
<label class="heatSearch">
<span class="heatSearchLabel">Фокус на модуле</span>
<input class="heatSearchInput" list="moduleList" placeholder="например: Quest / DB / Telemetry…" type="search"/>
</label>
<div class="heatSearchActions">
<button class="heatFocusBtn" data-focus="off" type="button">Focus: OFF</button>
<button class="heatClearBtn" type="button">Сброс</button>
</div>
<div class="heatLegendExplain">
<div class="heatLegendExplainTitle">Типы зависимостей</div>
<div class="heatLegendExplainRow">
<button class="heatLegendChip" data-chip="data" type="button">Data</button>
<button class="heatLegendChip" data-chip="events" type="button">Events</button>
<button class="heatLegendChip" data-chip="ux" type="button">UX</button>
</div>
<div class="heatLegendExplainText">
<div class="heatLegendExplainItem" data-item="data"><b>Data</b> — таблицы/tx_log, bundles, projections, кэш; “факты и хранение”.</div>
<div class="heatLegendExplainItem" data-item="events"><b>Events</b> — доменные события между модулями; “кто кого уведомляет”.</div>
<div class="heatLegendExplainItem" data-item="ux"><b>UX</b> — события экранов/телеметрия/side-effects; “как измеряем/показываем”.</div>
</div>
</div>
</div>
</div>
<div class="heatWrap"><div class="heatLeft"><div class="heatGrid" role="grid"><div class="heatCorner"></div><div class="heatHead heatCol" data-mid="spine" role="columnheader">Spine</div><div class="heatHead heatCol" data-mid="discover" role="columnheader">Discover</div><div class="heatHead heatCol" data-mid="quests" role="columnheader">Quest Engine</div><div class="heatHead heatCol" data-mid="badges" role="columnheader">Badges</div><div class="heatHead heatCol" data-mid="stories" role="columnheader">Stories</div><div class="heatHead heatCol" data-mid="points" role="columnheader">Points</div><div class="heatHead heatCol" data-mid="content" role="columnheader">Content Releases</div><div class="heatHead heatCol" data-mid="telemetry" role="columnheader">Telemetry</div><div class="heatHead heatCol" data-mid="monetization" role="columnheader">Entitlements</div><div class="heatHead heatCol" data-mid="persona" role="columnheader">Persona Radar</div><div class="heatHead heatCol" data-mid="db" role="columnheader">DB/tx_log</div><div class="heatHead heatRow" data-mid="spine" role="rowheader">Spine</div><button aria-label="Spine → Spine: 0" class="heatCell w0" data-from="spine" data-to="spine" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button><button aria-label="Spine → Discover: 2" class="heatCell w2" data-from="spine" data-to="discover" data-types="events,ux" data-w="2" data-why="Spine маршрутизирует экраны и actions в Discover." role="gridcell" type="button">2</button><button aria-label="Spine → Quest Engine: 2" class="heatCell w2" data-from="spine" data-to="quests" data-types="events" data-w="2" data-why="Spine диспатчит доменные события к Quest Engine." role="gridcell" type="button">2</button><button aria-label="Spine → Badges: 1" class="heatCell w1" data-from="spine" data-to="badges" data-types="events" data-w="1" data-why="Spine доставляет события для rule evaluation." role="gridcell" type="button">1</button><button aria-label="Spine → Stories: 0" class="heatCell w0" data-from="spine" data-to="stories" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Spine → Points: 0" class="heatCell w0" data-from="spine" data-to="points" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Spine → Content Releases: 1" class="heatCell w1" data-from="spine" data-to="content" data-types="events" data-w="1" data-why="Spine помогает активировать релиз/контент." role="gridcell" type="button">1</button><button aria-label="Spine → Telemetry: 0" class="heatCell w0" data-from="spine" data-to="telemetry" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Spine → Entitlements: 0" class="heatCell w0" data-from="spine" data-to="monetization" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Spine → Persona Radar: 0" class="heatCell w0" data-from="spine" data-to="persona" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Spine → DB/tx_log: 1" class="heatCell w1" data-from="spine" data-to="db" data-types="data,ux" data-w="1" data-why="Spine хранит pointers состояния приложения." role="gridcell" type="button">1</button><div class="heatHead heatRow" data-mid="discover" role="rowheader">Discover</div><button aria-label="Discover → Spine: 0" class="heatCell w0" data-from="discover" data-to="spine" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Discover → Discover: 0" class="heatCell w0" data-from="discover" data-to="discover" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button><button aria-label="Discover → Quest Engine: 3" class="heatCell w3" data-from="discover" data-to="quests" data-types="events" data-w="3" data-why="Discover запускает/подготавливает квест: intent → quest_start." role="gridcell" type="button">3</button><button aria-label="Discover → Badges: 0" class="heatCell w0" data-from="discover" data-to="badges" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Discover → Stories: 0" class="heatCell w0" data-from="discover" data-to="stories" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Discover → Points: 0" class="heatCell w0" data-from="discover" data-to="points" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Discover → Content Releases: 3" class="heatCell w3" data-from="discover" data-to="content" data-types="data" data-w="3" data-why="Каталог/фильтры берутся из релиза." role="gridcell" type="button">3</button><button aria-label="Discover → Telemetry: 2" class="heatCell w2" data-from="discover" data-to="telemetry" data-types="ux,events" data-w="2" data-why="Экран/поиск/фильтры логируются как events (opt-in)." role="gridcell" type="button">2</button><button aria-label="Discover → Entitlements: 0" class="heatCell w0" data-from="discover" data-to="monetization" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Discover → Persona Radar: 0" class="heatCell w0" data-from="discover" data-to="persona" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Discover → DB/tx_log: 2" class="heatCell w2" data-from="discover" data-to="db" data-types="data,ux" data-w="2" data-why="Кэш/история поиска/посещений (локально/БД)." role="gridcell" type="button">2</button><div class="heatHead heatRow" data-mid="quests" role="rowheader">Quest Engine</div><button aria-label="Quest Engine → Spine: 0" class="heatCell w0" data-from="quests" data-to="spine" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Quest Engine → Discover: 0" class="heatCell w0" data-from="quests" data-to="discover" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Quest Engine → Quest Engine: 0" class="heatCell w0" data-from="quests" data-to="quests" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button><button aria-label="Quest Engine → Badges: 3" class="heatCell w3" data-from="quests" data-to="badges" data-types="events" data-w="3" data-why="Quest_progress триггерит badge rules (event-driven)." role="gridcell" type="button">3</button><button aria-label="Quest Engine → Stories: 2" class="heatCell w2" data-from="quests" data-to="stories" data-types="data,events" data-w="2" data-why="Факты квестов участвуют в derived stories." role="gridcell" type="button">2</button><button aria-label="Quest Engine → Points: 4" class="heatCell w4" data-from="quests" data-to="points" data-types="data,events" data-w="4" data-why="Завершение квеста → начисление очков через tx_log." role="gridcell" type="button">4</button><button aria-label="Quest Engine → Content Releases: 0" class="heatCell w0" data-from="quests" data-to="content" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Quest Engine → Telemetry: 2" class="heatCell w2" data-from="quests" data-to="telemetry" data-types="ux,events" data-w="2" data-why="Ключевые события квеста логируются (opt-in)." role="gridcell" type="button">2</button><button aria-label="Quest Engine → Entitlements: 0" class="heatCell w0" data-from="quests" data-to="monetization" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Quest Engine → Persona Radar: 0" class="heatCell w0" data-from="quests" data-to="persona" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Quest Engine → DB/tx_log: 4" class="heatCell w4" data-from="quests" data-to="db" data-types="data" data-w="4" data-why="Quest state + commits сохраняются; награды идемпотентны." role="gridcell" type="button">4</button><div class="heatHead heatRow" data-mid="badges" role="rowheader">Badges</div><button aria-label="Badges → Spine: 0" class="heatCell w0" data-from="badges" data-to="spine" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Badges → Discover: 0" class="heatCell w0" data-from="badges" data-to="discover" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Badges → Quest Engine: 0" class="heatCell w0" data-from="badges" data-to="quests" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Badges → Badges: 0" class="heatCell w0" data-from="badges" data-to="badges" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button><button aria-label="Badges → Stories: 0" class="heatCell w0" data-from="badges" data-to="stories" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Badges → Points: 0" class="heatCell w0" data-from="badges" data-to="points" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Badges → Content Releases: 0" class="heatCell w0" data-from="badges" data-to="content" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Badges → Telemetry: 1" class="heatCell w1" data-from="badges" data-to="telemetry" data-types="ux,events" data-w="1" data-why="Unlocked/seen можно логировать (без PII)." role="gridcell" type="button">1</button><button aria-label="Badges → Entitlements: 0" class="heatCell w0" data-from="badges" data-to="monetization" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Badges → Persona Radar: 0" class="heatCell w0" data-from="badges" data-to="persona" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Badges → DB/tx_log: 3" class="heatCell w3" data-from="badges" data-to="db" data-types="data" data-w="3" data-why="Progress/unlocks в БД для UX и пересчёта." role="gridcell" type="button">3</button><div class="heatHead heatRow" data-mid="stories" role="rowheader">Stories</div><button aria-label="Stories → Spine: 0" class="heatCell w0" data-from="stories" data-to="spine" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Stories → Discover: 0" class="heatCell w0" data-from="stories" data-to="discover" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Stories → Quest Engine: 0" class="heatCell w0" data-from="stories" data-to="quests" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Stories → Badges: 0" class="heatCell w0" data-from="stories" data-to="badges" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Stories → Stories: 0" class="heatCell w0" data-from="stories" data-to="stories" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button><button aria-label="Stories → Points: 2" class="heatCell w2" data-from="stories" data-to="points" data-types="data,events" data-w="2" data-why="Story rewards → Points (через tx_log)." role="gridcell" type="button">2</button><button aria-label="Stories → Content Releases: 0" class="heatCell w0" data-from="stories" data-to="content" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Stories → Telemetry: 0" class="heatCell w0" data-from="stories" data-to="telemetry" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Stories → Entitlements: 0" class="heatCell w0" data-from="stories" data-to="monetization" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Stories → Persona Radar: 0" class="heatCell w0" data-from="stories" data-to="persona" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Stories → DB/tx_log: 3" class="heatCell w3" data-from="stories" data-to="db" data-types="data" data-w="3" data-why="Story progress и rewards фиксируются." role="gridcell" type="button">3</button><div class="heatHead heatRow" data-mid="points" role="rowheader">Points</div><button aria-label="Points → Spine: 0" class="heatCell w0" data-from="points" data-to="spine" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Points → Discover: 0" class="heatCell w0" data-from="points" data-to="discover" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Points → Quest Engine: 0" class="heatCell w0" data-from="points" data-to="quests" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Points → Badges: 0" class="heatCell w0" data-from="points" data-to="badges" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Points → Stories: 0" class="heatCell w0" data-from="points" data-to="stories" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Points → Points: 0" class="heatCell w0" data-from="points" data-to="points" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button><button aria-label="Points → Content Releases: 0" class="heatCell w0" data-from="points" data-to="content" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Points → Telemetry: 0" class="heatCell w0" data-from="points" data-to="telemetry" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Points → Entitlements: 0" class="heatCell w0" data-from="points" data-to="monetization" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Points → Persona Radar: 0" class="heatCell w0" data-from="points" data-to="persona" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Points → DB/tx_log: 4" class="heatCell w4" data-from="points" data-to="db" data-types="data" data-w="4" data-why="tx_log append-only — главный источник правды." role="gridcell" type="button">4</button><div class="heatHead heatRow" data-mid="content" role="rowheader">Content Releases</div><button aria-label="Content Releases → Spine: 0" class="heatCell w0" data-from="content" data-to="spine" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Content Releases → Discover: 2" class="heatCell w2" data-from="content" data-to="discover" data-types="data" data-w="2" data-why="Discover использует bundle (локации/каталог)." role="gridcell" type="button">2</button><button aria-label="Content Releases → Quest Engine: 3" class="heatCell w3" data-from="content" data-to="quests" data-types="data" data-w="3" data-why="Quest defs и gates приходят из релизов." role="gridcell" type="button">3</button><button aria-label="Content Releases → Badges: 2" class="heatCell w2" data-from="content" data-to="badges" data-types="data" data-w="2" data-why="Badge catalog и rules из релизов." role="gridcell" type="button">2</button><button aria-label="Content Releases → Stories: 3" class="heatCell w3" data-from="content" data-to="stories" data-types="data" data-w="3" data-why="EventStory scripts из релизов." role="gridcell" type="button">3</button><button aria-label="Content Releases → Points: 0" class="heatCell w0" data-from="content" data-to="points" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Content Releases → Content Releases: 0" class="heatCell w0" data-from="content" data-to="content" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button><button aria-label="Content Releases → Telemetry: 0" class="heatCell w0" data-from="content" data-to="telemetry" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Content Releases → Entitlements: 0" class="heatCell w0" data-from="content" data-to="monetization" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Content Releases → Persona Radar: 0" class="heatCell w0" data-from="content" data-to="persona" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Content Releases → DB/tx_log: 0" class="heatCell w0" data-from="content" data-to="db" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><div class="heatHead heatRow" data-mid="telemetry" role="rowheader">Telemetry</div><button aria-label="Telemetry → Spine: 0" class="heatCell w0" data-from="telemetry" data-to="spine" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Telemetry → Discover: 0" class="heatCell w0" data-from="telemetry" data-to="discover" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Telemetry → Quest Engine: 0" class="heatCell w0" data-from="telemetry" data-to="quests" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Telemetry → Badges: 0" class="heatCell w0" data-from="telemetry" data-to="badges" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Telemetry → Stories: 0" class="heatCell w0" data-from="telemetry" data-to="stories" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Telemetry → Points: 0" class="heatCell w0" data-from="telemetry" data-to="points" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Telemetry → Content Releases: 0" class="heatCell w0" data-from="telemetry" data-to="content" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Telemetry → Telemetry: 0" class="heatCell w0" data-from="telemetry" data-to="telemetry" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button><button aria-label="Telemetry → Entitlements: 0" class="heatCell w0" data-from="telemetry" data-to="monetization" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Telemetry → Persona Radar: 0" class="heatCell w0" data-from="telemetry" data-to="persona" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Telemetry → DB/tx_log: 1" class="heatCell w1" data-from="telemetry" data-to="db" data-types="data,ux" data-w="1" data-why="Опционально: локальный diagnostics log." role="gridcell" type="button">1</button><div class="heatHead heatRow" data-mid="monetization" role="rowheader">Entitlements</div><button aria-label="Entitlements → Spine: 0" class="heatCell w0" data-from="monetization" data-to="spine" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Entitlements → Discover: 0" class="heatCell w0" data-from="monetization" data-to="discover" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Entitlements → Quest Engine: 0" class="heatCell w0" data-from="monetization" data-to="quests" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Entitlements → Badges: 0" class="heatCell w0" data-from="monetization" data-to="badges" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Entitlements → Stories: 0" class="heatCell w0" data-from="monetization" data-to="stories" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Entitlements → Points: 2" class="heatCell w2" data-from="monetization" data-to="points" data-types="data,ux" data-w="2" data-why="Membership multiplier влияет на начисления." role="gridcell" type="button">2</button><button aria-label="Entitlements → Content Releases: 0" class="heatCell w0" data-from="monetization" data-to="content" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Entitlements → Telemetry: 0" class="heatCell w0" data-from="monetization" data-to="telemetry" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Entitlements → Entitlements: 0" class="heatCell w0" data-from="monetization" data-to="monetization" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button><button aria-label="Entitlements → Persona Radar: 0" class="heatCell w0" data-from="monetization" data-to="persona" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Entitlements → DB/tx_log: 2" class="heatCell w2" data-from="monetization" data-to="db" data-types="data" data-w="2" data-why="Entitlements/inventory хранится в БД." role="gridcell" type="button">2</button><div class="heatHead heatRow" data-mid="persona" role="rowheader">Persona Radar</div><button aria-label="Persona Radar → Spine: 0" class="heatCell w0" data-from="persona" data-to="spine" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Persona Radar → Discover: 0" class="heatCell w0" data-from="persona" data-to="discover" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Persona Radar → Quest Engine: 0" class="heatCell w0" data-from="persona" data-to="quests" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Persona Radar → Badges: 0" class="heatCell w0" data-from="persona" data-to="badges" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Persona Radar → Stories: 0" class="heatCell w0" data-from="persona" data-to="stories" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Persona Radar → Points: 0" class="heatCell w0" data-from="persona" data-to="points" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Persona Radar → Content Releases: 0" class="heatCell w0" data-from="persona" data-to="content" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Persona Radar → Telemetry: 1" class="heatCell w1" data-from="persona" data-to="telemetry" data-types="ux,events" data-w="1" data-why="Показ radar/подсказок можно логировать (opt-in)." role="gridcell" type="button">1</button><button aria-label="Persona Radar → Entitlements: 0" class="heatCell w0" data-from="persona" data-to="monetization" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="Persona Radar → Persona Radar: 0" class="heatCell w0" data-from="persona" data-to="persona" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button><button aria-label="Persona Radar → DB/tx_log: 2" class="heatCell w2" data-from="persona" data-to="db" data-types="data" data-w="2" data-why="Counters для radar сохраняются/восстанавливаются." role="gridcell" type="button">2</button><div class="heatHead heatRow" data-mid="db" role="rowheader">DB/tx_log</div><button aria-label="DB/tx_log → Spine: 0" class="heatCell w0" data-from="db" data-to="spine" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="DB/tx_log → Discover: 0" class="heatCell w0" data-from="db" data-to="discover" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="DB/tx_log → Quest Engine: 0" class="heatCell w0" data-from="db" data-to="quests" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="DB/tx_log → Badges: 0" class="heatCell w0" data-from="db" data-to="badges" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="DB/tx_log → Stories: 0" class="heatCell w0" data-from="db" data-to="stories" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="DB/tx_log → Points: 0" class="heatCell w0" data-from="db" data-to="points" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="DB/tx_log → Content Releases: 0" class="heatCell w0" data-from="db" data-to="content" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="DB/tx_log → Telemetry: 0" class="heatCell w0" data-from="db" data-to="telemetry" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="DB/tx_log → Entitlements: 0" class="heatCell w0" data-from="db" data-to="monetization" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="DB/tx_log → Persona Radar: 0" class="heatCell w0" data-from="db" data-to="persona" data-types="" data-w="0" data-why="Нет прямой зависимости (MVP)." role="gridcell" type="button"></button><button aria-label="DB/tx_log → DB/tx_log: 0" class="heatCell w0" data-from="db" data-to="db" data-types="" data-w="0" data-why="—" role="gridcell" type="button"></button></div><div class="heatGraphWrap" hidden="">
<div class="heatGraphHead">
<div class="heatGraphTitle">Dependency graph</div>
<div class="heatGraphSub">Отображает связи, прошедшие фильтры. Толщина ребра ≈ сила.</div>
<div class="heatGraphTools">
<button class="heatGraphBtn" data-gcmd="reset" type="button">Reset layout</button>
<button class="heatGraphBtn" data-gcmd="export-svg" type="button">Export SVG</button>
<button class="heatGraphBtn" data-gcmd="export-png" type="button">Export PNG</button>
</div>
<div class="heatGraphToolsV19">
<div class="heatGraphLegend">
<span class="heatGraphLegendTitle">Legend</span>
<span class="heatPill heatPillD">D</span><span class="heatLegendText">Data</span>
<span class="heatPill heatPillE">E</span><span class="heatLegendText">Events</span>
<span class="heatPill heatPillU">U</span><span class="heatLegendText">UX</span>
</div>
<div class="heatGraphBtns">
<button class="heatGraphBtnV19" data-gcmd="reset" type="button">Reset</button>
<button class="heatGraphBtnV19" data-gcmd="export-svg" type="button">SVG</button>
<button class="heatGraphBtnV19" data-gcmd="export-png" type="button">PNG</button>
</div>
</div>
</div>
<div aria-label="dependency graph" class="heatGraphCanvas" role="img">
<div class="heatTip" hidden="">
<div class="heatTipK">—</div>
<div class="heatTipV">—</div>
</div>
<div aria-label="Мини-карта графа" class="heatMiniMap" hidden="">
<div class="heatMiniMapTitle">Overview</div>
<svg class="heatMiniMapSvg" height="120" role="img" viewbox="0 0 200 120" width="200"></svg>
</div>
<button class="heatPresentBtn" title="Режим доклада (fullscreen)" type="button">Present</button>

<div class="heatPresenter" hidden="">
<div class="heatPresenterTop">
<div class="heatPresenterTitle">Presentation</div>
<div class="heatPresenterRight">
<button class="heatPresenterBtn" data-pcmd="resetCam" type="button">Reset camera</button>
<button class="heatPresenterBtn" data-pcmd="toggleList" type="button">Steps</button>
</div>
</div>
<div class="heatPresenterMain">
<div class="heatPresenterStep">
<div class="heatPresenterStepK">—</div>
<div class="heatPresenterStepV">—</div>
</div>
<div class="heatPresenterNav">
<button class="heatPresenterNavBtn" data-pcmd="prev" type="button">‹ Prev</button>
<button class="heatPresenterNavBtn" data-pcmd="next" type="button">Next ›</button>
</div>
</div>
<div class="heatPresenterList" hidden=""></div>
</div>
</div>
<div class="heatGraphNote">
          Подсказка: перетаскивай узлы мышкой. Двойной клик по узлу — закрепить/открепить (pin).
        </div>
</div></div>
<div aria-live="polite" class="heatPanel">
<div class="heatPanelTitle">Выбери связь</div>
<div class="heatPanelSub">Кликни на клетку матрицы, чтобы увидеть объяснение зависимости.</div>
<div class="heatPanelBody">
<div class="heatK">—</div>
<div class="heatV">—</div>
</div>
<div class="heatLegend">
<div class="heatLegendTitle">Сила зависимости</div>
<div class="heatLegendRow">
<span class="heatLegendPill w0">0</span>
<span class="heatLegendPill w1">1</span>
<span class="heatLegendPill w2">2</span>
<span class="heatLegendPill w3">3</span>
<span class="heatLegendPill w4">4</span>
</div>
</div>
</div></div><datalist id="moduleList"><option data-mid="spine" value="Spine"></option><option data-mid="discover" value="Discover"></option><option data-mid="quests" value="Quest Engine"></option><option data-mid="badges" value="Badges"></option><option data-mid="stories" value="Stories"></option><option data-mid="points" value="Points"></option><option data-mid="content" value="Content Releases"></option><option data-mid="telemetry" value="Telemetry"></option><option data-mid="monetization" value="Entitlements"></option><option data-mid="persona" value="Persona Radar"></option><option data-mid="db" value="DB/tx_log"></option></datalist></section><section class="section" data-group="ops" id="eventbus"><h2>Event Bus и контракты</h2><p class="lead">Событийная шина — это «язык системы»: кто эмитит события, кто слушает, где происходит коммит фактов, а где — побочные эффекты (телеметрия/UX).</p><div class="mvpRules"><div class="mvpRulesTitle">MVP правила</div><ul class="mvpRulesList"><li>Событие именуется стабильно и не привязано к одному экрану.</li><li>Reward/Points/Badge unlock — только через idempotency (tx_log / уникальные ключи).</li><li>Payload allowlist: без PII; размеры ограничены; телеметрия fail-open.</li><li>Один источник истины: владелец домена определяет валидность и коммит.</li></ul></div><div class="diagramPanel" id="eventbus-diagrams"><div class="diagramHead"><div class="diagramTitle">Диаграммы</div><div class="diagramSub">Flow / State / Storage / Sequence</div><div class="diagExport"><button class="diagExportBtn" data-export="svg" type="button">SVG</button><button class="diagExportBtn" data-export="png" type="button">PNG</button></div></div><div class="diagramTabs"><button class="diagramTab" data-diagtab="flow" type="button">Flow</button><button class="diagramTab" data-diagtab="state" type="button">State</button><button class="diagramTab" data-diagtab="storage" type="button">Storage</button><button class="diagramTab" data-diagtab="sequence" type="button">Sequence</button></div><div class="diagramBody"><div class="diagramPane" data-diagpane="flow"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="10" flood-color="rgba(0,0,0,0.18)" stddeviation="12"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Event bus (кто говорит с кем)</text><path d="M210 105.0 C 225.0 105.0, 225.0 100.0, 240 100.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="215.0" y="95.5">action</text><path d="M410 100.0 C 430.0 100.0, 430.0 95.0, 450 95.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="420.0" y="90.5">event</text><path d="M630 95.0 C 645.0 95.0, 645.0 105.0, 660 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="635.0" y="93.0">notify</text><g filter="url(#softShadow)"><rect fill="var(--c-core)" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="170" x="40" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="97.0">UI</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="113.0">(screen/action)</text><g filter="url(#softShadow)"><rect fill="var(--c-core)" fill-opacity="0.14" height="80" rx="18" stroke="currentColor" stroke-opacity="0.20" width="170" x="240" y="60"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="254" y="92.0">Spine</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="254" y="108.0">(dispatch)</text><g filter="url(#softShadow)"><rect fill="var(--c-game)" fill-opacity="0.14" height="90" rx="18" stroke="currentColor" stroke-opacity="0.20" width="180" x="450" y="50"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="464" y="79.0">Domain modules</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="464" y="95.0">(Quests/Badges/</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="464" y="111.0">Stories/Points)</text><g filter="url(#softShadow)"><rect fill="var(--c-biz)" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="120" x="660" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="674" y="97.0">Side effects</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="674" y="113.0">(Tel/UX)</text></svg></div><div class="diagramPane" data-diagpane="state"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="10" flood-color="rgba(0,0,0,0.18)" stddeviation="12"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Семантика события (обязательный порядок)</text><path d="M230 110.0 C 245.0 110.0, 245.0 105.0, 260 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="235.0" y="100.5">route</text><path d="M450 105.0 C 465.0 105.0, 465.0 105.0, 480 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="455.0" y="98.0">ok</text><path d="M670 105.0 C 685.0 105.0, 685.0 110.0, 700 110.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="675.0" y="100.5">notify</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.09" height="60" rx="18" stroke="currentColor" stroke-opacity="0.20" width="190" x="40" y="80"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="54" y="110.0">Emit event</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="190" x="260" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="274" y="105.0">Owner validates</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.12" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="190" x="480" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="494" y="97.0">Commit fact</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="494" y="113.0">(idempotent)</text><g filter="url(#softShadow)"><rect fill="currentColor" fill-opacity="0.09" height="60" rx="18" stroke="currentColor" stroke-opacity="0.20" width="160" x="700" y="80"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="714" y="102.0">Fan-out</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="714" y="118.0">(update UX)</text></svg></div><div class="diagramPane" data-diagpane="storage"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 260" width="100%">
<defs>
<marker id="arrow" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
<filter height="140%" id="softShadow" width="140%" x="-20%" y="-20%">
<fedropshadow dx="0" dy="10" flood-color="rgba(0,0,0,0.18)" stddeviation="12"></fedropshadow>
</filter>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Где хранятся факты и «витрины»</text><path d="M280 105.0 C 300.0 105.0, 300.0 105.0, 320 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="290.0" y="98.0">derive</text><path d="M520 105.0 C 540.0 105.0, 540.0 105.0, 560 105.0" fill="none" marker-end="url(#arrow)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2"></path><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" x="530.0" y="98.0">emit</text><g filter="url(#softShadow)"><rect fill="var(--c-ops)" fill-opacity="0.14" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="220" x="60" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="74" y="97.0">Fact store</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="74" y="113.0">(tx_log + domain tables)</text><g filter="url(#softShadow)"><rect fill="var(--c-ops)" fill-opacity="0.1" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="200" x="320" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="334" y="97.0">Projections</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="334" y="113.0">(balance/feed)</text><g filter="url(#softShadow)"><rect fill="var(--c-biz)" fill-opacity="0.1" height="70" rx="18" stroke="currentColor" stroke-opacity="0.20" width="220" x="560" y="70"></rect></g><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="574" y="97.0">Telemetry queue</text><text fill="currentColor" fill-opacity="0.84" font-size="12" font-weight="950" x="574" y="113.0">(local/remote)</text></svg></div><div class="diagramPane" data-diagpane="sequence"><svg class="diagSvg" height="100%" role="img" viewbox="0 0 760 300" width="100%">
<defs>
<marker id="arrow3" markerheight="10" markerwidth="10" orient="auto" refx="8" refy="3">
<path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
</marker>
</defs>
<text fill="currentColor" fill-opacity="0.82" font-size="14" font-weight="900" x="14" y="22">Sequence (события между модулями)</text><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="42.0" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="100.0" y="50">UI</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="100.0" x2="100.0" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="182.0" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="240.0" y="50">Spine</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="240.0" x2="240.0" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="322.0" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="380.0" y="50">Quest</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="380.0" x2="380.0" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="462.0" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="520.0" y="50">Badges</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="520.0" x2="520.0" y1="64" y2="282"></line><rect fill="currentColor" fill-opacity="0.10" height="28" rx="12" stroke="currentColor" stroke-opacity="0.20" width="116" x="602.0" y="30"></rect><text fill="currentColor" fill-opacity="0.84" font-size="11.5" font-weight="950" text-anchor="middle" x="660.0" y="50">Tel</text><line stroke="currentColor" stroke-dasharray="3 7" stroke-opacity="0.18" stroke-width="2" x1="660.0" x2="660.0" y1="64" y2="282"></line><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="100.0" x2="240.0" y1="96" y2="96"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="170.0" y="89">quest_start</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="240.0" x2="380.0" y1="126" y2="126"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="310.0" y="119">QUEST_START</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="380.0" x2="520.0" y1="156" y2="156"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="450.0" y="149">QUEST_PROGRESS</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="380.0" x2="660.0" y1="186" y2="186"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="520.0" y="179">telemetry enqueue</text><line marker-end="url(#arrow3)" stroke="currentColor" stroke-opacity="0.30" stroke-width="2.2" x1="520.0" x2="100.0" y1="226" y2="226"></line><text fill="currentColor" fill-opacity="0.62" font-size="11" font-weight="900" text-anchor="middle" x="310.0" y="219">badge_progress</text></svg></div></div></div>
<div class="glossGrid">
<div class="glossCard"><div class="glossK">Domain event</div><div class="glossV">Событие домена (квест/бейдж/история), живёт дольше экрана.</div></div>
<div class="glossCard"><div class="glossK">Action</div><div class="glossV">UI-действие (клик/переход), часто преобразуется в domain event.</div></div>
<div class="glossCard"><div class="glossK">Fact commit</div><div class="glossV">Запись факта (tx_log / domain table) с уникальным ключом.</div></div>
<div class="glossCard"><div class="glossK">Projection</div><div class="glossV">Производное представление для UI: баланс, лента, прогресс.</div></div>
</div>
</section><section class="section" data-group="ops" id="diagramGallery"><h2>Галерея диаграмм</h2><p class="lead">Быстрый доступ к диаграммам ключевых компонентов (Flow/State/Storage).</p><div class="galleryGrid"><a class="galleryCard" href="#overview-diagrams"><div class="galleryK">Обзор и границы MVP</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#core_loop-diagrams"><div class="galleryK">Основная петля игры</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#points-diagrams"><div class="galleryK">Очки и экономика</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#characters-diagrams"><div class="galleryK">Персонажи и взаимодействие</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#quests-diagrams"><div class="galleryK">Квесты и многолокационные события</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#badges-diagrams"><div class="galleryK">Бейджи</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#stories-diagrams"><div class="galleryK">Истории и маршруты</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#monetization-diagrams"><div class="galleryK">Монетизация (билеты/мерч/подписка ×2)</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#persona-diagrams"><div class="galleryK">Persona Radar (архетипы)</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#telemetry-diagrams"><div class="galleryK">Телеметрия (MVP-safe)</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#content-diagrams"><div class="galleryK">Контент-релизы и валидация</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#eventbus-diagrams"><div class="galleryK">Event Bus и контракты</div><div class="galleryV">Flow / State / Storage / Sequence</div></a><a class="galleryCard" href="#devnotes-diagrams"><div class="galleryK">Заметки разработчика: события, DoD, QA</div><div class="galleryV">Flow / State / Storage / Sequence</div></a></div></section></main>
</div>
<div aria-label="Навигация по разделам" class="bottomNav">
<div class="bottomNavInner">
<div class="navBtn">
<button aria-label="Предыдущий раздел" class="btn ghost" id="prevBtn" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M15 18l-6-6 6-6"></path>
</svg>
          Назад
        </button>
<div class="navMini">
<div class="k">предыдущий</div>
<div class="v" id="prevLabel">—</div>
</div>
</div>
<div class="navBtn" style="justify-content:flex-end">
<div class="navMini" style="text-align:right">
<div class="k">следующий</div>
<div class="v" id="nextLabel">—</div>
</div>
<button aria-label="Следующий раздел" class="btn ghost" id="nextBtn" type="button">
          Вперёд
          <svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M9 18l6-6-6-6"></path>
</svg>
</button>
</div>
</div>
</div>
<script>
(function(){
  const root = document.documentElement;
  const tocLinks = Array.from(document.querySelectorAll('[data-toc]'));
  const sections = Array.from(document.querySelectorAll('[data-section]'));
  const searchBox = document.getElementById('searchBox');
  const matchChip = document.getElementById('matchChip');
  const printBtn = document.getElementById('printBtn');
  const resetBtn = document.getElementById('resetBtn');
  const burgerBtn = document.getElementById('burgerBtn');
  const scrim = document.getElementById('scrim');
  const themeBtn = document.getElementById('themeBtn');
  const progressBar = document.getElementById('progressBar');
  const modeButtons = Array.from(document.querySelectorAll('[data-mode-btn]'));
  const ctxTitle = document.getElementById('ctxTitle');
  const ctxH = document.getElementById('ctxH');
  const ctxP = document.getElementById('ctxP');
  const ctxLink = document.getElementById('ctxLink');
  const ctxCopy = document.getElementById('ctxCopy');
  const ctxExpand = document.getElementById('ctxExpand');
  const ctxBullets = document.getElementById('ctxBullets');
  const ctxProgBar = document.getElementById('ctxProgBar');

  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const prevLabel = document.getElementById('prevLabel');
  const nextLabel = document.getElementById('nextLabel');

  const originals = new Map();

  function escapeRegExp(str){return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');}

  function setSidebar(open){ root.dataset.sidebarOpen = open ? "true" : "false"; }

  function setTheme(mode){
    root.dataset.theme = mode;
    try{ localStorage.setItem("af_theme", mode); }catch(e){}
  }
  function toggleTheme(){
    const cur = root.dataset.theme || "light";
    setTheme(cur === "dark" ? "light" : "dark");
  }
  function loadTheme(){
    let saved = null;
    try{ saved = localStorage.getItem("af_theme"); }catch(e){}
    if(saved === "dark" || saved === "light") setTheme(saved);
    else root.dataset.theme = "light";
  }

  function setMode(mode){
    root.dataset.mode = mode;
    try{ localStorage.setItem("af_mode", mode); }catch(e){}
    modeButtons.forEach(b=>b.classList.toggle('active', b.dataset.modeBtn === mode));
  }
  function loadMode(){
    let saved=null;
    try{ saved = localStorage.getItem("af_mode"); }catch(e){}
    if(saved === "reader" || saved === "both" || saved === "dev") setMode(saved);
    else setMode("both");
  }

  function filterTOC(q){
    const query = q.toLowerCase();
    let visible = 0;
    tocLinks.forEach(a=>{
      const t = a.textContent.toLowerCase();
      const hide = query && !t.includes(query);
      a.classList.toggle('hidden', !!hide);
      if(!hide) visible++;
    });
    if(matchChip) matchChip.textContent = query ? `${visible}/${tocLinks.length} matches` : `${tocLinks.length} sections`;
  }

  function clearHighlight(){
    sections.forEach(s=>{
      if(originals.has(s)){
        s.innerHTML = originals.get(s);
        originals.delete(s);
      }
    });
    bindCopy();
  }

  function applyHighlight(q){
    clearHighlight();
    const query = q.trim();
    if(!query) return;
    const re = new RegExp(`(${escapeRegExp(query)})`, 'gi');

    sections.forEach(section=>{
      originals.set(section, section.innerHTML);
      const walk = (node)=>{
        if(node.nodeType === Node.ELEMENT_NODE){
          if(node.tagName === 'PRE' || node.tagName === 'CODE' || node.tagName === 'SCRIPT' || node.tagName === 'STYLE') return;
          Array.from(node.childNodes).forEach(walk);
        }else if(node.nodeType === Node.TEXT_NODE){
          const txt = node.nodeValue;
          if(!txt || !txt.match(re)) return;
          const span = document.createElement('span');
          span.innerHTML = txt.replace(re, '<mark>$1</mark>');
          node.parentNode.replaceChild(span, node);
        }
      };
      walk(section);
    });
    bindCopy();
  }

  async function doCopyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){ return false; }
  }

  async function doCopy(selector, btn){
    const el = document.querySelector(selector);
    const text = el ? el.textContent : '';
    const ok = await doCopyText(text);
    if(ok){
      const old = btn.textContent;
      btn.textContent = 'Copied ✓';
      setTimeout(()=>btn.textContent = old, 900);
    }else{
      alert('Copy failed. Browser may block clipboard access.');
    }
  }

  function bindCopy(){
    document.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', ()=>doCopy(btn.getAttribute('data-copy'), btn));
    });
  }

  function sectionProgress(){
    if(!ctxProgBar) return;
    const active = document.querySelector('.section.active') || null;
    if(!active) { ctxProgBar.style.width = '0%'; return; }
    const r = active.getBoundingClientRect();
    const vh = window.innerHeight || document.documentElement.clientHeight || 1;
    const top = Math.max(0, Math.min(vh, r.top));
    const bottom = Math.max(0, Math.min(vh, r.bottom));
    const vis = Math.max(0, bottom - top);
    const p = Math.max(0, Math.min(1, (vh - r.top) / Math.max(1, (r.height + vh*0.2)) ));
    ctxProgBar.style.width = (p*100).toFixed(0) + '%';
  }

  function progress(){
    const onScroll = ()=>{
      const doc = document.documentElement;
      const h = doc.scrollHeight - doc.clientHeight;
      const y = doc.scrollTop || document.body.scrollTop || 0;
      const p = h>0 ? Math.min(1, y/h) : 0;
      if(progressBar) progressBar.style.width = (p*100).toFixed(1) + "%";
    };
    window.addEventListener('scroll', onScroll, {passive:true});
      window.addEventListener('scroll', sectionProgress, {passive:true});
    onScroll();
      sectionProgress();
  }

  function updateBottomNav(idx){
    const prev = idx > 0 ? tocLinks[idx-1] : null;
    const next = idx < tocLinks.length-1 ? tocLinks[idx+1] : null;

    if(prevLabel) prevLabel.textContent = prev ? prev.textContent.trim() : "—";
    if(nextLabel) nextLabel.textContent = next ? next.textContent.trim() : "—";

    if(prevBtn){
      prevBtn.disabled = !prev;
      prevBtn.onclick = prev ? ()=>location.hash = prev.getAttribute('href') : null;
    }
    if(nextBtn){
      nextBtn.disabled = !next;
      nextBtn.onclick = next ? ()=>location.hash = next.getAttribute('href') : null;
    }
  }

  function setContextForSection(sec){
    if(!sec) return;
    const h2 = sec.querySelector('h2');
    const lead = sec.querySelector('.lead');
    const id = sec.getAttribute('id') || '';

    if(ctxH) ctxH.textContent = h2 ? h2.textContent.trim() : id;
    if(ctxP) ctxP.textContent = lead ? lead.textContent.trim() : '';
    if(ctxLink) ctxLink.textContent = '#' + id;
    // bullets from section takeaways (metaList)
    if(ctxBullets){
      const list = sec.querySelectorAll('.sectionMeta .metaList li');
      const items = Array.from(list).slice(0,3).map(li=>li.textContent.trim()).filter(Boolean);
      ctxBullets.innerHTML = "";
      if(items.length){
        items.forEach(t=>{
          const li = document.createElement('li'); li.textContent = t; ctxBullets.appendChild(li);
        });
      }else{
        const li = document.createElement('li'); li.textContent = "—"; ctxBullets.appendChild(li);
      }
    }


    if(ctxCopy){
      ctxCopy.onclick = async ()=>{
        const url = location.origin + location.pathname + '#' + id;
        const ok = await doCopyText(url);
        if(ok){
          const old = ctxCopy.textContent;
          ctxCopy.textContent = 'Link copied ✓';
          setTimeout(()=>ctxCopy.textContent = old, 900);
        }
      };
    }

    if(ctxExpand){
      ctxExpand.onclick = ()=>{
        const details = Array.from(sec.querySelectorAll('details'));
        if(!details.length) return;
        const allOpen = details.every(d=>d.open);
        details.forEach(d=>d.open = !allOpen);
        ctxExpand.textContent = allOpen ? "Expand details" : "Collapse details";
        setTimeout(()=>ctxExpand.textContent = "Expand details", 1200);
      };
    }
  }

  function scrollSpy(){
    const idToTocIndex = new Map(tocLinks.map((a,i)=>[(a.getAttribute('href')||'').replace('#',''), i]));
    let activeId = null;

    const obs = new IntersectionObserver((entries)=>{
      const visible = entries.filter(e=>e.isIntersecting).sort((a,b)=>b.intersectionRatio-a.intersectionRatio)[0];
      if(!visible) return;
      const id = visible.target.getAttribute('id');
      if(!id || id === activeId) return;

      activeId = id;

      tocLinks.forEach(a=>a.classList.toggle('active', (a.getAttribute('href') === '#'+id)));
      sections.forEach(s=>s.classList.toggle('active', s.getAttribute('id') === id));

      const idx = idToTocIndex.get(id);
      if(typeof idx === 'number') updateBottomNav(idx);
      setContextForSection(visible.target);
      sectionProgress();
    }, {root:null, threshold:[0.25,0.45,0.65]});

    sections.forEach(s=>obs.observe(s));

    // initial from hash
    const start = (location.hash||'').replace('#','');
    if(start){
      const sec = document.getElementById(start);
      if(sec){
        setContextForSection(sec);
        const idx = idToTocIndex.get(start);
        if(typeof idx === 'number') updateBottomNav(idx);
      }
    }else{
      updateBottomNav(0);
    }
  }

  function init(){
    loadTheme();
    loadMode();

    bindCopy();
    filterTOC('');
    progress();
    scrollSpy();

    if(searchBox){
      searchBox.addEventListener('input', ()=>{
        const q = searchBox.value.trim();
        filterTOC(q);
        if(q) applyHighlight(q); else clearHighlight();
      });
    }

    // keyboard
    const isMac = navigator.platform.toUpperCase().includes('MAC');
    window.addEventListener('keydown', (e)=>{
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if(mod && e.key.toLowerCase() === 'k'){
        e.preventDefault();
        if(searchBox) searchBox.focus();
        return;
      }
      if(e.key === 'Escape'){
        if(root.dataset.sidebarOpen === "true"){ setSidebar(false); return; }
        if(document.activeElement === searchBox){
          searchBox.value='';
          filterTOC('');
          clearHighlight();
          searchBox.blur();
        }
      }
    });

    if(burgerBtn) burgerBtn.addEventListener('click', ()=> setSidebar(!(root.dataset.sidebarOpen === "true")) );
    if(scrim) scrim.addEventListener('click', ()=> setSidebar(false) );

    tocLinks.forEach(a=>a.addEventListener('click', ()=>{
      if(window.matchMedia('(max-width: 980px)').matches) setSidebar(false);
    }));

    if(printBtn) printBtn.addEventListener('click', ()=>window.print());
    if(resetBtn) resetBtn.addEventListener('click', ()=>{
      if(searchBox){ searchBox.value=''; }
      filterTOC('');
      clearHighlight();
      location.hash = '';
      tocLinks.forEach(a=>a.classList.remove('active'));
      sections.forEach(s=>s.classList.remove('active'));
      window.scrollTo({top:0, behavior:'smooth'});
    });
    if(themeBtn) themeBtn.addEventListener('click', toggleTheme);

    modeButtons.forEach(b=>b.addEventListener('click', ()=> setMode(b.dataset.modeBtn)) );
  }

  init();
})();


// --- v9 Tour paths ---
const TOUR_PATHS = {"all": ["overview", "core_loop", "points", "characters", "quests", "badges", "stories", "monetization", "persona", "telemetry", "content", "devnotes"], "core": ["overview", "core_loop", "points"], "gameplay": ["characters", "quests", "badges", "stories"], "ops": ["telemetry", "content", "devnotes"], "business": ["monetization", "persona"], "review": ["overview", "core_loop", "quests", "badges", "telemetry", "content"]};
let activeTour = 'all';
function getActiveSequence(){
  const seq = TOUR_PATHS[activeTour] || TOUR_PATHS.all || [];
  return seq.length ? seq : (TOUR_PATHS.all || []);
}
function setTour(key){
  if(!TOUR_PATHS[key]) key = 'all';
  activeTour = key;
  const chip = document.getElementById('tourChip');
  if(chip) chip.textContent = 'Tour: ' + (key==='all'?'Все':key);
  document.querySelectorAll('.tourBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.tour===key);
  });
  // update nav labels immediately
  updateNavByActive();
}
function getActiveSectionId(){
  const active = document.querySelector('.section.active') || null;
  if(active) return active.getAttribute('id');
  // fallback from hash
  const h = (location.hash||'').replace('#','');
  if(h) return h;
  return (getActiveSequence()[0]||null);
}
function updateNavByActive(){
  const seq = getActiveSequence();
  const id = getActiveSectionId();
  const idx = Math.max(0, seq.indexOf(id));
  const prevId = seq[idx-1] || null;
  const nextId = seq[idx+1] || null;

  const prevLabel = document.getElementById('prevLabel');
  const nextLabel = document.getElementById('nextLabel');
  if(prevLabel) prevLabel.textContent = prevId ? (document.querySelector('#'+prevId+' h2')?.textContent || prevId) : '—';
  if(nextLabel) nextLabel.textContent = nextId ? (document.querySelector('#'+nextId+' h2')?.textContent || nextId) : '—';

  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  if(prevBtn) prevBtn.disabled = !prevId;
  if(nextBtn) nextBtn.disabled = !nextId;
  // store for click handlers
  prevBtn && (prevBtn.dataset.to = prevId || '');
  nextBtn && (nextBtn.dataset.to = nextId || '');
}

document.addEventListener('click', (e)=>{
  const b = e.target.closest('.tourBtn');
  if(b){
    setTour(b.dataset.tour);
  }
});

(function initTourOnLoad(){
  // set initial
  setTour('all');
  // bind navigation buttons to our dataset targets
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  if(prevBtn){
    prevBtn.addEventListener('click', ()=>{
      const to = prevBtn.dataset.to;
      if(to) document.getElementById(to)?.scrollIntoView({behavior:'smooth', block:'start'});
    });
  }
  if(nextBtn){
    nextBtn.addEventListener('click', ()=>{
      const to = nextBtn.dataset.to;
      if(to) document.getElementById(to)?.scrollIntoView({behavior:'smooth', block:'start'});
    });
  }
  window.addEventListener('hashchange', updateNavByActive);
  window.addEventListener('scroll', ()=>{ updateNavByActive(); }, {passive:true});
  updateNavByActive();
})();


// --- v10 Start CTA ---
document.addEventListener('click', (e)=>{
  const s = e.target.closest('[data-start]');
  if(!s) return;
  const key = s.dataset.start;
  if(typeof setTour === 'function') setTour(key);
  const seq = (typeof getActiveSequence === 'function') ? getActiveSequence() : [];
  const first = seq && seq[0] ? seq[0] : null;
  if(first){
    document.getElementById(first)?.scrollIntoView({behavior:'smooth', block:'start'});
  }
});


// --- v11 Copy helpers ---
async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    showToast('Скопировано в буфер');
  }catch(err){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position='fixed'; ta.style.left='-9999px';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('Скопировано (fallback)');
  }
}
let toastTimer = null;
function showToast(msg){
  let t = document.querySelector('.toast');
  if(!t){ t = document.createElement('div'); t.className='toast'; document.body.appendChild(t); }
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ t.style.opacity='0'; }, 1400);
}

function getActiveSection(){
  return document.querySelector('.section.active') || null;
}

document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.copyBtn');
  if(btn){
    const col = btn.closest('.implCol');
    const list = col?.querySelector('ul.implList');
    const text = list?.dataset?.copytext || '';
    if(text.trim()) copyToClipboard(text.trim());
    return;
  }
  const act = e.target.closest('[data-copy-active]');
  if(act){
    const type = act.dataset.copyActive;
    const sec = getActiveSection();
    if(!sec){ showToast('Нет активного раздела'); return; }
    // find list in implWrap by title type
    const cols = sec.querySelectorAll('.implWrap .implCol');
    let text = '';
    cols.forEach(c=>{
      const title = c.querySelector('.implH span')?.textContent || '';
      if(type==='events' && title.includes('События')) text = c.querySelector('ul.implList')?.dataset?.copytext || '';
      if(type==='state' && title.includes('State keys')) text = c.querySelector('ul.implList')?.dataset?.copytext || '';
    });
    if(text.trim()) copyToClipboard(text.trim());
    else showToast('Нечего копировать');
    return;
  }
});


// --- v12 Diagram tabs ---
function initDiagramPanels(){
  document.querySelectorAll('.diagramPanel').forEach(panel=>{
    const tabs = panel.querySelectorAll('[data-diagtab]');
    const panes = panel.querySelectorAll('[data-diagpane]');
    function activate(key){
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.diagtab===key));
      panes.forEach(p=>p.classList.toggle('active', p.dataset.diagpane===key));
    }
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>activate(t.dataset.diagtab));
    });
    activate(panel.querySelector('[data-diagtab="flow"]') ? 'flow' : (tabs[0]?.dataset?.diagtab || 'flow'));
  });
}
window.addEventListener('load', initDiagramPanels);


// --- v13 Diagram export (SVG/PNG) ---
function getActiveDiagramSvg(panel){
  const pane = panel.querySelector('.diagramPane.active');
  return pane ? pane.querySelector('svg') : null;
}
function serializeSvg(svgEl){
  const clone = svgEl.cloneNode(true);
  // ensure xmlns
  clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
  const css = Array.from(document.querySelectorAll('style')).map(s=>s.textContent||'').join('\n');
  // minimal inline style to preserve currentColor look by setting color
  const wrapper = document.createElement('div');
  wrapper.appendChild(clone);
  return wrapper.innerHTML;
}
async function downloadText(filename, text, mime='image/svg+xml'){
  const blob = new Blob([text], {type:mime});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 50);
}
async function exportActiveDiagram(panel, kind){
  const svg = getActiveDiagramSvg(panel);
  if(!svg){ showToast('Диаграмма не найдена'); return; }
  const id = panel.getAttribute('id') || 'diagram';
  const activePane = panel.querySelector('.diagramPane.active')?.dataset?.diagpane || 'flow';
  const filenameBase = `${id}-${activePane}`;
  const svgText = serializeSvg(svg);
  if(kind==='svg'){
    await downloadText(filenameBase + '.svg', svgText, 'image/svg+xml');
    showToast('SVG скачан');
    return;
  }
  // PNG: render via canvas
  const img = new Image();
  const svg64 = btoa(unescape(encodeURIComponent(svgText)));
  img.src = 'data:image/svg+xml;base64,' + svg64;
  img.onload = ()=>{
    const bbox = svg.getBoundingClientRect();
    const w = Math.max(760, Math.floor(bbox.width));
    const h = Math.max(260, Math.floor(bbox.height));
    const canvas = document.createElement('canvas');
    canvas.width = w*2;
    canvas.height = h*2;
    const ctx = canvas.getContext('2d');
    ctx.scale(2,2);
    // background transparent by default
    ctx.drawImage(img, 0, 0, w, h);
    canvas.toBlob((blob)=>{
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filenameBase + '.png';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 50);
      showToast('PNG скачан');
    });
  };
  img.onerror = ()=> showToast('Не удалось экспортировать PNG');
}

document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.diagExportBtn');
  if(!btn) return;
  const panel = btn.closest('.diagramPanel');
  if(!panel) return;
  exportActiveDiagram(panel, btn.dataset.export);
});

// --- v14 Heatmap interactions ---
function initHeatmap(){
  const grid = document.querySelector('.heatGrid');
  if(!grid) return;
  const panel = document.querySelector('.heatPanel');
  const kEl = panel?.querySelector('.heatK');
  const vEl = panel?.querySelector('.heatV');
  const titleEl = panel?.querySelector('.heatPanelTitle');

  const colHeads = Array.from(grid.querySelectorAll('.heatHead.heatCol'));
  const rowHeads = Array.from(grid.querySelectorAll('.heatHead.heatRow'));
  const cells = Array.from(grid.querySelectorAll('.heatCell'));

  function clearHi(){ colHeads.forEach(h=>h.classList.remove('isHi')); rowHeads.forEach(h=>h.classList.remove('isHi')); }
  function clearSel(){ cells.forEach(c=>c.classList.remove('isSel')); }
  function hi(from,to){
    clearHi();
    rowHeads.find(h=>h.dataset.mid===from)?.classList.add('isHi');
    colHeads.find(h=>h.dataset.mid===to)?.classList.add('isHi');
  }
  grid.addEventListener('mousemove',(e)=>{
    const cell = e.target.closest('.heatCell'); if(!cell) return;
    hi(cell.dataset.from, cell.dataset.to);
  });
  grid.addEventListener('mouseleave',()=>clearHi());
  grid.addEventListener('click',(e)=>{
    const cell = e.target.closest('.heatCell'); if(!cell) return;
    clearSel(); cell.classList.add('isSel');
    const fromH = rowHeads.find(h=>h.dataset.mid===cell.dataset.from)?.textContent || cell.dataset.from;
    const toH = colHeads.find(h=>h.dataset.mid===cell.dataset.to)?.textContent || cell.dataset.to;
    const w = cell.dataset.w || '0';
    const why = cell.dataset.why || '—';
    if(titleEl) titleEl.textContent = `Связь: ${fromH} → ${toH}`;
    if(kEl) kEl.textContent = `Сила: ${w}`;
    if(vEl) vEl.textContent = why;
  });
  // default: Quests -> DB
  grid.querySelector('.heatCell[data-from="quests"][data-to="db"]')?.click();
}
window.addEventListener('load', initHeatmap);


// --- v15 Heatmap: filters + matrix/graph view + cleaner rendering ---
function initHeatmapV15(){
  const root = document.querySelector('#heatmap');
  if(!root) return;

  const wrap = root.querySelector('.heatWrap');
  const grid = root.querySelector('.heatGrid');
  const panel = root.querySelector('.heatPanel');
  const graphWrap = root.querySelector('.heatGraphWrap');
  const graphCanvas = root.querySelector('.heatGraphCanvas');

  const viewBtns = Array.from(root.querySelectorAll('.heatViewBtn'));
  const typeBtns = Array.from(root.querySelectorAll('.heatTypeBtn'));
  const range = root.querySelector('.heatRangeInput');
  const rangeVal = root.querySelector('.heatRangeValue');
  const strongOnly = root.querySelector('.heatCheckInput');

  const colHeads = Array.from(grid.querySelectorAll('.heatHead.heatCol'));
  const rowHeads = Array.from(grid.querySelectorAll('.heatHead.heatRow'));
  const cells = Array.from(grid.querySelectorAll('.heatCell'));

  // read module labels from headers
  const mods = {
    cols: colHeads.map(h=>({id:h.dataset.mid, label:h.textContent.trim()})),
    rows: rowHeads.map(h=>({id:h.dataset.mid, label:h.textContent.trim()})),
  };
  const modIds = mods.cols.map(m=>m.id);

  function currentTypes(){
    const on = new Set(typeBtns.filter(b=>b.classList.contains('isOn')).map(b=>b.dataset.type));
    return on;
  }
  function currentMin(){
    const v = parseInt(range?.value || '0', 10);
    return strongOnly?.checked ? Math.max(3, v) : v;
  }

  function cellMatches(cell, typesOn, minW){
    const w = parseInt(cell.dataset.w || '0', 10);
    if(w < minW) return false;
    const t = (cell.dataset.types || '').split(',').filter(Boolean);
    if(t.length === 0) return w >= minW && (typesOn.size===0 ? true : true); // unknown type -> allow if weight ok
    // If any matches
    return t.some(x=>typesOn.has(x));
  }

  function applyMatrixFilter(){
    const typesOn = currentTypes();
    const minW = currentMin();
    rangeVal.textContent = `≥ ${minW}`;

    cells.forEach(c=>{
      const show = cellMatches(c, typesOn, minW);
      c.classList.toggle('isDim', !show);
      c.disabled = !show;
    });
    // keep selected cell if now disabled -> select default
    const sel = grid.querySelector('.heatCell.isSel');
    if(sel && sel.disabled){
      grid.querySelector('.heatCell[data-from="quests"][data-to="db"]')?.click();
    }
  }

  // view toggle
  function setView(v){
    viewBtns.forEach(b=>b.classList.toggle('isOn', b.dataset.view===v));
    if(v==='graph'){
      grid.hidden = true;
      graphWrap.hidden = false;
      panel.style.display = '';
      renderGraph();
    }else{
      grid.hidden = false;
      graphWrap.hidden = true;
      panel.style.display = '';
    }
  }

  // graph renderer (simple circular layout; re-render on filter)
  function getEdgesFiltered(){
    const typesOn = currentTypes();
    const minW = currentMin();
    const edges = cells
      .filter(c=>parseInt(c.dataset.w||'0',10)>0)
      .map(c=>({
        from: c.dataset.from,
        to: c.dataset.to,
        w: parseInt(c.dataset.w||'0',10),
        why: c.dataset.why || '—',
        types: (c.dataset.types||'').split(',').filter(Boolean),
      }))
      .filter(e=> e.w >= minW && (e.types.length===0 ? true : e.types.some(t=>typesOn.has(t))) );
    return edges;
  }

  function edgeColor(types){
    // pick by dominant type
    if(types.includes('data')) return 'rgba(87,166,255,.45)';
    if(types.includes('events')) return 'rgba(168,132,255,.42)';
    if(types.includes('ux')) return 'rgba(74,214,178,.42)';
    return 'rgba(0,0,0,.30)';
  }

  function renderGraph(){
    if(!graphCanvas) return;
    const rect = graphCanvas.getBoundingClientRect();
    const W = Math.max(760, Math.floor(rect.width));
    const H = Math.max(520, Math.floor(rect.height));
    const cx = W/2, cy = H/2;
    const R = Math.min(W,H)*0.36;

    const nodes = modIds.map((id, i)=>{
      const a = (Math.PI*2)*(i/modIds.length) - Math.PI/2;
      return { id, x: cx + Math.cos(a)*R, y: cy + Math.sin(a)*R, label: (mods.cols.find(m=>m.id===id)?.label || id) };
    });

    const edges = getEdgesFiltered();

    const defs = `
      <defs>
        <marker id="arrG" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
          <path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
        </marker>
        <filter id="shG" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="10" stdDeviation="10" flood-color="rgba(0,0,0,0.18)"/>
        </filter>
      </defs>`;

    let svg = `<svg class="heatGraphSvg heatGraphSvg" viewBox="0 0 ${W} ${H}" width="100%" height="100%" role="img" aria-label="dependency graph">${defs}`;

    // edges
    edges.forEach((e, idx)=>{
      const a = nodes.find(n=>n.id===e.from);
      const b = nodes.find(n=>n.id===e.to);
      if(!a || !b) return;
      const mx = (a.x+b.x)/2;
      const my = (a.y+b.y)/2;
      const sw = 1.6 + e.w*0.9;
      const col = edgeColor(e.types);
      svg += `<path class="heatEdge" data-why="${escapeHtml(e.why)}" data-from="${e.from}" data-to="${e.to}" data-w="${e.w}" d="M${a.x} ${a.y} Q ${mx} ${my} ${b.x} ${b.y}" stroke="${col}" stroke-width="${sw}" fill="none" marker-end="url(#arrG)" stroke-linecap="round" opacity="0.9"></path>`;
    });

    // nodes
    nodes.forEach(n=>{
      svg += `<g class="heatNode" data-id="${n.id}" transform="translate(${n.x},${n.y})" filter="url(#shG)">`;
      svg += `<circle r="22" fill="currentColor" fill-opacity="0.10" stroke="currentColor" stroke-opacity="0.22"></circle>`;
      svg += `<text class="heatNodeLabel" text-anchor="middle" y="42">${escapeHtml(n.label)}</text>`;
      svg += `</g>`;
    });

    svg += `</svg>`;
    graphCanvas.innerHTML = svg;

    // click edges to explain
    graphCanvas.querySelectorAll('.heatEdge').forEach(p=>{
      p.addEventListener('click', ()=>{
        const fromH = rowHeads.find(h=>h.dataset.mid===p.dataset.from)?.textContent || p.dataset.from;
        const toH = colHeads.find(h=>h.dataset.mid===p.dataset.to)?.textContent || p.dataset.to;
        panel.querySelector('.heatPanelTitle').textContent = `Связь: ${fromH} → ${toH}`;
        panel.querySelector('.heatK').textContent = `Сила: ${p.dataset.w}`;
        panel.querySelector('.heatV').textContent = unescapeHtml(p.dataset.why || '—');
        showToast('Связь обновлена (Graph)');
      });
    });
  }

  // utility: html escaping for attrs
  function escapeHtml(s){
    return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }
  function unescapeHtml(s){
    return (s||'').replaceAll('&quot;','"').replaceAll('&gt;','>').replaceAll('&lt;','<').replaceAll('&amp;','&');
  }

  // wire controls
  viewBtns.forEach(b=> b.addEventListener('click', ()=> setView(b.dataset.view)) );
  typeBtns.forEach(b=> b.addEventListener('click', ()=>{
    b.classList.toggle('isOn');
    applyMatrixFilter();
    if(viewBtns.find(x=>x.classList.contains('isOn'))?.dataset.view==='graph') renderGraph();
  }));
  range?.addEventListener('input', ()=>{
    applyMatrixFilter();
    if(viewBtns.find(x=>x.classList.contains('isOn'))?.dataset.view==='graph') renderGraph();
  });
  strongOnly?.addEventListener('change', ()=>{
    applyMatrixFilter();
    if(viewBtns.find(x=>x.classList.contains('isOn'))?.dataset.view==='graph') renderGraph();
  });

  // keep existing highlight + click behavior from v14, but improve filter interplay
  applyMatrixFilter();

  // Default view matrix
  setView('matrix');

  // On resize rerender graph if visible
  window.addEventListener('resize', ()=>{
    if(viewBtns.find(x=>x.classList.contains('isOn'))?.dataset.view==='graph') renderGraph();
  });
}
window.addEventListener('load', initHeatmapV15);


// --- v16 Heatmap: search + focus mode + better graph (force + drag) ---
function initHeatmapV16(){
  const root = document.querySelector('#heatmap');
  if(!root) return;

  const grid = root.querySelector('.heatGrid');
  const panel = root.querySelector('.heatPanel');
  const graphWrap = root.querySelector('.heatGraphWrap');
  const graphCanvas = root.querySelector('.heatGraphCanvas');

  const viewBtns = Array.from(root.querySelectorAll('.heatViewBtn'));
  const typeBtns = Array.from(root.querySelectorAll('.heatTypeBtn'));
  const range = root.querySelector('.heatRangeInput');
  const rangeVal = root.querySelector('.heatRangeValue');
  const strongOnly = root.querySelector('.heatCheckInput');
  const search = root.querySelector('.heatSearchInput');
  const focusBtn = root.querySelector('.heatFocusBtn');
  const clearBtn = root.querySelector('.heatClearBtn');

  const colHeads = Array.from(grid.querySelectorAll('.heatHead.heatCol'));
  const rowHeads = Array.from(grid.querySelectorAll('.heatHead.heatRow'));
  const cells = Array.from(grid.querySelectorAll('.heatCell'));

  // helpers
  function esc(s){ return (s||'').toLowerCase().trim(); }
  function currentTypes(){
    return new Set(typeBtns.filter(b=>b.classList.contains('isOn')).map(b=>b.dataset.type));
  }
  function currentMin(){
    const v = parseInt(range?.value || '0', 10);
    return strongOnly?.checked ? Math.max(3, v) : v;
  }
  function cellMatches(cell, typesOn, minW){
    const w = parseInt(cell.dataset.w || '0', 10);
    if(w < minW) return false;
    const t = (cell.dataset.types || '').split(',').filter(Boolean);
    if(t.length === 0) return true; // unknown type but weight ok
    if(typesOn.size===0) return true;
    return t.some(x=>typesOn.has(x));
  }

  // Search match returns matched module ids set
  function getSearchMatches(q){
    const s = esc(q);
    if(!s) return new Set();
    const ids = new Set();
    const all = [...colHeads, ...rowHeads];
    all.forEach(h=>{
      const id = h.dataset.mid;
      const label = (h.textContent||'').toLowerCase();
      if(label.includes(s) || id.includes(s)){
        ids.add(id);
      }
    });
    return ids;
  }

  function applyMatrixFilterAndSearch(){
    const typesOn = currentTypes();
    const minW = currentMin();
    rangeVal.textContent = `≥ ${minW}`;

    const matches = getSearchMatches(search?.value || '');
    const hasSearch = matches.size>0;

    // Dim non-matching headers
    colHeads.forEach(h=>{
      const on = !hasSearch || matches.has(h.dataset.mid);
      h.classList.toggle('isFocus', on);
      h.classList.toggle('isDim', hasSearch && !on);
    });
    rowHeads.forEach(h=>{
      const on = !hasSearch || matches.has(h.dataset.mid);
      h.classList.toggle('isFocus', on);
      h.classList.toggle('isDim', hasSearch && !on);
    });

    // Filter cells by type/weight + search/focus selection
    const focusOn = focusBtn?.classList.contains('isOn');

    cells.forEach(c=>{
      const pass = cellMatches(c, typesOn, minW);
      let passSearch = true;
      if(hasSearch){
        // show if row or col matches (or both)
        passSearch = matches.has(c.dataset.from) || matches.has(c.dataset.to);
      }
      const show = pass && passSearch;
      c.classList.toggle('isDim', !show);
      c.disabled = !show;

      // focus mode: only keep "intersection" for chosen module(s)
      c.classList.remove('isFocus');
      if(focusOn && hasSearch){
        const focusKeep = matches.has(c.dataset.from) || matches.has(c.dataset.to);
        if(focusKeep && show) c.classList.add('isFocus');
      }else if(focusOn && !hasSearch){
        // focus without query -> do nothing
      }
    });

    grid.classList.toggle('isFocus', focusBtn?.classList.contains('isOn') && (search?.value||'').trim().length>0);
    // If selected cell now disabled, pick default
    const sel = grid.querySelector('.heatCell.isSel');
    if(sel && sel.disabled){
      grid.querySelector('.heatCell[data-from="quests"][data-to="db"]')?.click();
    }
  }

  // click behavior (matrix) keeps from v14 but ensure panel updated even when click blocked
  grid.addEventListener('click', (e)=>{
    const cell = e.target.closest('.heatCell');
    if(!cell || cell.disabled) return;
    grid.querySelectorAll('.heatCell').forEach(x=>x.classList.remove('isSel'));
    cell.classList.add('isSel');
    const fromH = rowHeads.find(h=>h.dataset.mid===cell.dataset.from)?.textContent || cell.dataset.from;
    const toH = colHeads.find(h=>h.dataset.mid===cell.dataset.to)?.textContent || cell.dataset.to;
    panel.querySelector('.heatPanelTitle').textContent = `Связь: ${fromH} → ${toH}`;
    panel.querySelector('.heatK').textContent = `Сила: ${cell.dataset.w || '0'}`;
    panel.querySelector('.heatV').textContent = cell.dataset.why || '—';
  });

  // View toggle
  function setView(v){
    viewBtns.forEach(b=>b.classList.toggle('isOn', b.dataset.view===v));
    if(v==='graph'){
      grid.hidden = true;
      graphWrap.hidden = false;
      renderGraphForce();
    }else{
      grid.hidden = false;
      graphWrap.hidden = true;
    }
  }
  viewBtns.forEach(b=> b.addEventListener('click', ()=> setView(b.dataset.view)) );

  // Focus button
  focusBtn?.addEventListener('click', ()=>{
    focusBtn.classList.toggle('isOn');
    focusBtn.textContent = focusBtn.classList.contains('isOn') ? 'Focus: ON' : 'Focus: OFF';
    applyMatrixFilterAndSearch();
    if(viewBtns.find(x=>x.classList.contains('isOn'))?.dataset.view==='graph') renderGraphForce();
  });

  // Clear
  clearBtn?.addEventListener('click', ()=>{
    if(search) search.value = '';
    if(focusBtn){ focusBtn.classList.remove('isOn'); focusBtn.textContent = 'Focus: OFF'; }
    // reset types on
    typeBtns.forEach(b=> b.classList.add('isOn'));
    strongOnly.checked = false;
    range.value = '1';
    applyMatrixFilterAndSearch();
    setView('matrix');
    // default select
    grid.querySelector('.heatCell[data-from="quests"][data-to="db"]')?.click();
  });

  // Type buttons toggle
  typeBtns.forEach(b=> b.addEventListener('click', ()=>{
    b.classList.toggle('isOn');
    applyMatrixFilterAndSearch();
    if(viewBtns.find(x=>x.classList.contains('isOn'))?.dataset.view==='graph') renderGraphForce();
  }));
  range?.addEventListener('input', ()=>{
    applyMatrixFilterAndSearch();
    if(viewBtns.find(x=>x.classList.contains('isOn'))?.dataset.view==='graph') renderGraphForce();
  });
  strongOnly?.addEventListener('change', ()=>{
    applyMatrixFilterAndSearch();
    if(viewBtns.find(x=>x.classList.contains('isOn'))?.dataset.view==='graph') renderGraphForce();
  });
  search?.addEventListener('input', ()=>{
    applyMatrixFilterAndSearch();
    if(viewBtns.find(x=>x.classList.contains('isOn'))?.dataset.view==='graph') renderGraphForce();
  });

  // Legend chips highlight (visual only)
  root.querySelectorAll('.heatLegendChip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      const t = ch.dataset.chip;
      const btn = typeBtns.find(b=>b.dataset.type===t);
      if(btn){ btn.click(); }
    });
  });

  // -------- Force graph implementation --------
  function edgeColor(types){
    if(types.includes('data')) return 'rgba(87,166,255,.52)';
    if(types.includes('events')) return 'rgba(168,132,255,.48)';
    if(types.includes('ux')) return 'rgba(74,214,178,.50)';
    return 'rgba(0,0,0,.30)';
  }
  function getEdgesFiltered(){
    const typesOn = currentTypes();
    const minW = currentMin();
    const matches = getSearchMatches(search?.value || '');
    const hasSearch = matches.size>0;
    const focusOn = focusBtn?.classList.contains('isOn');

    let edges = cells
      .filter(c=>parseInt(c.dataset.w||'0',10)>0)
      .map(c=>({
        from: c.dataset.from,
        to: c.dataset.to,
        w: parseInt(c.dataset.w||'0',10),
        why: c.dataset.why || '—',
        types: (c.dataset.types||'').split(',').filter(Boolean),
      }))
      .filter(e=> e.w >= minW && (e.types.length===0 ? true : e.types.some(t=>typesOn.has(t))) );

    if(hasSearch){
      edges = edges.filter(e=> matches.has(e.from) || matches.has(e.to));
      if(focusOn){
        // keep only edges touching matched set (already), fine
      }
    }
    return edges;
  }
  const modIds = colHeads.map(h=>h.dataset.mid);
  const modLabel = new Map(colHeads.map(h=>[h.dataset.mid, h.textContent.trim()]));
  let graphState = { nodes: [], edges: [], svg: null, W: 0, H: 0, dragging: null };

  function renderGraphForce(){
    if(!graphCanvas) return;
    const rect = graphCanvas.getBoundingClientRect();
    const W = Math.max(760, Math.floor(rect.width));
    const H = Math.max(520, Math.floor(rect.height));
    graphState.W = W; graphState.H = H;

    const edges = getEdgesFiltered();
    // determine which nodes appear (keep all for context, but fade those not in edges)
    const used = new Set();
    edges.forEach(e=>{ used.add(e.from); used.add(e.to); });

    // init nodes with random positions around center
    const cx = W/2, cy = H/2;
    const nodes = modIds.map((id, i)=>({
      id,
      label: modLabel.get(id) || id,
      x: cx + (Math.random()-.5)*W*0.45,
      y: cy + (Math.random()-.5)*H*0.45,
      vx: 0, vy: 0,
      fixed: false,
      used: used.has(id),
    }));

    graphState.nodes = nodes;
    graphState.edges = edges;

    const defs = `
      <defs>
        <marker id="arrG2" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
          <path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
        </marker>
        <filter id="shG2" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="10" stdDeviation="10" flood-color="rgba(0,0,0,0.18)"/>
        </filter>
      </defs>`;

    let svg = `<svg class="heatGraphSvg" viewBox="0 0 ${W} ${H}" width="100%" height="100%" role="img" aria-label="dependency graph">${defs}`;
    svg += `<g class="gEdges"></g><g class="gNodes"></g></svg>`;
    graphCanvas.innerHTML = svg;

    const svgEl = graphCanvas.querySelector('svg');
    graphState.svg = svgEl;

    // create edges as paths
    const gEdges = svgEl.querySelector('.gEdges');
    edges.forEach((e, idx)=>{
      const p = document.createElementNS('http://www.w3.org/2000/svg','path');
      const sw = 1.6 + e.w*0.9;
      p.setAttribute('class','heatEdge');
      p.style.setProperty('--sw', `${sw}`);
      p.setAttribute('stroke', edgeColor(e.types));
      p.setAttribute('stroke-width', `${sw}`);
      p.setAttribute('fill','none');
      p.setAttribute('opacity','0.88');
      p.setAttribute('marker-end','url(#arrG2)');
      p.dataset.from = e.from;
      p.dataset.to = e.to;
      p.dataset.w = String(e.w);
      p.dataset.why = e.why;
      p.addEventListener('click', ()=>{
        const fromH = rowHeads.find(h=>h.dataset.mid===e.from)?.textContent || e.from;
        const toH = colHeads.find(h=>h.dataset.mid===e.to)?.textContent || e.to;
        panel.querySelector('.heatPanelTitle').textContent = `Связь: ${fromH} → ${toH}`;
        panel.querySelector('.heatK').textContent = `Сила: ${e.w}`;
        panel.querySelector('.heatV').textContent = e.why || '—';
        showToast('Связь обновлена (Graph)');
      });
      gEdges.appendChild(p);
    });

    // create nodes as groups
    const gNodes = svgEl.querySelector('.gNodes');
    nodes.forEach(n=>{
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','heatNode');
      g.dataset.id = n.id;
      g.setAttribute('filter','url(#shG2)');
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('r','22');
      c.setAttribute('fill','currentColor');
      c.setAttribute('fill-opacity', n.used ? '0.12' : '0.05');
      c.setAttribute('stroke','currentColor');
      c.setAttribute('stroke-opacity','0.22');
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('class','heatNodeLabel');
      t.setAttribute('text-anchor','middle');
      t.setAttribute('y','42');
      t.textContent = n.label;
      g.appendChild(c); g.appendChild(t);
      gNodes.appendChild(g);
    });

    // force simulation (simple)
    const nodeById = new Map(nodes.map(n=>[n.id,n]));
    const edgesIdx = edges.map(e=>({a: nodeById.get(e.from), b: nodeById.get(e.to), w: e.w}));

    function tick(){
      const W = graphState.W, H = graphState.H;
      // repulsion
      for(let i=0;i<nodes.length;i++){
        const a = nodes[i];
        for(let j=i+1;j<nodes.length;j++){
          const b = nodes[j];
          let dx = a.x - b.x;
          let dy = a.y - b.y;
          let d2 = dx*dx + dy*dy + 0.01;
          const k = 1200 / d2; // strength
          a.vx += dx*k;
          a.vy += dy*k;
          b.vx -= dx*k;
          b.vy -= dy*k;
        }
      }
      // attraction along edges
      edgesIdx.forEach(e=>{
        const a = e.a, b = e.b;
        if(!a || !b) return;
        const dx = b.x - a.x;
        const dy = b.y - a.y;
        const dist = Math.sqrt(dx*dx + dy*dy) + 0.01;
        const desired = 150 + (4-e.w)*22; // stronger edge -> closer
        const pull = (dist - desired) * 0.005;
        a.vx += dx*pull;
        a.vy += dy*pull;
        b.vx -= dx*pull;
        b.vy -= dy*pull;
      });
      // centering + damping
      nodes.forEach(n=>{
        if(n.fixed) return;
        n.vx += (W/2 - n.x) * 0.0008;
        n.vy += (H/2 - n.y) * 0.0008;
        n.vx *= 0.86;
        n.vy *= 0.86;
        n.x += n.vx;
        n.y += n.vy;
        // bounds
        const pad = 40;
        n.x = Math.max(pad, Math.min(W-pad, n.x));
        n.y = Math.max(pad, Math.min(H-pad, n.y));
      });
    }

    function draw(){
      // edges
      svgEl.querySelectorAll('.heatEdge').forEach(p=>{
        const from = nodeById.get(p.dataset.from);
        const to = nodeById.get(p.dataset.to);
        if(!from || !to) return;
        // quadratic curve with control point for nicer flow
        const mx = (from.x + to.x)/2;
        const my = (from.y + to.y)/2;
        const bend = 0.18;
        const cx = mx + (from.y - to.y)*bend;
        const cy = my + (to.x - from.x)*bend;
        p.setAttribute('d', `M${from.x} ${from.y} Q ${cx} ${cy} ${to.x} ${to.y}`);
      });
      // nodes
      svgEl.querySelectorAll('.heatNode').forEach(g=>{
        const n = nodeById.get(g.dataset.id);
        if(!n) return;
        g.setAttribute('transform', `translate(${n.x},${n.y})`);
        const c = g.querySelector('circle');
        if(c){
          c.setAttribute('fill-opacity', n.used ? '0.12' : '0.05');
        }
      });
    }

    // Run a few warmup ticks so layout looks good immediately
    for(let i=0;i<90;i++){ tick(); }
    draw();

    // Animate gently for a short time
    let steps = 0;
    function raf(){
      tick();
      draw();
      steps++;
      if(steps < 240) requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    // Drag behavior
    let drag = null;
    function svgPoint(evt){
      const pt = svgEl.createSVGPoint();
      pt.x = evt.clientX; pt.y = evt.clientY;
      const m = svgEl.getScreenCTM().inverse();
      return pt.matrixTransform(m);
    }
    svgEl.querySelectorAll('.heatNode').forEach(g=>{
      g.addEventListener('pointerdown', (evt)=>{
        evt.preventDefault();
        const id = g.dataset.id;
        drag = nodeById.get(id);
        if(!drag) return;
        drag.fixed = true;
        g.setPointerCapture(evt.pointerId);
      });
      g.addEventListener('pointermove', (evt)=>{
        if(!drag) return;
        const p = svgPoint(evt);
        drag.x = p.x; drag.y = p.y;
        drag.vx = 0; drag.vy = 0;
        draw();
      });
      g.addEventListener('pointerup', ()=>{
        if(!drag) return;
        drag.fixed = false;
        drag = null;
        // let it settle a bit
        steps = 0;
        requestAnimationFrame(raf);
      });
      g.addEventListener('pointercancel', ()=>{ if(drag){ drag.fixed=false; drag=null; } });
    });
  }

  // init
  applyMatrixFilterAndSearch();
  setView('matrix');
  // default selection
  grid.querySelector('.heatCell[data-from="quests"][data-to="db"]')?.click();

  // resize: rerender graph if visible
  window.addEventListener('resize', ()=>{
    if(viewBtns.find(x=>x.classList.contains('isOn'))?.dataset.view==='graph'){
      renderGraphForce();
    }
  });
}
window.addEventListener('load', initHeatmapV16);


// --- v17 Heatmap: autocomplete/pin/reset/export + tooltip + persistent layout ---
function initHeatmapV17(){
  const root = document.querySelector('#heatmap');
  if(!root) return;

  const viewBtns = Array.from(root.querySelectorAll('.heatViewBtn'));
  const graphCanvas = root.querySelector('.heatGraphCanvas');
  const graphWrap = root.querySelector('.heatGraphWrap');
  const search = root.querySelector('.heatSearchInput');
  const grid = root.querySelector('.heatGrid');

  // small store to keep node positions/pins across re-renders
  const store = window.__AF_HEAT_GRAPH__ = window.__AF_HEAT_GRAPH__ || {
    pos: new Map(), // id -> {x,y}
    pinned: new Set(),
    lastSvg: null
  };

  const tip = root.querySelector('.heatTip');
  const tipK = tip?.querySelector('.heatTipK');
  const tipV = tip?.querySelector('.heatTipV');

  function showTip(title, body){
    if(!tip) return;
    tip.hidden = false;
    if(tipK) tipK.textContent = title;
    if(tipV) tipV.textContent = body;
  }
  function hideTip(){ if(tip) tip.hidden = true; }

  function getCurrentView(){
    return viewBtns.find(b=>b.classList.contains('isOn'))?.dataset.view || 'matrix';
  }

  // Hook graph tool buttons
  root.querySelectorAll('.heatGraphBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const cmd = btn.dataset.gcmd;
      if(cmd === 'reset'){
        store.pos.clear();
        store.pinned.clear();
        // if graph visible, trigger re-render by firing resize
        if(getCurrentView()==='graph') window.dispatchEvent(new Event('resize'));
        showToast?.('Layout reset');
      }
      if(cmd === 'export-svg'){
        exportGraph('svg');
      }
      if(cmd === 'export-png'){
        exportGraph('png');
      }
    });
  });

  function exportGraph(kind){
    if(!graphCanvas) return;
    const svg = graphCanvas.querySelector('svg');
    if(!svg) { showToast?.('Нет SVG для экспорта'); return; }
    const serializer = new XMLSerializer();
    const svgText = serializer.serializeToString(svg);
    if(kind==='svg'){
      const blob = new Blob([svgText], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'af_heatmap_graph.svg';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
      showToast?.('SVG exported');
      return;
    }
    // PNG: draw svg onto canvas
    const img = new Image();
    const blob = new Blob([svgText], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const bbox = svg.viewBox.baseVal;
      canvas.width = Math.max(1, Math.floor(bbox.width || svg.clientWidth || 1200));
      canvas.height = Math.max(1, Math.floor(bbox.height || svg.clientHeight || 600));
      const ctx = canvas.getContext('2d');
      // background for PNG (transparent looks weird sometimes)
      ctx.fillStyle = 'rgba(255,255,255,1)';
      ctx.fillRect(0,0,canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      URL.revokeObjectURL(url);
      const pngUrl = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = pngUrl;
      a.download = 'af_heatmap_graph.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
      showToast?.('PNG exported');
    };
    img.onerror = () => { URL.revokeObjectURL(url); showToast?.('PNG export failed'); };
    img.src = url;
  }

  // Improve autocomplete: if user types exact label, swap to module id (optional)
  search?.addEventListener('change', ()=>{
    const v = (search.value||'').trim();
    const dl = root.querySelector('#moduleList');
    if(!dl) return;
    const opt = Array.from(dl.querySelectorAll('option')).find(o=>o.value.toLowerCase() === v.toLowerCase());
    if(opt && opt.dataset.mid){
      // Keep label but store mid in data attribute for downstream (optional)
      search.dataset.mid = opt.dataset.mid;
    }else{
      search.dataset.mid = '';
    }
  });

  // Extend v16 graph render with persistence + pin + tooltip
  // We'll monkey-patch by wrapping existing renderer if present.
  const oldResize = null;

  // Observe when graph svg changes; attach interactions
  function attachGraphInteractions(){
    if(!graphCanvas) return;
    const svg = graphCanvas.querySelector('svg');
    if(!svg) return;
    store.lastSvg = svg;

    // Edge tooltip on hover
    svg.querySelectorAll('.heatEdge').forEach(edge=>{
      edge.addEventListener('mouseenter', ()=>{
        const from = edge.dataset.from || '';
        const to = edge.dataset.to || '';
        const w = edge.dataset.w || '';
        showTip(`Edge: ${from} → ${to}`, `Сила: ${w}. Клик — открыть объяснение справа.`);
      });
      edge.addEventListener('mouseleave', hideTip);
    });

    // Node pin on dblclick
    svg.querySelectorAll('.heatNode').forEach(node=>{
      node.addEventListener('dblclick', (e)=>{
        e.preventDefault();
        const id = node.dataset.id;
        if(!id) return;
        if(store.pinned.has(id)){
          store.pinned.delete(id);
          node.classList.remove('isPinned');
          showToast?.('Unpinned');
        }else{
          store.pinned.add(id);
          node.classList.add('isPinned');
          showToast?.('Pinned');
        }
      });
      node.addEventListener('mouseenter', ()=>{
        const id = node.dataset.id || '';
        showTip(`Node: ${id}`, store.pinned.has(id) ? 'Pinned (двойной клик — открепить)' : 'Двойной клик — закрепить');
      });
      node.addEventListener('mouseleave', hideTip);
    });
  }

  // We can't directly hook into v16 force renderer, but we can detect re-renders after resize/filter changes.
  // So: after any click on view switch to graph, attach after a small delay.
  viewBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      if(b.dataset.view==='graph'){
        setTimeout(attachGraphInteractions, 120);
      }
    });
  });

  // Also attach on resize (graph re-render)
  window.addEventListener('resize', ()=>{
    if(getCurrentView()==='graph'){
      setTimeout(attachGraphInteractions, 160);
    }
  });

  // Initial attach if already graph (unlikely)
  if(getCurrentView()==='graph'){
    setTimeout(attachGraphInteractions, 160);
  }

  // Persist pins visually after each render
  function applyPinnedClass(){
    const svg = graphCanvas?.querySelector('svg');
    if(!svg) return;
    svg.querySelectorAll('.heatNode').forEach(n=>{
      const id = n.dataset.id;
      if(id && store.pinned.has(id)) n.classList.add('isPinned');
    });
  }
  window.addEventListener('resize', ()=>{ if(getCurrentView()==='graph') setTimeout(applyPinnedClass, 180); });

  // One-time: when switching to graph and back, keep matrix selected and avoid odd focus class on headers
  grid?.addEventListener('mouseleave', ()=> hideTip());
}
window.addEventListener('load', initHeatmapV17);


// --- v18: State-in-URL, neighborhood hops, new graph engine w/ pinned nodes & drag persistence ---
function initHeatmapV18(){
  if(window.__AF_HEAT_V18__) return;
  window.__AF_HEAT_V18__ = true;

  const root = document.querySelector('#heatmap');
  if(!root) return;

  const grid = root.querySelector('.heatGrid');
  const panel = root.querySelector('.heatPanel');
  const graphWrap = root.querySelector('.heatGraphWrap');
  const graphCanvas = root.querySelector('.heatGraphCanvas');

  const viewBtns = Array.from(root.querySelectorAll('.heatViewBtn'));
  const typeBtns = Array.from(root.querySelectorAll('.heatTypeBtn'));
  const range = root.querySelector('.heatRangeInput');
  const rangeVal = root.querySelector('.heatRangeValue');
  const strongOnly = root.querySelector('.heatCheckInput');
  const search = root.querySelector('.heatSearchInput');
  const focusBtn = root.querySelector('.heatFocusBtn');
  const hopSel = root.querySelector('.heatHopSelect');
  const copyBtn = root.querySelector('.heatCopyLinkBtn');

  const colHeads = Array.from(grid.querySelectorAll('.heatHead.heatCol'));
  const rowHeads = Array.from(grid.querySelectorAll('.heatHead.heatRow'));
  const cells = Array.from(grid.querySelectorAll('.heatCell'));

  // Persistent store for graph
  const store = window.__AF_HEAT_GRAPH_STORE__ = window.__AF_HEAT_GRAPH_STORE__ || {
    pos: new Map(), // id -> {x,y}
    pinned: new Set(), // ids
  };

  // ------- Utilities -------
  function esc(s){ return (s||'').toLowerCase().trim(); }
  function currentTypes(){
    return new Set(typeBtns.filter(b=>b.classList.contains('isOn')).map(b=>b.dataset.type));
  }
  function currentMin(){
    const v = parseInt(range?.value || '0', 10);
    return strongOnly?.checked ? Math.max(3, v) : v;
  }
  function getSearchMatches(){
    const s = esc(search?.value || '');
    if(!s) return new Set();
    const ids = new Set();
    [...colHeads, ...rowHeads].forEach(h=>{
      const id = h.dataset.mid;
      const label = (h.textContent||'').toLowerCase();
      if(label.includes(s) || (id||'').includes(s)) ids.add(id);
    });
    const mid = search?.dataset?.mid;
    if(mid) ids.add(mid);
    return ids;
  }
  function cellMatches(cell, typesOn, minW){
    const w = parseInt(cell.dataset.w || '0', 10);
    if(w < minW) return false;
    const t = (cell.dataset.types || '').split(',').filter(Boolean);
    if(t.length === 0) return true;
    if(typesOn.size === 0) return true;
    return t.some(x=>typesOn.has(x));
  }
  function getFilteredEdges(){
    const typesOn = currentTypes();
    const minW = currentMin();
    return cells
      .filter(c=>parseInt(c.dataset.w||'0',10)>0)
      .map(c=>({
        from: c.dataset.from,
        to: c.dataset.to,
        w: parseInt(c.dataset.w||'0',10),
        why: c.dataset.why || '—',
        types: (c.dataset.types||'').split(',').filter(Boolean),
      }))
      .filter(e=> e.w >= minW && (e.types.length===0 ? true : e.types.some(t=>typesOn.has(t))) );
  }

  function getCurrentView(){
    return viewBtns.find(b=>b.classList.contains('isOn'))?.dataset.view || 'matrix';
  }
  function setView(v){
    viewBtns.forEach(b=>b.classList.toggle('isOn', b.dataset.view===v));
    if(v==='graph'){
      grid.hidden = true;
      graphWrap.hidden = false;
      renderGraph();
    }else{
      grid.hidden = false;
      graphWrap.hidden = true;
    }
    syncHash();
  }

  // ------- Neighborhood hops (0/1/2) -------
  function buildAdj(edges){
    const adj = new Map();
    function add(a,b){
      if(!adj.has(a)) adj.set(a, new Set());
      adj.get(a).add(b);
    }
    edges.forEach(e=>{ add(e.from,e.to); add(e.to,e.from); });
    return adj;
  }
  function bfs(adj, seeds, hops){
    const dist = new Map();
    const q = [];
    seeds.forEach(s=>{ dist.set(s,0); q.push(s); });
    while(q.length){
      const u = q.shift();
      const d = dist.get(u);
      if(d>=hops) continue;
      (adj.get(u)||new Set()).forEach(v=>{
        if(!dist.has(v)){
          dist.set(v, d+1);
          q.push(v);
        }
      });
    }
    return dist;
  }

  function applyNeighborhood(){
    const edges = getFilteredEdges();
    const adj = buildAdj(edges);
    const seeds = getSearchMatches();
    const hops = parseInt(hopSel?.value || '1', 10);

    // clear old
    [...colHeads, ...rowHeads].forEach(h=>h.classList.remove('isNear1','isNear2','isFocus'));
    cells.forEach(c=>c.classList.remove('isNear1','isNear2','isFocus'));

    if(seeds.size===0 || hops===0) return {seeds, near1:new Set(), near2:new Set(), dist:new Map()};
    const dist = bfs(adj, seeds, hops);
    const near1 = new Set([...dist.entries()].filter(([k,v])=>v===1).map(([k])=>k));
    const near2 = new Set([...dist.entries()].filter(([k,v])=>v===2).map(([k])=>k));

    [...colHeads, ...rowHeads].forEach(h=>{
      const id = h.dataset.mid;
      if(seeds.has(id)) h.classList.add('isFocus');
      else if(near1.has(id)) h.classList.add('isNear1');
      else if(near2.has(id)) h.classList.add('isNear2');
    });
    cells.forEach(c=>{
      const a=c.dataset.from, b=c.dataset.to;
      if(seeds.has(a) || seeds.has(b)) c.classList.add('isFocus');
      else if(near1.has(a) || near1.has(b)) c.classList.add('isNear1');
      else if(near2.has(a) || near2.has(b)) c.classList.add('isNear2');
    });

    return {seeds, near1, near2, dist};
  }

  // ------- Matrix filter + focus -------
  function applyMatrix(){
    const typesOn = currentTypes();
    const minW = currentMin();
    rangeVal.textContent = `≥ ${minW}`;

    const {seeds, near1, near2} = applyNeighborhood();
    const hasSearch = seeds.size>0;
    const focusOn = !!focusBtn?.classList.contains('isOn');

    colHeads.forEach(h=>{
      const id = h.dataset.mid;
      const on = !hasSearch || seeds.has(id) || near1.has(id) || near2.has(id);
      h.classList.toggle('isDim', hasSearch && !on);
    });
    rowHeads.forEach(h=>{
      const id = h.dataset.mid;
      const on = !hasSearch || seeds.has(id) || near1.has(id) || near2.has(id);
      h.classList.toggle('isDim', hasSearch && !on);
    });

    cells.forEach(c=>{
      const pass = cellMatches(c, typesOn, minW);
      let passSearch = true;
      if(hasSearch){
        passSearch = focusOn ? (seeds.has(c.dataset.from) || seeds.has(c.dataset.to))
                             : (seeds.has(c.dataset.from) || seeds.has(c.dataset.to) || c.classList.contains('isNear1') || c.classList.contains('isNear2'));
      }
      const show = pass && (!hasSearch || passSearch);
      c.classList.toggle('isDim', !show);
      c.disabled = !show;
    });

    grid.classList.toggle('isFocus', focusOn && hasSearch);
    const sel = grid.querySelector('.heatCell.isSel');
    if(sel && sel.disabled){
      grid.querySelector('.heatCell[data-from="quests"][data-to="db"]')?.click();
    }
  }

  // ------- Graph engine (force + drag + pins + persistence + type pills) -------
  function edgeColor(types){
    if(types.includes('data')) return 'rgba(87,166,255,.56)';
    if(types.includes('events')) return 'rgba(168,132,255,.52)';
    if(types.includes('ux')) return 'rgba(74,214,178,.54)';
    return 'rgba(0,0,0,.30)';
  }
  function edgeBadge(types){
    const t = new Set(types);
    const parts = [];
    if(t.has('data')) parts.push('D');
    if(t.has('events')) parts.push('E');
    if(t.has('ux')) parts.push('U');
    return parts.join('');
  }

  function renderGraph(){
    if(!graphCanvas) return;
    const rect = graphCanvas.getBoundingClientRect();
    const W = Math.max(760, Math.floor(rect.width));
    const H = Math.max(520, Math.floor(rect.height));

    const edges = getFilteredEdges();
    const ids = colHeads.map(h=>h.dataset.mid);
    const labels = new Map(colHeads.map(h=>[h.dataset.mid, h.textContent.trim()]));
    const used = new Set();
    edges.forEach(e=>{ used.add(e.from); used.add(e.to); });

    // neighborhood distance for node fill
    const {seeds, dist} = applyNeighborhood();

    const cx=W/2, cy=H/2;
    const nodes = ids.map(id=>{
      const saved = store.pos.get(id);
      const base = saved ? {x:saved.x, y:saved.y} : {x: cx + (Math.random()-.5)*W*0.44, y: cy + (Math.random()-.5)*H*0.44};
      const pinned = store.pinned.has(id);
      return {
        id, label: labels.get(id)||id,
        x: base.x, y: base.y, vx:0, vy:0,
        fixed: pinned,
        used: used.has(id),
        dist: dist.has(id) ? dist.get(id) : null
      };
    });
    const nodeById = new Map(nodes.map(n=>[n.id,n]));
    const edgesIdx = edges.map(e=>({a: nodeById.get(e.from), b: nodeById.get(e.to), w: e.w})).filter(x=>x.a&&x.b);

    graphCanvas.innerHTML = `
      <svg class="heatGraphSvg" viewBox="0 0 ${W} ${H}" width="100%" height="100%" role="img" aria-label="dependency graph">
        <defs>
          <marker id="arrG3" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
            <path d="M0,0 L10,3 L0,6 Z" fill="currentColor" fill-opacity="0.45"></path>
          </marker>
          <filter id="shG3" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="10" stdDeviation="10" flood-color="rgba(0,0,0,0.18)"/>
          </filter>
        </defs>
        <g class="gEdges"></g>
        <g class="gEdgeLabels"></g>
        <g class="gNodes"></g>
      </svg>
    `;
    const svg = graphCanvas.querySelector('svg');
    const gEdges = svg.querySelector('.gEdges');
    const gLabels = svg.querySelector('.gEdgeLabels');
    const gNodes = svg.querySelector('.gNodes');

    const edgeEls = [];
    const labelEls = [];

    edges.forEach(e=>{
      const sw = 1.6 + e.w*0.9;
      const p = document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('class','heatEdge');
      p.style.setProperty('--sw', `${sw}`);
      p.setAttribute('stroke', edgeColor(e.types));
      p.setAttribute('stroke-width', `${sw}`);
      p.setAttribute('fill','none');
      p.setAttribute('opacity','0.88');
      p.setAttribute('marker-end','url(#arrG3)');
      p.dataset.from=e.from; p.dataset.to=e.to; p.dataset.w=String(e.w); p.dataset.why=e.why;
      p.addEventListener('click', ()=>{
        const fromH = rowHeads.find(h=>h.dataset.mid===e.from)?.textContent || e.from;
        const toH = colHeads.find(h=>h.dataset.mid===e.to)?.textContent || e.to;
        panel.querySelector('.heatPanelTitle').textContent = `Связь: ${fromH} → ${toH}`;
        panel.querySelector('.heatK').textContent = `Сила: ${e.w}`;
        panel.querySelector('.heatV').textContent = e.why || '—';
        showToast('Связь обновлена (Graph)');
      });
      gEdges.appendChild(p);
      edgeEls.append({e, el:p});

      // type pill
      const badge = edgeBadge(e.types||[]);
      const lg = document.createElementNS('http://www.w3.org/2000/svg','g');
      if(!badge) lg.setAttribute('display','none');
      const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
      r.setAttribute('class','heatEdgePill');
      r.setAttribute('rx','10'); r.setAttribute('ry','10');
      r.setAttribute('width', String(Math.max(20, 12 + badge.length*8)));
      r.setAttribute('height','18');
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('class','heatEdgeLabel');
      t.setAttribute('x','10'); t.setAttribute('y','13');
      t.textContent = badge;
      lg.appendChild(r); lg.appendChild(t);
      gLabels.appendChild(lg);
      labelEls.append({e, el:lg, badge});
    });

    const nodeEls = [];
    nodes.forEach(n=>{
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','heatNode' + (n.fixed ? ' isPinned' : ''));
      g.dataset.id = n.id;
      g.setAttribute('filter','url(#shG3)');
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('r','22');
      c.setAttribute('fill','currentColor');
      let fo = n.used ? 0.12 : 0.05;
      if(n.dist === 0) fo = 0.18;
      if(n.dist === 1) fo = 0.14;
      if(n.dist === 2) fo = 0.12;
      c.setAttribute('fill-opacity', String(fo));
      c.setAttribute('stroke','currentColor');
      c.setAttribute('stroke-opacity', n.fixed ? '0.38':'0.22');
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('class','heatNodeLabel');
      t.setAttribute('text-anchor','middle');
      t.setAttribute('y','42');
      t.textContent = n.label;
      g.appendChild(c); g.appendChild(t);
      gNodes.appendChild(g);
      nodeEls.append({n, el:g});
    });

    function tick(){
      for(let i=0;i<nodes.length;i++){
        const a = nodes[i];
        for(let j=i+1;j<nodes.length;j++){
          const b = nodes[j];
          let dx=a.x-b.x, dy=a.y-b.y;
          let d2=dx*dx+dy*dy+0.01;
          const k=1200/d2;
          if(!a.fixed){ a.vx += dx*k; a.vy += dy*k; }
          if(!b.fixed){ b.vx -= dx*k; b.vy -= dy*k; }
        }
      }
      edgesIdx.forEach(e=>{
        const a=e.a, b=e.b;
        const dx=b.x-a.x, dy=b.y-a.y;
        const dist=Math.sqrt(dx*dx+dy*dy)+0.01;
        const desired=150+(4-e.w)*22;
        const pull=(dist-desired)*0.005;
        if(!a.fixed){ a.vx += dx*pull; a.vy += dy*pull; }
        if(!b.fixed){ b.vx -= dx*pull; b.vy -= dy*pull; }
      });
      nodes.forEach(n=>{
        if(n.fixed) return;
        n.vx += (W/2 - n.x)*0.0008;
        n.vy += (H/2 - n.y)*0.0008;
        n.vx *= 0.86; n.vy *= 0.86;
        n.x += n.vx; n.y += n.vy;
        const pad=40;
        n.x=Math.max(pad, Math.min(W-pad, n.x));
        n.y=Math.max(pad, Math.min(H-pad, n.y));
      });
    }

    function draw(){
      edgeEls.forEach(({e,el})=>{
        const from=nodeById.get(e.from), to=nodeById.get(e.to);
        if(!from||!to) return;
        const mx=(from.x+to.x)/2, my=(from.y+to.y)/2;
        const bend=0.18;
        const cx2=mx+(from.y-to.y)*bend;
        const cy2=my+(to.x-from.x)*bend;
        el.setAttribute('d', `M${from.x} ${from.y} Q ${cx2} ${cy2} ${to.x} ${to.y}`);
      });
      labelEls.forEach(({e,el,badge})=>{
        if(!badge){ el.setAttribute('display','none'); return; }
        const from=nodeById.get(e.from), to=nodeById.get(e.to);
        if(!from||!to) return;
        const mx=(from.x+to.x)/2, my=(from.y+to.y)/2;
        el.setAttribute('transform', `translate(${mx-14},${my-9})`);
      });
      nodeEls.forEach(({n,el})=>{
        el.setAttribute('transform', `translate(${n.x},${n.y})`);
      });
      nodes.forEach(n=> store.pos.set(n.id, {x:n.x, y:n.y}));
    }

    for(let i=0;i<90;i++){ tick(); }
    draw();

    let steps=0;
    function raf(){
      tick(); draw();
      steps++;
      if(steps < 260) requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    // Drag + pin
    let drag=null;
    function svgPoint(evt){
      const pt=svg.createSVGPoint();
      pt.x=evt.clientX; pt.y=evt.clientY;
      const m=svg.getScreenCTM().inverse();
      return pt.matrixTransform(m);
    }
    svg.querySelectorAll('.heatNode').forEach(nodeEl=>{
      nodeEl.addEventListener('pointerdown', (evt)=>{
        evt.preventDefault();
        const id=nodeEl.dataset.id;
        drag=nodeById.get(id);
        if(!drag) return;
        drag.fixed=true;
        store.pinned.add(id);
        nodeEl.classList.add('isPinned');
        nodeEl.setPointerCapture(evt.pointerId);
      });
      nodeEl.addEventListener('pointermove', (evt)=>{
        if(!drag) return;
        const p=svgPoint(evt);
        drag.x=p.x; drag.y=p.y;
        drag.vx=0; drag.vy=0;
        draw();
      });
      nodeEl.addEventListener('pointerup', ()=>{
        if(!drag) return;
        drag=null;
        steps=0; requestAnimationFrame(raf);
      });
      nodeEl.addEventListener('dblclick', (evt)=>{
        evt.preventDefault();
        const id=nodeEl.dataset.id;
        const n=nodeById.get(id);
        if(!n) return;
        if(store.pinned.has(id)){
          store.pinned.delete(id);
          n.fixed=false;
          nodeEl.classList.remove('isPinned');
          showToast('Unpinned');
        }else{
          store.pinned.add(id);
          n.fixed=true;
          nodeEl.classList.add('isPinned');
          showToast('Pinned');
        }
      });
    });
  }

  // ------- URL hash state -------
  function readHash(){
    const h = (location.hash||'').replace(/^#/,'');
    if(!h.startsWith('hm=')) return null;
    const qs = h.slice(3);
    const params = new URLSearchParams(qs);
    return {
      view: params.get('view') || 'matrix',
      min: params.get('min') || '1',
      strong: params.get('strong') === '1',
      focus: params.get('focus') === '1',
      search: params.get('search') ? decodeURIComponent(params.get('search')) : '',
      types: (params.get('types')||'data,events,ux').split(',').filter(Boolean),
      hops: params.get('hops') || '1'
    };
  }
  function syncHash(){
    const types = typeBtns.filter(b=>b.classList.contains('isOn')).map(b=>b.dataset.type).join(',');
    const st = new URLSearchParams();
    st.set('view', getCurrentView());
    st.set('min', range?.value || '1');
    st.set('strong', strongOnly?.checked ? '1':'0');
    st.set('focus', focusBtn?.classList.contains('isOn') ? '1':'0');
    st.set('types', types || 'data,events,ux');
    st.set('hops', hopSel?.value || '1');
    const q = (search?.value || '').trim();
    if(q) st.set('search', encodeURIComponent(q));
    const nh = '#hm=' + st.toString();
    if(location.hash !== nh) history.replaceState(null,'', nh);
  }
  function applyState(st){
    if(!st) return;
    if(range) range.value = st.min;
    if(strongOnly) strongOnly.checked = !!st.strong;
    if(hopSel) hopSel.value = st.hops;
    if(search) search.value = st.search || '';
    typeBtns.forEach(b=> b.classList.toggle('isOn', st.types.includes(b.dataset.type)) );
    if(focusBtn){
      focusBtn.classList.toggle('isOn', !!st.focus);
      focusBtn.textContent = focusBtn.classList.contains('isOn') ? 'Focus: ON' : 'Focus: OFF';
    }
    setView(st.view === 'graph' ? 'graph' : 'matrix');
  }

  // Copy link
  copyBtn?.addEventListener('click', async ()=>{
    syncHash();
    const url = location.href;
    try{
      await navigator.clipboard.writeText(url);
      showToast('Link copied');
    }catch(e){
      const ta=document.createElement('textarea');
      ta.value=url; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); ta.remove();
      showToast('Link copied');
    }
  });

  // Wire UI changes
  viewBtns.forEach(b=> b.addEventListener('click', ()=> setView(b.dataset.view)) );
  typeBtns.forEach(b=> b.addEventListener('click', ()=>{ b.classList.toggle('isOn'); applyMatrix(); if(getCurrentView()==='graph') renderGraph(); syncHash(); }) );
  range?.addEventListener('input', ()=>{ applyMatrix(); if(getCurrentView()==='graph') renderGraph(); syncHash(); });
  strongOnly?.addEventListener('change', ()=>{ applyMatrix(); if(getCurrentView()==='graph') renderGraph(); syncHash(); });
  search?.addEventListener('input', ()=>{ applyMatrix(); if(getCurrentView()==='graph') renderGraph(); syncHash(); });
  hopSel?.addEventListener('change', ()=>{ applyMatrix(); if(getCurrentView()==='graph') renderGraph(); syncHash(); });
  focusBtn?.addEventListener('click', ()=>{
    focusBtn.classList.toggle('isOn');
    focusBtn.textContent = focusBtn.classList.contains('isOn') ? 'Focus: ON' : 'Focus: OFF';
    applyMatrix();
    if(getCurrentView()==='graph') renderGraph();
    syncHash();
  });

  // Init
  const st = readHash();
  if(st) applyState(st);
  applyMatrix();
  grid.querySelector('.heatCell[data-from="quests"][data-to="db"]')?.click();
  if(getCurrentView()==='graph') renderGraph();
  syncHash();

  window.addEventListener('resize', ()=>{ if(getCurrentView()==='graph') renderGraph(); });
}
window.addEventListener('load', initHeatmapV18);


// --- v19: segmented hops + isolate subgraph + graph export buttons/legend ---
function initHeatmapV19(){
  if(window.__AF_HEAT_V19__) return;
  window.__AF_HEAT_V19__ = true;

  const root = document.querySelector('#heatmap');
  if(!root) return;

  const hopSel = root.querySelector('.heatHopSelect');
  const hopBtns = Array.from(root.querySelectorAll('.heatHopBtn'));
  const iso = root.querySelector('.heatIsoInput');
  const copyBtn = root.querySelector('.heatCopyLinkBtn');
  const viewBtns = Array.from(root.querySelectorAll('.heatViewBtn'));
  const typeBtns = Array.from(root.querySelectorAll('.heatTypeBtn'));
  const range = root.querySelector('.heatRangeInput');
  const strongOnly = root.querySelector('.heatCheckInput');
  const search = root.querySelector('.heatSearchInput');
  const focusBtn = root.querySelector('.heatFocusBtn');

  // Graph buttons
  root.querySelectorAll('.heatGraphBtnV19').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const cmd = btn.dataset.gcmd;
      if(cmd==='reset'){
        // clear pinned/pos from v18 store
        const store = window.__AF_HEAT_GRAPH_STORE__;
        if(store){ store.pos.clear(); store.pinned.clear(); }
        window.dispatchEvent(new Event('resize'));
        showToast('Layout reset');
      }
      if(cmd==='export-svg') exportGraph('svg');
      if(cmd==='export-png') exportGraph('png');
    });
  });

  function getCurrentView(){
    return viewBtns.find(b=>b.classList.contains('isOn'))?.dataset.view || 'matrix';
  }

  function exportGraph(kind){
    const canvas = root.querySelector('.heatGraphCanvas');
    const svg = canvas?.querySelector('svg');
    if(!svg){ showToast('Нет графа для экспорта'); return; }
    const serializer = new XMLSerializer();
    const svgText = serializer.serializeToString(svg);

    if(kind==='svg'){
      const blob = new Blob([svgText], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'af_graph.svg';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
      showToast('SVG exported');
      return;
    }

    const img = new Image();
    const blob = new Blob([svgText], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    img.onload = () => {
      const vb = svg.viewBox.baseVal;
      const W = Math.max(1, Math.floor(vb.width || svg.clientWidth || 1200));
      const H = Math.max(1, Math.floor(vb.height || svg.clientHeight || 600));
      const c = document.createElement('canvas');
      c.width = W; c.height = H;
      const ctx = c.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,1)';
      ctx.fillRect(0,0,W,H);
      ctx.drawImage(img, 0, 0, W, H);
      URL.revokeObjectURL(url);
      const pngUrl = c.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = pngUrl; a.download = 'af_graph.png';
      document.body.appendChild(a); a.click(); a.remove();
      showToast('PNG exported');
    };
    img.onerror = ()=>{ URL.revokeObjectURL(url); showToast('PNG export failed'); };
    img.src = url;
  }

  // Segmented hop buttons -> updates hidden select for v18 logic
  function syncHopButtons(val){
    hopBtns.forEach(b=> b.classList.toggle('isOn', b.dataset.hop===val));
  }
  // initialize from select
  if(hopSel){
    syncHopButtons(hopSel.value || '1');
  }
  hopBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      const v = b.dataset.hop;
      if(hopSel){ hopSel.value = v; hopSel.dispatchEvent(new Event('change')); }
      syncHopButtons(v);
    });
  });

  // isolate flag stored on root; v18 renderer will read via dataset and filter edges in graph.
  // We'll implement isolation by patching hash via 'iso=1' and storing root.dataset.iso.
  function setIso(on){
    root.dataset.iso = on ? '1' : '0';
  }
  if(iso){
    setIso(iso.checked);
    iso.addEventListener('change', ()=>{
      setIso(iso.checked);
      // cause re-render if graph
      if(getCurrentView()==='graph') window.dispatchEvent(new Event('resize'));
      // sync hash if present (we hook below)
      syncHashV19();
    });
  }

  // Extend URL hash with iso param (without breaking v18)
  function syncHashV19(){
    if(!location.hash.startsWith('#hm=')) return;
    const qs = location.hash.slice(4);
    const p = new URLSearchParams(qs);
    p.set('iso', (iso && iso.checked) ? '1':'0');
    // also keep hops from select
    if(hopSel) p.set('hops', hopSel.value || '1');
    const nh = '#hm=' + p.toString();
    if(location.hash !== nh) history.replaceState(null,'', nh);
  }
  // On load: if iso present in hash, apply
  function applyIsoFromHash(){
    if(!location.hash.startsWith('#hm=')) return;
    const qs = location.hash.slice(4);
    const p = new URLSearchParams(qs);
    const v = p.get('iso');
    if(v === null) return;
    const on = v === '1';
    if(iso) iso.checked = on;
    setIso(on);
  }
  applyIsoFromHash();

  // Hook into common change points to keep iso in hash
  const touch = ()=>{ setTimeout(syncHashV19, 0); };
  [copyBtn, range, strongOnly, search, focusBtn].forEach(el=>{
    if(!el) return;
    el.addEventListener('click', touch);
    el.addEventListener('change', touch);
    el.addEventListener('input', touch);
  });
  typeBtns.forEach(b=> b.addEventListener('click', touch));
  viewBtns.forEach(b=> b.addEventListener('click', touch));

  // Patch v18 graph filtering for isolate: we can't rewrite renderGraph, but we can intercept by adding a CSS class
  // and letting v18 keep nodes; isolation is done by dimming nodes outside neighborhood when iso=1 and search present.
  // We'll implement via a small CSS class toggle:
  function applyIsoVisual(){
    const on = (root.dataset.iso || '0') === '1';
    root.classList.toggle('isIsoOn', on);
  }
  applyIsoVisual();
  iso?.addEventListener('change', applyIsoVisual);
}
window.addEventListener('load', initHeatmapV19);


// --- v20: TRUE isolate (prunes graph), minimap overview, presentation mode ---
function initHeatmapV20(){
  if(window.__AF_HEAT_V20__) return;
  window.__AF_HEAT_V20__ = true;

  const root = document.querySelector('#heatmap');
  if(!root) return;

  const graphCanvas = root.querySelector('.heatGraphCanvas');
  const mini = root.querySelector('.heatMiniMap');
  const miniSvg = root.querySelector('.heatMiniMapSvg');
  const presentBtn = root.querySelector('.heatPresentBtn');

  const viewBtns = Array.from(root.querySelectorAll('.heatViewBtn'));
  const hopSel = root.querySelector('.heatHopSelect');
  const iso = root.querySelector('.heatIsoInput');
  const search = root.querySelector('.heatSearchInput');
  const typeBtns = Array.from(root.querySelectorAll('.heatTypeBtn'));
  const range = root.querySelector('.heatRangeInput');
  const strongOnly = root.querySelector('.heatCheckInput');
  const focusBtn = root.querySelector('.heatFocusBtn');

  // Cells provide ground truth for edges
  const grid = root.querySelector('.heatGrid');
  const cells = Array.from(grid.querySelectorAll('.heatCell'));

  function esc(s){ return (s||'').toLowerCase().trim(); }

  function currentTypes(){
    return new Set(typeBtns.filter(b=>b.classList.contains('isOn')).map(b=>b.dataset.type));
  }
  function currentMin(){
    const v = parseInt(range?.value || '0', 10);
    return strongOnly?.checked ? Math.max(3, v) : v;
  }

  function headerIdsMatching(q){
    const s = esc(q);
    if(!s) return new Set();
    const ids = new Set();
    root.querySelectorAll('.heatHead.heatCol, .heatHead.heatRow').forEach(h=>{
      const id = h.dataset.mid || '';
      const label = (h.textContent||'').toLowerCase();
      if(label.includes(s) || id.includes(s)) ids.add(id);
    });
    const mid = search?.dataset?.mid;
    if(mid) ids.add(mid);
    return ids;
  }

  function getFilteredEdgesFromMatrix(){
    // Use same logic as v18: weight/min + type filter; also respect visibility: if cell isDim, treat as filtered out.
    const typesOn = currentTypes();
    const minW = currentMin();
    return cells
      .filter(c=>!c.classList.contains('isDim')) // already filtered by v18 matrix logic
      .filter(c=>parseInt(c.dataset.w||'0',10) >= minW)
      .map(c=>({
        from: c.dataset.from,
        to: c.dataset.to,
        w: parseInt(c.dataset.w||'0',10),
        types: (c.dataset.types||'').split(',').filter(Boolean)
      }))
      .filter(e=> e.w>0 && (e.types.length===0 ? true : e.types.some(t=>typesOn.has(t))) );
  }

  function buildAdj(edges){
    const adj = new Map();
    const add = (a,b)=>{ if(!adj.has(a)) adj.set(a, new Set()); adj.get(a).add(b); };
    edges.forEach(e=>{ add(e.from,e.to); add(e.to,e.from); });
    return adj;
  }
  function bfs(adj, seeds, hops){
    const dist = new Map();
    const q = [];
    seeds.forEach(s=>{ dist.set(s,0); q.push(s); });
    while(q.length){
      const u = q.shift();
      const d = dist.get(u);
      if(d>=hops) continue;
      (adj.get(u)||new Set()).forEach(v=>{
        if(!dist.has(v)){ dist.set(v,d+1); q.push(v); }
      });
    }
    return dist;
  }

  function getView(){
    return viewBtns.find(b=>b.classList.contains('isOn'))?.dataset.view || 'matrix';
  }

  function applyIsoGraph(){
    if(getView()!=='graph') return;
    const svg = graphCanvas?.querySelector('svg');
    if(!svg) return;

    const isoOn = !!(iso && iso.checked);
    const q = (search?.value||'').trim();
    const seeds = headerIdsMatching(q);
    const hops = parseInt(hopSel?.value || '1', 10);

    // show minimap only in graph view
    if(mini) mini.hidden = false;

    // If no iso or no search, restore visibility
    if(!isoOn || seeds.size===0){
      svg.querySelectorAll('.heatNode, .heatEdge, .gEdgeLabels > g').forEach(el=>{
        el.style.display = '';
        el.style.opacity = '';
      });
      updateMiniMap(svg);
      return;
    }

    const edges = getFilteredEdgesFromMatrix();
    const adj = buildAdj(edges);
    const dist = bfs(adj, seeds, hops);
    const allowed = new Set(dist.keys());

    // prune nodes outside allowed
    svg.querySelectorAll('.heatNode').forEach(n=>{
      const id = n.dataset.id;
      if(id && !allowed.has(id)){
        n.style.display = 'none';
      }else{
        n.style.display = '';
      }
    });

    // prune edges outside allowed
    svg.querySelectorAll('.heatEdge').forEach(e=>{
      const a = e.dataset.from, b = e.dataset.to;
      if((a && !allowed.has(a)) || (b && !allowed.has(b))){
        e.style.display = 'none';
      }else{
        e.style.display = '';
      }
    });

    // prune edge labels group (gEdgeLabels > g)
    const labelGroups = Array.from(svg.querySelectorAll('.gEdgeLabels > g'));
    labelGroups.forEach(g=>{
      // labels correspond to edges in order (v18 appends in same order) but we can't rely on strict mapping.
      // We'll approximate: hide labels if near a hidden edge by checking nearest preceding sibling edge index if possible.
      // Safer: if label has no transform after draw, keep; else show, but fade if iso.
      g.style.display = '';
      g.style.opacity = '0.95';
    });

    updateMiniMap(svg);
  }

  function updateMiniMap(svg){
    if(!miniSvg) return;
    // Collect node positions from transforms "translate(x,y)"
    const nodes = [];
    svg.querySelectorAll('.heatNode').forEach(n=>{
      if(n.style.display === 'none') return;
      const tr = n.getAttribute('transform')||'';
      const m = /translate\(([-\d.]+),([-\d.]+)\)/.exec(tr);
      if(!m) return;
      nodes.push({id:n.dataset.id, x:parseFloat(m[1]), y:parseFloat(m[2]), pinned: n.classList.contains('isPinned')});
    });
    // if empty, clear
    if(nodes.length===0){
      miniSvg.innerHTML = '';
      return;
    }
    // normalize to 200x120
    let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
    nodes.forEach(p=>{ minX=Math.min(minX,p.x); maxX=Math.max(maxX,p.x); minY=Math.min(minY,p.y); maxY=Math.max(maxY,p.y); });
    const pad = 12;
    const w = Math.max(1, maxX-minX);
    const h = Math.max(1, maxY-minY);
    const sx = (200-2*pad)/w;
    const sy = (120-2*pad)/h;
    const s = Math.min(sx, sy);

    // edges: read visible edges and draw thin lines
    const edges = [];
    svg.querySelectorAll('.heatEdge').forEach(e=>{
      if(e.style.display === 'none') return;
      const a=e.dataset.from, b=e.dataset.to;
      if(!a||!b) return;
      edges.push({a,b});
    });
    const pos = new Map(nodes.map(n=>[n.id,n]));
    const lines = edges.map(e=>{
      const A=pos.get(e.a), B=pos.get(e.b);
      if(!A||!B) return null;
      return {x1:A.x, y1:A.y, x2:B.x, y2:B.y};
    }).filter(Boolean);

    // Render SVG
    const parts = [];
    parts.push(`<rect x="0" y="0" width="200" height="120" rx="12" ry="12" fill="transparent"/>`);
    lines.forEach(l=>{
      const x1 = pad + (l.x1-minX)*s, y1 = pad + (l.y1-minY)*s;
      const x2 = pad + (l.x2-minX)*s, y2 = pad + (l.y2-minY)*s;
      parts.push(`<line x1="${x1.toFixed(1)}" y1="${y1.toFixed(1)}" x2="${x2.toFixed(1)}" y2="${y2.toFixed(1)}" stroke="currentColor" stroke-opacity="0.18" stroke-width="1"/>`);
    });
    nodes.forEach(p=>{
      const x = pad + (p.x-minX)*s, y = pad + (p.y-minY)*s;
      const r = p.pinned ? 3.2 : 2.4;
      const op = p.pinned ? 0.70 : 0.48;
      parts.push(`<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="${r}" fill="currentColor" fill-opacity="${op}"/>`);
    });
    miniSvg.innerHTML = parts.join('');
  }

  // Presentation mode
  presentBtn?.addEventListener('click', async ()=>{
    const on = !document.body.classList.contains('isPresent');
    document.body.classList.toggle('isPresent', on);
    if(on){
      // try fullscreen
      try{
        await document.documentElement.requestFullscreen?.();
      }catch(e){}
      presentBtn.textContent = 'Exit';
      // ensure graph view for presentation if already in heatmap section
      if(getView()==='graph'){ setTimeout(()=>applyIsoGraph(), 120); }
    }else{
      try{
        await document.exitFullscreen?.();
      }catch(e){}
      presentBtn.textContent = 'Present';
    }
  });

  // Re-apply isolate after any likely re-render event
  const schedule = ()=> setTimeout(applyIsoGraph, 180);
  window.addEventListener('resize', schedule);

  viewBtns.forEach(b=> b.addEventListener('click', schedule));
  typeBtns.forEach(b=> b.addEventListener('click', schedule));
  range?.addEventListener('input', schedule);
  strongOnly?.addEventListener('change', schedule);
  search?.addEventListener('input', schedule);
  hopSel?.addEventListener('change', schedule);
  focusBtn?.addEventListener('click', schedule);
  iso?.addEventListener('change', schedule);

  // initial
  schedule();
}
window.addEventListener('load', initHeatmapV20);


// --- v21: interactive minimap (camera) + presenter steps ---
function initHeatmapV21(){
  if(window.__AF_HEAT_V21__) return;
  window.__AF_HEAT_V21__ = true;

  const root = document.querySelector('#heatmap');
  if(!root) return;

  const graphCanvas = root.querySelector('.heatGraphCanvas');
  const mini = root.querySelector('.heatMiniMap');
  const miniSvg = root.querySelector('.heatMiniMapSvg');
  const presentBtn = root.querySelector('.heatPresentBtn');

  const presenter = root.querySelector('.heatPresenter');
  const pTitle = presenter?.querySelector('.heatPresenterStepK');
  const pText = presenter?.querySelector('.heatPresenterStepV');
  const pList = presenter?.querySelector('.heatPresenterList');

  const viewBtns = Array.from(root.querySelectorAll('.heatViewBtn'));
  const typeBtns = Array.from(root.querySelectorAll('.heatTypeBtn'));
  const range = root.querySelector('.heatRangeInput');
  const strongOnly = root.querySelector('.heatCheckInput');
  const search = root.querySelector('.heatSearchInput');
  const focusBtn = root.querySelector('.heatFocusBtn');
  const hopSel = root.querySelector('.heatHopSelect');
  const iso = root.querySelector('.heatIsoInput');

  // camera state stored on window
  const cam = window.__AF_GRAPH_CAM__ = window.__AF_GRAPH_CAM__ || {x:0,y:0,w:0,h:0,zoom:1};

  function getView(){
    return viewBtns.find(b=>b.classList.contains('isOn'))?.dataset.view || 'matrix';
  }
  function setView(v){
    root.querySelector(`.heatViewBtn[data-view="${v}"]`)?.click();
  }

  // ---- camera helpers ----
  function getGraphSvg(){
    return graphCanvas?.querySelector('svg');
  }
  function getViewBox(svg){
    const vb = svg.viewBox.baseVal;
    return {x:vb.x, y:vb.y, w:vb.width, h:vb.height};
  }
  function setViewBox(svg, x,y,w,h){
    svg.setAttribute('viewBox', `${x} ${y} ${w} ${h}`);
  }
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  // Hook minimap meta from v20 updateMiniMap: we store it on root for click mapping.
  // If not present, we infer bounds from node positions.
  function inferMiniMeta(svg){
    const nodes = [];
    svg.querySelectorAll('.heatNode').forEach(n=>{
      if(n.style.display==='none') return;
      const tr = n.getAttribute('transform')||'';
      const m = /translate\(([-\d.]+),([-\d.]+)\)/.exec(tr);
      if(!m) return;
      nodes.push({x:parseFloat(m[1]), y:parseFloat(m[2])});
    });
    if(nodes.length===0) return null;
    let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity;
    nodes.forEach(p=>{minX=Math.min(minX,p.x);maxX=Math.max(maxX,p.x);minY=Math.min(minY,p.y);maxY=Math.max(maxY,p.y);});
    const w=Math.max(1,maxX-minX), h=Math.max(1,maxY-minY);
    return {minX,maxX,minY,maxY,w,h,pad:12, s: Math.min((200-24)/w, (120-24)/h)};
  }

  function centerCameraAt(graphX, graphY){
    const svg = getGraphSvg();
    if(!svg) return;
    const vb = getViewBox(svg);
    // keep width/height; just move center
    const nx = graphX - vb.w/2;
    const ny = graphY - vb.h/2;
    setViewBox(svg, nx, ny, vb.w, vb.h);
    cam.x = nx; cam.y = ny; cam.w = vb.w; cam.h = vb.h;
  }

  function resetCamera(){
    const svg = getGraphSvg();
    if(!svg) return;
    // reset to original size
    const rect = graphCanvas.getBoundingClientRect();
    const W = Math.max(760, Math.floor(rect.width));
    const H = Math.max(520, Math.floor(rect.height));
    setViewBox(svg, 0, 0, W, H);
    cam.x=0; cam.y=0; cam.w=W; cam.h=H; cam.zoom=1;
    showToast?.('Camera reset');
  }

  function zoomCamera(delta){
    const svg = getGraphSvg();
    if(!svg) return;
    const vb = getViewBox(svg);
    const factor = delta > 0 ? 1.10 : 0.90;
    const nw = vb.w * factor;
    const nh = vb.h * factor;
    // zoom to center
    const cx = vb.x + vb.w/2;
    const cy = vb.y + vb.h/2;
    setViewBox(svg, cx - nw/2, cy - nh/2, nw, nh);
    cam.x = cx - nw/2; cam.y = cy - nh/2; cam.w = nw; cam.h = nh;
  }

  // Click minimap -> center camera
  function onMiniClick(evt){
    const svg = getGraphSvg();
    if(!svg) return;
    const bbox = miniSvg.getBoundingClientRect();
    const x = evt.clientX - bbox.left;
    const y = evt.clientY - bbox.top;

    const meta = root.__AF_MINI_META__ || inferMiniMeta(svg);
    if(!meta) return;

    const gx = meta.minX + (x - meta.pad)/meta.s;
    const gy = meta.minY + (y - meta.pad)/meta.s;
    centerCameraAt(gx, gy);
  }
  miniSvg?.addEventListener('click', onMiniClick);
  // Wheel on minimap -> zoom
  miniSvg?.addEventListener('wheel', (evt)=>{
    evt.preventDefault();
    zoomCamera(evt.deltaY);
  }, {passive:false});

  // Also wheel on graph to zoom (presenters love it)
  graphCanvas?.addEventListener('wheel', (evt)=>{
    if(getView()!=='graph') return;
    evt.preventDefault();
    zoomCamera(evt.deltaY);
  }, {passive:false});

  // ---- Presenter steps ----
  const steps = [
    {
      key: "0. Big picture",
      text: "Срез игровой механики как система: модули + типы зависимостей (Data / Events / UX). Переключай Matrix/Graph, смотри узлы-центры.",
      st: {view:"graph", search:"", hops:"1", iso:false, min:"2", strong:false, focus:false, types:["data","events","ux"]}
    },
    {
      key: "1. Core Loop (Quests ↔ DB)",
      text: "Главная связка MVP: Quest Engine опирается на DB (World + User state), читает bundle и пишет прогресс/журнал.",
      st: {view:"matrix", search:"Quest", hops:"1", iso:true, min:"2", strong:false, focus:true, types:["data","events"]}
    },
    {
      key: "2. Quest → Badges",
      text: "Награды и достижения: Quest Engine генерирует события/результаты, Badge System пересчитывает правила и фиксирует unlock.",
      st: {view:"graph", search:"Badge", hops:"2", iso:true, min:"2", strong:false, focus:false, types:["events","data"]}
    },
    {
      key: "3. Discover вход в контент",
      text: "Discover/Locations Catalogue: точка входа, фильтры, переходы к локациям/квестам, экранные UX события.",
      st: {view:"matrix", search:"Discover", hops:"2", iso:true, min:"1", strong:false, focus:false, types:["ux","events","data"]}
    },
    {
      key: "4. Telemetry MVP-safe",
      text: "Телеметрия как безопасный слой: события экрана, флоу шаги, качество контента. Без PII, с idempotency.",
      st: {view:"graph", search:"Telemetry", hops:"2", iso:true, min:"1", strong:false, focus:false, types:["ux","events"]}
    },
    {
      key: "5. Event Bus склейка модулей",
      text: "Если оставить только Events — видно, где модульная склейка настоящая (а где просто общий storage).",
      st: {view:"graph", search:"", hops:"1", iso:false, min:"2", strong:false, focus:false, types:["events"]}
    },
    {
      key: "6. Data dependencies",
      text: "Режим Data: кто реально читает/пишет state, где нужно аккуратно с транзакциями и миграциями схемы.",
      st: {view:"matrix", search:"", hops:"1", iso:false, min:"2", strong:false, focus:false, types:["data"]}
    },
  ];

  let idx = 0;

  function applyStep(i){
    idx = ((i % steps.length) + steps.length) % steps.length;
    const s = steps[idx];
    if(pTitle) pTitle.textContent = s.key;
    if(pText) pText.textContent = s.text;

    // apply state
    const st = s.st;
    // types
    typeBtns.forEach(b=> b.classList.toggle('isOn', st.types.includes(b.dataset.type)));
    // min/strong
    if(range) range.value = st.min;
    if(strongOnly) strongOnly.checked = !!st.strong;
    // focus
    if(focusBtn){
      focusBtn.classList.toggle('isOn', !!st.focus);
      focusBtn.textContent = focusBtn.classList.contains('isOn') ? 'Focus: ON' : 'Focus: OFF';
    }
    // hops (segmented buttons in v19 will sync via select change)
    if(hopSel){ hopSel.value = st.hops; hopSel.dispatchEvent(new Event('change')); }
    // iso
    if(iso){ iso.checked = !!st.iso; iso.dispatchEvent(new Event('change')); }
    // search
    if(search){ search.value = st.search; search.dispatchEvent(new Event('input')); }
    // view
    setView(st.view);

    // camera reset when moving to a new step (gentle)
    setTimeout(()=>{
      if(getView()==='graph') resetCamera();
    }, 160);
  }

  function buildStepList(){
    if(!pList) return;
    pList.innerHTML = steps.map((s,i)=>`
      <div class="heatPresenterItem" data-i="${i}">
        <div class="heatPresenterItemN">${i+1}</div>
        <div class="heatPresenterItemBody">
          <div class="heatPresenterItemK">${s.key}</div>
          <div class="heatPresenterItemV">${s.text}</div>
        </div>
      </div>
    `).join('');
    pList.querySelectorAll('.heatPresenterItem').forEach(it=>{
      it.addEventListener('click', ()=>{
        applyStep(parseInt(it.dataset.i,10));
        pList.hidden = true;
      });
    });
  }
  buildStepList();

  function setPresenterVisible(on){
    if(!presenter) return;
    presenter.hidden = !on;
  }

  // Hook presenter buttons
  presenter?.addEventListener('click', (evt)=>{
    const btn = evt.target.closest('button');
    if(!btn) return;
    const cmd = btn.dataset.pcmd;
    if(cmd==='prev') applyStep(idx-1);
    if(cmd==='next') applyStep(idx+1);
    if(cmd==='resetCam') resetCamera();
    if(cmd==='toggleList'){
      if(pList) pList.hidden = !pList.hidden;
    }
  });

  // Keyboard shortcuts in present mode
  window.addEventListener('keydown', (evt)=>{
    if(!document.body.classList.contains('isPresent')) return;
    if(evt.key==='ArrowRight' || evt.key==='PageDown') applyStep(idx+1);
    if(evt.key==='ArrowLeft'  || evt.key==='PageUp') applyStep(idx-1);
    if(evt.key==='Escape'){
      // exit present via button behavior
      presentBtn?.click();
    }
  });

  // Present mode button toggles presenter visibility
  presentBtn?.addEventListener('click', ()=>{
    const on = document.body.classList.contains('isPresent'); // after toggle in v20 it already applied; but click triggers before, so defer
    setTimeout(()=>{
      const isOn = document.body.classList.contains('isPresent');
      setPresenterVisible(isOn);
      if(isOn){
        // start at step 0
        applyStep(0);
      }else{
        if(pList) pList.hidden = true;
      }
    }, 60);
  });

  // Show minimap only in graph
  function updateMiniVisibility(){
    if(!mini) return;
    mini.hidden = (getView()!=='graph');
  }
  viewBtns.forEach(b=> b.addEventListener('click', ()=> setTimeout(updateMiniVisibility, 80)));
  updateMiniVisibility();

  // Patch v20 minimap updater meta by wrapping root.__AF_MINI_META__ on every update
  // v20 doesn't expose meta, so we infer after each render
  function refreshMeta(){
    const svg = getGraphSvg();
    if(!svg) return;
    root.__AF_MINI_META__ = inferMiniMeta(svg);
  }
  window.addEventListener('resize', ()=> setTimeout(refreshMeta, 220));
  viewBtns.forEach(b=> b.addEventListener('click', ()=> setTimeout(refreshMeta, 240)));
  setTimeout(refreshMeta, 260);
}
window.addEventListener('load', initHeatmapV21);
</script>
</body>
</html>
